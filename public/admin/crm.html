<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Estratégico | Integral Computación</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Librerías Open Source Gratuitas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        tailwind.config = {
            theme: {
                fontFamily: { sans: ['Inter', 'sans-serif'] },
                extend: {
                    colors: {
                        primary: '#0F172A',
                        secondary: '#64748B',
                        accent: '#0ea5e9',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        background: '#F8FAFC',
                        surface: '#FFFFFF',
                        border: '#E2E8F0'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #F8FAFC;
            color: #0F172A;
        }

        .card {
            background: #FFFFFF;
            border: 1px solid #E2E8F0;
            border-radius: 16px;
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.03);
        }

        .card-hover:hover {
            border-color: #cbd5e1;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(16px);
        }

        .nav-item {
            transition: all 0.15s ease;
        }

        .nav-item:hover,
        .nav-item.active {
            background: #f1f5f9;
            color: #0F172A;
            font-weight: 600;
        }

        .nav-item.active i {
            color: #0ea5e9;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Kanban Customization */
        .kanban-col {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }

        .k-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: grab;
            transition: transform 0.1s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border-left-width: 4px;
        }

        .k-card:active {
            cursor: grabbing;
            transform: scale(0.98);
        }

        .k-ghost {
            opacity: 0.4;
            background: #e2e8f0;
        }

        /* Map */
        #map {
            height: 500px;
            border-radius: 16px;
            z-index: 10;
            border: 1px solid #e2e8f0;
        }

        /* Scrollbars */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
    </style>
</head>

<body class="flex h-screen overflow-hidden antialiased text-sm">

    <!-- SIDEBAR -->
    <aside class="w-64 border-r border-border bg-white flex flex-col justify-between hidden md:flex shrink-0 z-20">
        <div>
            <div class="h-16 flex items-center px-6 border-b border-border">
                <div
                    class="w-8 h-8 rounded-lg bg-primary text-white flex items-center justify-center font-bold mr-3 shadow-md">
                    IC</div>
                <div class="flex-1">
                    <h2 class="font-bold text-primary truncate leading-tight">Integral Comp.</h2>
                    <p class="text-[10px] text-secondary uppercase font-semibold">CRM Comercial</p>
                </div>
            </div>

            <nav class="p-4 space-y-1">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 px-3">Estratégico</p>
                <button onclick="switchTab('comando')"
                    class="nav-item tab-btn active w-full flex items-center px-3 py-2.5 rounded-xl text-secondary text-left"
                    data-target="comando">
                    <i class="fa-solid fa-chart-pie w-6"></i> Centro de Comando
                </button>
                <button onclick="switchTab('kanban')"
                    class="nav-item tab-btn w-full flex items-center px-3 py-2.5 rounded-xl text-secondary text-left"
                    data-target="kanban">
                    <i class="fa-solid fa-layer-group w-6"></i> Pipeline Kanban
                </button>
                <button onclick="switchTab('simulador')"
                    class="nav-item tab-btn w-full flex items-center px-3 py-2.5 rounded-xl text-secondary text-left"
                    data-target="simulador">
                    <i class="fa-solid fa-calculator w-6"></i> Simulador de Cierre
                </button>

                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 mt-6 px-3">Operativo</p>
                <button onclick="switchTab('mapa')"
                    class="nav-item tab-btn w-full flex items-center px-3 py-2.5 rounded-xl text-secondary justify-between text-left"
                    data-target="mapa">
                    <div class="flex items-center"><i class="fa-solid fa-map-location-dot w-6"></i> Mapa Territorial
                    </div>
                </button>
                <button onclick="switchTab('directorio')"
                    class="nav-item tab-btn w-full flex items-center px-3 py-2.5 rounded-xl text-secondary justify-between text-left"
                    data-target="directorio">
                    <div class="flex items-center"><i class="fa-solid fa-address-book w-6"></i> Directorio Clientes
                    </div>
                </button>
                <button onclick="switchTab('ventas')"
                    class="nav-item tab-btn w-full flex items-center px-3 py-2.5 rounded-xl text-secondary justify-between text-left"
                    data-target="ventas">
                    <div class="flex items-center"><i class="fa-solid fa-chart-line w-6"></i> Rendimiento Anual
                    </div>
                </button>

                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 mt-6 px-3">Retorno & Admin
                </p>
                <button onclick="switchTab('config')"
                    class="nav-item tab-btn w-full flex items-center px-3 py-2.5 rounded-xl text-secondary justify-between text-left"
                    data-target="config">
                    <div class="flex items-center"><i class="fa-solid fa-gear w-6"></i> Configuración</div>
                </button>
                <a href="/public/admin/home.html"
                    class="nav-item flex items-center px-3 py-2.5 rounded-xl text-slate-500 hover:text-danger hover:bg-red-50 transition">
                    <i class="fa-solid fa-arrow-left w-6"></i> Volver al Panel
                </a>
            </nav>
        </div>
    </aside>

    <!-- MAIN APP -->
    <main class="flex-1 flex flex-col h-full bg-slate-50 relative overflow-hidden">

        <!-- HEADER -->
        <header
            class="h-16 glass-panel border-b border-border flex items-center justify-between px-8 z-10 sticky top-0 shrink-0">
            <h1 class="text-xl font-bold tracking-tight text-primary" id="headerTitle">Centro de Comando</h1>
            <div class="flex items-center gap-4">
                <button onclick="openNewDealModal()"
                    class="bg-primary hover:bg-slate-800 text-white font-semibold py-2 px-5 rounded-full shadow-md transition-transform active:scale-95 flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i> Nuevo Trato
                </button>
                <button onclick="initCRM()" class="text-slate-400 hover:text-primary transition" title="Refrescar">
                    <i class="fa-solid fa-rotate-right"></i>
                </button>
            </div>
        </header>

        <!-- CONTENIDO DESPLAZABLE -->
        <div class="flex-1 overflow-y-auto p-6 md:p-8">
            <div class="max-w-7xl mx-auto">

                <!-- TAB 1: CENTRO DE COMANDO (HUD + RADAR) -->
                <div id="tab-comando" class="tab-pane active space-y-6">

                    <!-- 1. MÉTRICAS EJECUTIVAS + HEALTH SCORE -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="card p-5">
                            <p class="text-xs text-secondary font-medium mb-1">Ventas del Mes</p>
                            <h3 class="text-2xl font-bold text-primary mb-1" id="m_ventas">$0</h3>
                            <div
                                class="text-[10px] font-semibold text-success bg-green-50 px-2 py-0.5 rounded inline-block">
                                <i class="fa-solid fa-arrow-up"></i> Ingreso Real
                            </div>
                        </div>
                        <div class="card p-5 ring-1 ring-accent"
                            style="background: linear-gradient(180deg, #F0F9FF 0%, #FFFFFF 100%);">
                            <p class="text-xs text-accent font-bold mb-1">Forecast a 30 Días <i
                                    class="fa-solid fa-wand-magic-sparkles opacity-50 ml-1"></i></p>
                            <h3 class="text-2xl font-bold text-primary mb-1" id="m_forecast">$0</h3>
                            <div class="text-[10px] text-slate-500">Basado en pipeline x probabilildad</div>
                        </div>
                        <div class="card p-5">
                            <p class="text-xs text-secondary font-medium mb-1">Valor Total Pipeline</p>
                            <h3 class="text-2xl font-bold text-primary mb-1" id="m_pipeline">$0</h3>
                            <div class="text-[10px] text-slate-500"><span id="m_activos">0</span> tratos en juego</div>
                        </div>
                        <!-- HEALTH SCORE DESGLOSADO -->
                        <div class="card p-5 border-l-4 border-success relative group cursor-help">
                            <p class="text-xs text-secondary font-medium mb-1 flex justify-between">Health Score <i
                                    class="fa-solid fa-circle-info text-slate-300"></i></p>
                            <h3 class="text-2xl font-bold text-success mb-1" id="m_health">100/100</h3>
                            <div class="w-full bg-slate-100 h-1.5 rounded-full mt-2">
                                <div class="bg-success h-full rounded-full" style="width:100%" id="m_health_bar"></div>
                            </div>
                            <!-- Tooltip Desglose -->
                            <div
                                class="absolute right-0 top-full mt-2 w-64 bg-slate-800 text-white p-4 rounded-xl shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-50">
                                <h4 class="font-bold text-xs mb-2 border-b border-slate-600 pb-1">Desglose de Salud</h4>
                                <ul class="text-[10px] space-y-2">
                                    <li class="flex justify-between"><span>Tratos con seguimiento al día:</span> <span
                                            class="text-green-400 font-bold" id="h_al_dia">100%</span></li>
                                    <li class="flex justify-between"><span>Tratos estancados (+10d):</span> <span
                                            class="text-red-400 font-bold" id="h_estancados">0%</span></li>
                                    <li class="flex justify-between"><span>Pérdida por ghosting:</span> <span
                                            class="text-amber-400 font-bold" id="h_perdida">0%</span></li>
                                </ul>
                                <p class="text-[9px] mt-3 text-slate-400 leading-tight">Consejo: Para subir el score,
                                    contacta de inmediato a las alertas rojas del Radar Comercial.</p>
                            </div>
                        </div>
                    </div>

                    <!-- ROW 2: Progreso & Analítica -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

                        <!-- Columna Izquierda: Meta + Momentum -->
                        <div class="md:col-span-1 flex flex-col gap-6">
                            <!-- Objetivo Mensual -->
                            <div class="card p-6 flex flex-col justify-center">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="font-bold text-primary">Objetivo de Venta</h3>
                                    <i class="fa-solid fa-bullseye text-slate-300 text-xl"></i>
                                </div>

                                <div class="relative w-40 h-40 mx-auto mb-4">
                                    <canvas id="goalChart"></canvas>
                                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                                        <span class="text-2xl font-bold text-primary" id="goalPct">0%</span>
                                        <span
                                            class="text-[10px] text-slate-400 uppercase tracking-widest font-semibold mt-1">Alcanzado</span>
                                    </div>
                                </div>

                                <div class="text-center mt-2">
                                    <p class="text-secondary text-sm">Objetivo: <strong class="text-primary"
                                            id="goalTarget">$200,000</strong></p>
                                    <p class="text-xs text-slate-400 mt-2" id="goalRemaining"><i
                                            class="fa-regular fa-calendar"></i> Evaluando mes actual...</p>
                                </div>
                            </div>

                            <!-- Momentum Comercial -->
                            <div
                                class="card p-5 bg-gradient-to-br from-slate-800 to-primary text-white border-none shadow-lg relative overflow-hidden">
                                <i class="fa-solid fa-bolt absolute -right-4 -bottom-4 text-6xl opacity-10"></i>
                                <h3 class="font-bold text-sm text-slate-300 mb-4 flex items-center gap-2"><i
                                        class="fa-solid fa-fire text-orange-500"></i> Momentum Comercial</h3>
                                <div class="space-y-4">
                                    <div>
                                        <p class="text-[10px] text-slate-400 uppercase tracking-wider mb-1">Seguimientos
                                            7 días</p>
                                        <p class="text-2xl font-bold" id="mo_segs">0</p>
                                    </div>
                                    <div class="flex gap-4">
                                        <div class="flex-1">
                                            <p class="text-[10px] text-slate-400 uppercase tracking-wider mb-1">Tratos
                                                Movidos</p>
                                            <p class="text-lg font-bold text-accent" id="mo_moved">0</p>
                                        </div>
                                        <div class="flex-1">
                                            <p class="text-[10px] text-slate-400 uppercase tracking-wider mb-1">Avg
                                                Respuesta</p>
                                            <p class="text-lg font-bold text-success">&lt;24h</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Columna Derecha: Radar Predictivo -->
                        <div class="card p-0 md:col-span-2 overflow-hidden flex flex-col max-h-[600px]">
                            <div
                                class="px-6 py-5 border-b border-border bg-slate-50/50 flex justify-between items-center shrink-0">
                                <h3 class="font-bold text-primary flex items-center gap-2"><i
                                        class="fa-solid fa-radar text-accent animate-pulse"></i> Radar Comercial
                                    (Acciones Sugeridas)</h3>
                                <span class="badge badge-warning" id="radarCount">Alertas</span>
                            </div>

                            <div class="divide-y divide-border flex-1 overflow-y-auto" id="radarList">
                                <!-- Dynamic Radar Items -->
                                <div class="p-8 text-center text-slate-400">
                                    <i class="fa-solid fa-check-circle text-2xl mb-2 text-slate-300"></i><br>
                                    Radar limpio. Cero amenazas, cero oportunidades pendientes.
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- ROW 3: Pipeline Snapshot -->
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-sm font-bold text-slate-500 uppercase tracking-wider">Flujo Activo
                                (Snapshot)</h2>
                            <button onclick="switchTab('kanban')"
                                class="text-sm font-semibold text-accent hover:underline flex items-center gap-1 cursor-pointer">
                                Ver Tablero Completo <i class="fa-solid fa-arrow-right text-[10px]"></i>
                            </button>
                        </div>

                        <div class="card p-0 overflow-hidden flex divide-x divide-border" id="pipelineSnapshot">
                            <!-- Populated via JS -->
                            <div class="p-8 text-center w-full text-slate-400 text-sm">Cargando flujos clave...</div>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: PIPELINE KANBAN (INTELIGENTE) -->
                <div id="tab-kanban" class="tab-pane h-[calc(100vh-140px)]">
                    <div class="flex gap-4 h-full overflow-x-auto pb-4" id="kanbanBoard">
                        <!-- JS renders here -->
                    </div>
                </div>

                <!-- TAB 3: SIMULADOR DE CIERRE -->
                <div id="tab-simulador" class="tab-pane">
                    <div class="max-w-4xl mx-auto">
                        <div class="card p-0 overflow-hidden shadow-lg">
                            <div class="bg-gradient-to-r from-accent to-blue-600 p-6 text-white text-center">
                                <i class="fa-solid fa-calculator text-3xl mb-3 opacity-80"></i>
                                <h2 class="text-xl font-bold">Simulador de Escenarios de Cierre</h2>
                                <p class="text-sm text-blue-100 opacity-90 mt-1">Selecciona los prospectos que crees
                                    poder cerrar este mes para ver el impacto económico en tu meta antes de que suceda.
                                </p>
                            </div>

                            <div class="p-6 bg-slate-50 flex gap-6 border-b border-border">
                                <div class="flex-1 text-center">
                                    <p class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1">Ventas
                                        Actuales</p>
                                    <p class="text-2xl font-bold text-primary" id="sim_actual">$0</p>
                                </div>
                                <div class="flex items-center text-slate-300 justify-center"><i
                                        class="fa-solid fa-plus text-xl"></i></div>
                                <div class="flex-1 text-center">
                                    <p class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1">Simulado
                                        a Cerrar</p>
                                    <p class="text-2xl font-bold text-green-500" id="sim_proyectado">+$0</p>
                                </div>
                                <div class="flex items-center text-slate-300 justify-center"><i
                                        class="fa-solid fa-equals text-xl"></i></div>
                                <div class="flex-1 text-center">
                                    <p class="text-xs font-bold text-accent uppercase tracking-widest mb-1">Total
                                        Resultante</p>
                                    <p class="text-3xl font-bold text-accent" id="sim_total">$0</p>
                                    <div class="text-[10px] font-bold text-slate-400 mt-1">Meta: $200k</div>
                                </div>
                            </div>

                            <div class="p-6">
                                <h3 class="font-bold text-primary mb-4 text-sm"><i
                                        class="fa-solid fa-list-check opacity-50 mr-2"></i> Tratos en Negociación y
                                    Cotizados</h3>
                                <div class="space-y-2 max-h-96 overflow-y-auto" id="simBoxList">
                                    <!-- JS check list -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 4: MAPA TERRITORIAL (LEAFLET REAL) -->
                <div id="tab-mapa" class="tab-pane">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 h-[calc(100vh-140px)]">

                        <div class="md:col-span-3 card p-0 overflow-hidden relative">
                            <div id="map" class="w-full h-full border-none rounded-none"></div>
                            <!-- Map Overlay Widget -->
                            <div
                                class="absolute top-4 left-1/2 transform -translate-x-1/2 bg-white/90 backdrop-blur shadow-lg px-4 py-2 rounded-full border border-slate-200 z-[1000] flex gap-4 text-xs font-bold">
                                <label class="flex items-center gap-1 cursor-pointer hover:text-accent"><input
                                        type="radio" name="mfilter" value="all" checked onchange="renderMap()">
                                    Todos</label>
                                <label class="flex items-center gap-1 cursor-pointer hover:text-success"><input
                                        type="radio" name="mfilter" value="won" onchange="renderMap()"> Ganados</label>
                                <label class="flex items-center gap-1 cursor-pointer hover:text-warning"><input
                                        type="radio" name="mfilter" value="active" onchange="renderMap()"> En
                                    Juego</label>
                            </div>
                        </div>

                        <div class="card p-5 flex flex-col gap-4 overflow-y-auto">
                            <h3 class="font-bold text-primary text-sm mb-2 border-b border-border pb-2"><i
                                    class="fa-solid fa-chart-area mr-2 text-accent"></i> Resumen Territorial</h3>

                            <div class="bg-slate-50 border border-border p-3 rounded-lg">
                                <p class="text-[10px] text-slate-500 uppercase font-bold text-center">Zona Más Caliente
                                </p>
                                <p class="text-sm font-bold text-center text-primary mt-1" id="z_hot">Guadalajara Centro
                                </p>
                                <p class="text-xs text-center text-success font-semibold mt-1" id="z_hot_val">0 tratos
                                </p>
                            </div>

                            <div class="bg-red-50 border border-red-100 p-3 rounded-lg">
                                <p class="text-[10px] text-red-400 uppercase font-bold text-center">Zona con Pérdida</p>
                                <p class="text-sm font-bold text-center text-danger mt-1" id="z_cold">Zapopan Norte</p>
                                <p class="text-[10px] text-center text-red-500 mt-1" id="z_cold_val">Requiere atención
                                    urgente</p>
                            </div>

                            <div class="mt-4 flex-1">
                                <h4 class="text-xs font-bold text-slate-600 mb-3">Distribución de Cartera</h4>
                                <canvas id="zoneChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 5: DIRECTORIO DE CLIENTES -->
                <div id="tab-directorio" class="tab-pane">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-xl font-bold text-primary">Directorio de Clientes y Prospectos</h2>
                            <p class="text-sm text-secondary">Base de datos centralizada de empresas. Múltiples correos,
                                teléfonos y facturación.</p>
                        </div>
                        <button onclick="openClientModal()"
                            class="bg-primary hover:bg-slate-800 text-white font-semibold py-2 px-5 rounded-full shadow-md transition-transform active:scale-95 flex items-center gap-2">
                            <i class="fa-solid fa-user-plus"></i> Nuevo Cliente
                        </button>
                    </div>

                    <div class="relative mb-6 max-w-md">
                        <i
                            class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="dirSearchInput" onkeyup="filterDirectory()"
                            placeholder="Buscar por empresa, nombre, correo o teléfono..."
                            class="w-full pl-10 pr-4 py-3 bg-white border border-border rounded-xl text-sm focus:ring-2 focus:ring-accent outline-none shadow-sm transition-all text-primary">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="clientsGrid">
                        <!-- Clientes se inyectan acá vía JS -->
                        <div class="p-8 text-center w-full col-span-full text-slate-400">Cargando directorio...</div>
                    </div>
                </div>

                <!-- TAB 6: CONFIGURACIÓN -->
                <div id="tab-config" class="tab-pane">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-xl font-bold text-primary">Configuración del CRM</h2>
                            <p class="text-sm text-secondary">Administra parámetros globales como tus sucursales y
                                ubicaciones.</p>
                        </div>
                    </div>

                    <div class="card p-6 mb-6">
                        <div class="flex justify-between items-center mb-4 border-b border-border pb-3">
                            <h3 class="font-bold text-primary"><i class="fa-solid fa-building text-accent mr-2"></i>
                                Sucursales Propias</h3>
                            <button onclick="openBranchModal()"
                                class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-1.5 px-3 rounded-lg flex items-center gap-2 transition-colors">
                                <i class="fa-solid fa-plus"></i> Añadir Sucursal
                            </button>
                        </div>
                        <div id="branchesList" class="space-y-3">
                            <!-- JS Injection -->
                        </div>
                    </div>
                </div>

                <!-- TAB 7: RENDIMIENTO ANUAL -->
                <div id="tab-ventas" class="tab-pane">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-xl font-bold text-primary">Rendimiento Anual & Analítica</h2>
                            <p class="text-sm text-secondary">Dashboard analítico segmentado por vistas operativas.</p>
                        </div>
                        <label
                            class="bg-primary hover:bg-slate-800 text-white font-semibold py-2 px-5 rounded-full shadow-md transition-transform active:scale-95 flex items-center gap-2 cursor-pointer">
                            <i class="fa-solid fa-file-csv"></i> Importar CSV...
                            <input type="file" id="salesCsvInput" accept=".csv" class="hidden"
                                onchange="handleFileUpload(event)">
                        </label>
                    </div>

                    <!-- Píldoras de Navegación Interna -->
                    <div class="flex gap-2 mb-6 border-b border-border pb-2 overflow-x-auto">
                        <button onclick="switchVentasTab('ejecutiva')" id="btn-ventas-ejecutiva"
                            class="px-4 py-2 font-bold text-sm rounded-lg bg-primary text-white transition-colors flex items-center whitespace-nowrap"><i
                                class="fa-solid fa-chart-line mr-2"></i> Ejecutiva (Macro)</button>
                        <button onclick="switchVentasTab('clientes')" id="btn-ventas-clientes"
                            class="px-4 py-2 font-bold text-sm rounded-lg text-secondary hover:bg-slate-100 transition-colors flex items-center whitespace-nowrap"><i
                                class="fa-solid fa-users mr-2"></i> Vista Clientes</button>
                        <button onclick="switchVentasTab('simulador')" id="btn-ventas-simulador"
                            class="px-4 py-2 font-bold text-sm rounded-lg text-secondary hover:bg-slate-100 transition-colors flex items-center whitespace-nowrap"><i
                                class="fa-solid fa-triangle-exclamation mr-2"></i> Simulador de Riesgo</button>
                    </div>

                    <!-- SUB-TAB 1: EJECUTIVA -->
                    <div id="v-tab-ejecutiva" class="block">
                        <!-- Métricas Rápidas -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="card p-5">
                                <p class="text-xs text-secondary font-medium mb-1">Total Facturado</p>
                                <h3 class="text-2xl font-bold text-success mb-1" id="sv_total">$0.00</h3>
                            </div>
                            <div class="card p-5">
                                <p class="text-xs text-secondary font-medium mb-1">Ticket Promedio</p>
                                <h3 class="text-2xl font-bold text-accent mb-1" id="sv_ticket">$0.00</h3>
                            </div>
                            <div class="card p-5">
                                <p class="text-xs text-secondary font-medium mb-1">Total de Ventas</p>
                                <h3 class="text-2xl font-bold text-primary mb-1" id="sv_count">0</h3>
                            </div>
                            <div class="card p-5">
                                <p class="text-xs text-secondary font-medium mb-1">Cliente Principal</p>
                                <h3 class="text-lg font-bold text-primary mb-1 truncate" id="sv_top_client">-</h3>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Rendimiento Anual Línea -->
                            <div class="card p-6 flex flex-col">
                                <h4 class="font-bold text-primary mb-4 flex items-center"><i
                                        class="fa-solid fa-chart-area text-accent mr-2"></i> Rendimiento Mensual</h4>
                                <div class="relative w-full flex-1" style="min-height: 250px;">
                                    <canvas id="chartMonthlySales"></canvas>
                                </div>
                            </div>
                            <!-- Pareto Chart -->
                            <div class="card p-6 flex flex-col">
                                <h4 class="font-bold text-primary mb-4 flex items-center"><i
                                        class="fa-solid fa-chart-bar text-accent mr-2"></i> Ley de Pareto (80/20)</h4>
                                <p class="text-xs text-slate-400 mb-2">Acumulado de ingresos por principales clientes.
                                </p>
                                <div class="relative w-full flex-1" style="min-height: 250px;">
                                    <canvas id="chartPareto"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SUB-TAB 2: CLIENTES -->
                    <div id="v-tab-clientes" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <div class="relative w-full max-w-md">
                                <i
                                    class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                                <input type="text" id="salesSearchInput" onkeyup="filterSalesTable()"
                                    placeholder="Buscar por cliente o factura..."
                                    class="w-full pl-10 pr-4 py-2 bg-white border border-border rounded-xl text-sm focus:ring-2 focus:ring-accent outline-none shadow-sm transition-all text-primary">
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl shadow-sm border border-border overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-left border-collapse" id="salesTableObj">
                                    <thead>
                                        <tr
                                            class="bg-slate-50 border-b border-border text-xs uppercase tracking-wider text-slate-500 font-bold">
                                            <th class="p-4">Factura</th>
                                            <th class="p-4">Fecha</th>
                                            <th class="p-4">Cliente</th>
                                            <th class="p-4 text-right">Monto Pagado</th>
                                            <th class="p-4 text-center">Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody id="importedSalesList" class="divide-y divide-border text-sm">
                                        <tr>
                                            <td colspan="5" class="p-8 text-center text-slate-400">Cargando base de
                                                ventas...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- SUB-TAB 3: SIMULADOR DE RIESGO -->
                    <div id="v-tab-simulador" class="hidden">
                        <div class="card p-8 bg-slate-900 border-none shadow-2xl relative overflow-hidden">
                            <!-- Background accent -->
                            <div
                                class="absolute -top-10 -right-10 w-64 h-64 bg-danger/20 rounded-full blur-3xl point-events-none">
                            </div>

                            <h3 class="text-2xl font-bold mb-2 flex items-center gap-2 text-white">
                                <i class="fa-solid fa-triangle-exclamation text-red-500"></i> Análisis de Riesgo
                                Operativo
                            </h3>
                            <p class="text-slate-400 text-sm mb-8 max-w-2xl leading-relaxed">¿Qué pasaría si pierdes a
                                un cliente clave mañana? Selecciona a un cliente de tu portafolio para comprender el
                                impacto en tus ingresos totales y prepararte con anticipación.</p>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center relative z-10">
                                <div class="space-y-4">
                                    <label
                                        class="block text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2"><i
                                            class="fa-solid fa-user-minus"></i> Desconectar Cliente Específico</label>
                                    <select id="simRiesgoClient" onchange="calcRiskSimulator()"
                                        class="w-full bg-slate-800 border-2 border-slate-700 rounded-xl px-4 py-3.5 text-sm focus:border-red-500 outline-none text-white transition-all shadow-inner font-semibold cursor-pointer">
                                        <option value="">-- Selecciona un cliente del histórico --</option>
                                    </select>
                                </div>

                                <div
                                    class="bg-black/40 backdrop-blur-md p-8 rounded-2xl border border-slate-700/50 flex flex-col items-center justify-center text-center shadow-inner">
                                    <p class="text-xs text-slate-400 uppercase font-black tracking-widest mb-2">Impacto
                                        Financiero Anual</p>
                                    <div class="text-6xl font-black text-white mb-2 tracking-tighter"
                                        id="simRiskPercent">0%</div>
                                    <p class="text-red-400 text-sm font-semibold flex items-center gap-1"
                                        id="simRiskLoss"><i class="fa-solid fa-arrow-trend-down"></i> Caída de $0.00</p>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

            </div>
        </div>
    </main>

    <!-- Modal Formulario Cliente -->
    <div id="clientModal"
        class="fixed inset-0 bg-primary/40 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl max-h-[95vh] flex flex-col overflow-hidden transform transition-all scale-95 opacity-0"
            id="clientModalContent">
            <div class="px-6 py-4 border-b border-border flex justify-between items-center bg-slate-50/50">
                <h3 class="text-lg font-bold text-primary flex items-center gap-2" id="clientModalTitle"><i
                        class="fa-solid fa-address-book text-accent"></i> Nuevo Cliente</h3>
                <button onclick="closeClientModal()" class="text-slate-400 hover:text-danger p-2"><i
                        class="fa-solid fa-xmark text-xl"></i></button>
            </div>

            <div class="p-6 overflow-y-auto flex-1 bg-white">
                <form id="clientForm" class="space-y-6">
                    <input type="hidden" id="cId">

                    <div class="grid grid-cols-2 gap-5">
                        <div class="space-y-1">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wide">Empresa /
                                Razón Social <span class="text-danger">*</span></label>
                            <input type="text" id="cCompany" required
                                class="w-full border border-border rounded-xl px-4 py-2.5 text-sm focus:border-accent focus:ring-1 focus:ring-accent outline-none bg-slate-50/50 focus:bg-white text-primary font-medium transition-all">
                        </div>
                        <div class="space-y-1">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wide">Contacto
                                Principal</label>
                            <input type="text" id="cName"
                                class="w-full border border-border rounded-xl px-4 py-2.5 text-sm focus:border-accent focus:ring-1 focus:ring-accent outline-none bg-slate-50/50 focus:bg-white text-primary transition-all">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-5">
                        <div class="bg-blue-50/30 p-5 border border-blue-100/50 rounded-2xl relative">
                            <h4
                                class="text-xs font-bold text-accent uppercase tracking-wide flex items-center gap-1 mb-3">
                                <i class="fa-regular fa-envelope"></i> Correos
                            </h4>
                            <div class="space-y-3">
                                <input type="email" id="cEmail" placeholder="Correo principal"
                                    class="w-full border border-blue-200/50 rounded-xl px-4 py-2.5 text-sm focus:border-accent outline-none bg-white text-primary">
                                <textarea id="cOtherEmails"
                                    placeholder="Correos secundarios (Ej: admin@..., ventas@...)" rows="2"
                                    class="w-full border border-blue-200/50 rounded-xl px-4 py-2.5 text-xs focus:border-accent outline-none bg-white text-primary"></textarea>
                            </div>
                        </div>

                        <div class="bg-green-50/30 p-5 border border-green-100/50 rounded-2xl relative">
                            <h4
                                class="text-xs font-bold text-success uppercase tracking-wide flex items-center gap-1 mb-3">
                                <i class="fa-brands fa-whatsapp"></i> Teléfonos
                            </h4>
                            <div class="space-y-3">
                                <input type="text" id="cPhone" placeholder="Móvil / WhatsApp Principal"
                                    class="w-full border border-green-200/50 rounded-xl px-4 py-2.5 text-sm focus:border-success outline-none bg-white text-primary">
                                <textarea id="cOtherPhones" placeholder="Otros teléfonos (Oficina, ext. 102...)"
                                    rows="2"
                                    class="w-full border border-green-200/50 rounded-xl px-4 py-2.5 text-xs focus:border-success outline-none bg-white text-primary"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="bg-slate-50/50 p-5 border border-border rounded-2xl space-y-4">
                        <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wide flex items-center gap-1"><i
                                class="fa-solid fa-file-invoice"></i> Administrativo & Operativo</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="space-y-2">
                                <label class="block text-[10px] font-bold text-slate-400 uppercase">Dirección Matriz /
                                    Entrega</label>
                                <textarea id="cAddress" rows="3" placeholder="Calle, Número, Colonia, Ciudad, CP."
                                    class="w-full border border-border rounded-xl px-4 py-2.5 text-sm focus:border-accent outline-none bg-white text-primary"></textarea>
                                <button type="button" onclick="geocodeAddress()"
                                    class="w-full bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold px-3 py-2 rounded-lg text-xs transition-colors flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-location-crosshairs"></i> Ubicarlos en el Mapa (Automático)
                                </button>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-[10px] font-bold text-slate-400 uppercase">Datos de
                                    Facturación</label>
                                <textarea id="cBilling" rows="3" placeholder="RFC, Régimen, Uso de CFDI..."
                                    class="w-full border border-border rounded-xl px-4 py-2.5 text-[11px] font-mono focus:border-accent outline-none bg-white text-primary"></textarea>

                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" step="any" id="cLat" placeholder="Latitud"
                                        class="w-full border border-border rounded-lg px-2 py-2 text-xs focus:border-accent outline-none bg-white text-primary">
                                    <input type="number" step="any" id="cLng" placeholder="Longitud"
                                        class="w-full border border-border rounded-lg px-2 py-2 text-xs focus:border-accent outline-none bg-white text-primary">
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="px-6 py-4 border-t border-border bg-slate-50/50 flex justify-end items-center gap-3 shrink-0">
                <button onclick="closeClientModal()"
                    class="px-4 py-2 text-sm font-bold text-slate-400 hover:text-primary transition-colors">Cancelar</button>
                <button onclick="saveClient()"
                    class="px-6 py-2.5 text-sm font-bold text-white bg-primary hover:bg-slate-800 rounded-xl shadow-md transition-transform active:scale-95 flex items-center gap-2">
                    <i class="fa-solid fa-save"></i> Guardar Cliente
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Formulario Sucursal -->
    <div id="branchModal"
        class="fixed inset-0 bg-primary/40 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md flex flex-col overflow-hidden transform transition-all scale-95 opacity-0"
            id="branchModalContent">
            <div class="px-6 py-4 border-b border-border flex justify-between items-center bg-slate-50/50">
                <h3 class="text-lg font-bold text-primary flex items-center gap-2" id="branchModalTitle">Nueva Sucursal
                </h3>
                <button onclick="closeBranchModal()" class="text-slate-400 hover:text-danger p-2"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-4 bg-white">
                <input type="hidden" id="bId">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nombre Mostrar</label>
                    <input type="text" id="bName" placeholder="Ej. Matriz GDL"
                        class="w-full border border-border rounded-xl px-4 py-2 text-sm focus:border-accent outline-none bg-slate-50 focus:bg-white text-primary">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Dirección / Referencia</label>
                    <input type="text" id="bDesc" placeholder="Calle, Número, Ref"
                        class="w-full border border-border rounded-xl px-4 py-2 text-sm focus:border-accent outline-none bg-slate-50 focus:bg-white text-primary">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Latitud</label>
                        <input type="number" step="any" id="bLat"
                            class="w-full border border-border rounded-xl px-4 py-2 text-sm focus:border-accent outline-none bg-white text-primary">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Longitud</label>
                        <input type="number" step="any" id="bLng"
                            class="w-full border border-border rounded-xl px-4 py-2 text-sm focus:border-accent outline-none bg-white text-primary">
                    </div>
                </div>
                <button type="button" onclick="geocodeBranch()"
                    class="w-full bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold px-4 py-2.5 rounded-xl text-xs transition-colors flex items-center justify-center gap-2 mt-2">
                    <i class="fa-solid fa-location-crosshairs"></i> Ubicarlos en el Mapa (Automático)
                </button>
            </div>
            <div class="px-6 py-4 border-t border-border bg-slate-50/50 flex justify-end gap-3 z-10 shrink-0">
                <button onclick="closeBranchModal()"
                    class="px-4 py-2 text-sm font-bold text-slate-400 hover:text-primary transition-colors">Cancelar</button>
                <button onclick="saveBranch()"
                    class="px-5 py-2.5 text-sm font-bold text-white bg-primary hover:bg-slate-800 rounded-xl shadow-md transition-transform active:scale-95 flex items-center gap-2">
                    <i class="fa-solid fa-save"></i> Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- App Logic Injection -->
    <script>
        const TOKEN_KEY = 'admin_token';
        let adminToken = localStorage.getItem(TOKEN_KEY) || sessionStorage.getItem('admin-token');
        const META_MENSUAL = 200000; // Parametrizable
    </script>
    <script src="/public/assets/js/app-config.js"></script>
    <script src="/assets/js/crm.js"></script>

</body>

</html>