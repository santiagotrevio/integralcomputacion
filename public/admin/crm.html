<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Estratégico | Integral Computación</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Librerías Open Source Gratuitas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        tailwind.config = {
            theme: {
                fontFamily: { sans: ['Inter', 'sans-serif'] },
                extend: {
                    colors: {
                        primary: '#0F172A',
                        secondary: '#64748B',
                        accent: '#0ea5e9',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        background: '#F8FAFC',
                        surface: '#FFFFFF',
                        border: '#E2E8F0'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #F8FAFC;
            color: #0F172A;
        }

        .card {
            background: #FFFFFF;
            border: 1px solid #E2E8F0;
            border-radius: 16px;
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.03);
        }

        .card-hover:hover {
            border-color: #cbd5e1;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(16px);
        }

        .nav-item {
            transition: all 0.15s ease;
        }

        .nav-item:hover,
        .nav-item.active {
            background: #f1f5f9;
            color: #0F172A;
            font-weight: 600;
        }

        .nav-item.active i {
            color: #0ea5e9;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Kanban Customization */
        .kanban-col {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }

        .k-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: grab;
            transition: transform 0.1s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border-left-width: 4px;
        }

        .k-card:active {
            cursor: grabbing;
            transform: scale(0.98);
        }

        .k-ghost {
            opacity: 0.4;
            background: #e2e8f0;
        }

        /* Map */
        #map {
            height: 500px;
            border-radius: 16px;
            z-index: 10;
            border: 1px solid #e2e8f0;
        }

        /* Scrollbars */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
    </style>
</head>

<body class="flex h-screen overflow-hidden antialiased text-sm">

    <!-- SIDEBAR -->
    <aside class="w-64 border-r border-border bg-white flex flex-col justify-between hidden md:flex shrink-0 z-20">
        <div>
            <div class="h-16 flex items-center px-6 border-b border-border">
                <div
                    class="w-8 h-8 rounded-lg bg-primary text-white flex items-center justify-center font-bold mr-3 shadow-md">
                    IC</div>
                <div class="flex-1">
                    <h2 class="font-bold text-primary truncate leading-tight">Integral Comp.</h2>
                    <p class="text-[10px] text-secondary uppercase font-semibold">CRM Comercial</p>
                </div>
            </div>

            <nav class="p-4 space-y-1">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 px-3">Estratégico</p>
                <button onclick="switchTab('comando')"
                    class="nav-item tab-btn active w-full flex items-center px-3 py-2.5 rounded-xl text-secondary text-left"
                    data-target="comando">
                    <i class="fa-solid fa-chart-pie w-6"></i> Centro de Comando
                </button>
                <button onclick="switchTab('kanban')"
                    class="nav-item tab-btn w-full flex items-center px-3 py-2.5 rounded-xl text-secondary text-left"
                    data-target="kanban">
                    <i class="fa-solid fa-layer-group w-6"></i> Pipeline Kanban
                </button>
                <button onclick="switchTab('simulador')"
                    class="nav-item tab-btn w-full flex items-center px-3 py-2.5 rounded-xl text-secondary text-left"
                    data-target="simulador">
                    <i class="fa-solid fa-calculator w-6"></i> Simulador de Cierre
                </button>

                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 mt-6 px-3">Operativo</p>
                <button onclick="switchTab('mapa')"
                    class="nav-item tab-btn w-full flex items-center px-3 py-2.5 rounded-xl text-secondary justify-between text-left"
                    data-target="mapa">
                    <div class="flex items-center"><i class="fa-solid fa-map-location-dot w-6"></i> Mapa Territorial
                    </div>
                </button>

                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 mt-6 px-3">Retorno & Admin
                </p>
                <a href="/public/admin/home.html"
                    class="nav-item flex items-center px-3 py-2.5 rounded-xl text-slate-500 hover:text-danger hover:bg-red-50 transition">
                    <i class="fa-solid fa-arrow-left w-6"></i> Volver al Panel
                </a>
            </nav>
        </div>
    </aside>

    <!-- MAIN APP -->
    <main class="flex-1 flex flex-col h-full bg-slate-50 relative overflow-hidden">

        <!-- HEADER -->
        <header
            class="h-16 glass-panel border-b border-border flex items-center justify-between px-8 z-10 sticky top-0 shrink-0">
            <h1 class="text-xl font-bold tracking-tight text-primary" id="headerTitle">Centro de Comando</h1>
            <div class="flex items-center gap-4">
                <button onclick="openNewDealModal()"
                    class="bg-primary hover:bg-slate-800 text-white font-semibold py-2 px-5 rounded-full shadow-md transition-transform active:scale-95 flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i> Nuevo Trato
                </button>
                <button onclick="initCRM()" class="text-slate-400 hover:text-primary transition" title="Refrescar">
                    <i class="fa-solid fa-rotate-right"></i>
                </button>
            </div>
        </header>

        <!-- CONTENIDO DESPLAZABLE -->
        <div class="flex-1 overflow-y-auto p-6 md:p-8">
            <div class="max-w-7xl mx-auto">

                <!-- TAB 1: CENTRO DE COMANDO (HUD + RADAR) -->
                <div id="tab-comando" class="tab-pane active space-y-6">

                    <!-- 1. MÉTRICAS EJECUTIVAS + HEALTH SCORE -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="card p-5">
                            <p class="text-xs text-secondary font-medium mb-1">Ventas del Mes</p>
                            <h3 class="text-2xl font-bold text-primary mb-1" id="m_ventas">$0</h3>
                            <div
                                class="text-[10px] font-semibold text-success bg-green-50 px-2 py-0.5 rounded inline-block">
                                <i class="fa-solid fa-arrow-up"></i> Ingreso Real</div>
                        </div>
                        <div class="card p-5 ring-1 ring-accent"
                            style="background: linear-gradient(180deg, #F0F9FF 0%, #FFFFFF 100%);">
                            <p class="text-xs text-accent font-bold mb-1">Forecast a 30 Días <i
                                    class="fa-solid fa-wand-magic-sparkles opacity-50 ml-1"></i></p>
                            <h3 class="text-2xl font-bold text-primary mb-1" id="m_forecast">$0</h3>
                            <div class="text-[10px] text-slate-500">Basado en pipeline x probabilildad</div>
                        </div>
                        <div class="card p-5">
                            <p class="text-xs text-secondary font-medium mb-1">Valor Total Pipeline</p>
                            <h3 class="text-2xl font-bold text-primary mb-1" id="m_pipeline">$0</h3>
                            <div class="text-[10px] text-slate-500"><span id="m_activos">0</span> tratos en juego</div>
                        </div>
                        <!-- HEALTH SCORE DESGLOSADO -->
                        <div class="card p-5 border-l-4 border-success relative group cursor-help">
                            <p class="text-xs text-secondary font-medium mb-1 flex justify-between">Health Score <i
                                    class="fa-solid fa-circle-info text-slate-300"></i></p>
                            <h3 class="text-2xl font-bold text-success mb-1" id="m_health">100/100</h3>
                            <div class="w-full bg-slate-100 h-1.5 rounded-full mt-2">
                                <div class="bg-success h-full rounded-full" style="width:100%" id="m_health_bar"></div>
                            </div>
                            <!-- Tooltip Desglose -->
                            <div
                                class="absolute right-0 top-full mt-2 w-64 bg-slate-800 text-white p-4 rounded-xl shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-50">
                                <h4 class="font-bold text-xs mb-2 border-b border-slate-600 pb-1">Desglose de Salud</h4>
                                <ul class="text-[10px] space-y-2">
                                    <li class="flex justify-between"><span>Tratos con seguimiento al día:</span> <span
                                            class="text-green-400 font-bold" id="h_al_dia">100%</span></li>
                                    <li class="flex justify-between"><span>Tratos estancados (+10d):</span> <span
                                            class="text-red-400 font-bold" id="h_estancados">0%</span></li>
                                    <li class="flex justify-between"><span>Pérdida por ghosting:</span> <span
                                            class="text-amber-400 font-bold" id="h_perdida">0%</span></li>
                                </ul>
                                <p class="text-[9px] mt-3 text-slate-400 leading-tight">Consejo: Para subir el score,
                                    contacta de inmediato a las alertas rojas del Radar Comercial.</p>
                            </div>
                        </div>
                    </div>

                    <!-- 2. RADAR COMERCIAL (IMPACTO FINANCIERO & RECOMPRA) & MOMENTUM -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                        <!-- Columna Radar -->
                        <div class="lg:col-span-2 flex flex-col gap-6">
                            <div class="card flex-1 flex flex-col overflow-hidden">
                                <div
                                    class="px-5 py-4 border-b border-border bg-slate-50 flex justify-between items-center">
                                    <h3 class="font-bold text-primary flex items-center gap-2"><i
                                            class="fa-solid fa-radar text-accent animate-pulse"></i> Radar Comercial
                                        Inteligente</h3>
                                    <span
                                        class="bg-amber-100 text-amber-700 text-[10px] font-bold px-2 py-0.5 rounded-full"
                                        id="radarCount">Alertas</span>
                                </div>
                                <div class="divide-y divide-border flex-1 overflow-y-auto max-h-96" id="radarList">
                                    <!-- Dynamic Radar Items -->
                                    <div class="p-8 text-center text-slate-400"><i
                                            class="fa-solid fa-check-circle text-2xl mb-2 text-slate-300"></i><br>Radar
                                        limpio. Cero amenazas, cero oportunidades pendientes.</div>
                                </div>
                            </div>
                        </div>

                        <!-- Columna Momentum & Meta -->
                        <div class="flex flex-col gap-6">
                            <!-- Momentum Comercial -->
                            <div
                                class="card p-5 bg-gradient-to-br from-slate-800 to-primary text-white border-none shadow-lg relative overflow-hidden">
                                <i class="fa-solid fa-bolt absolute -right-4 -bottom-4 text-6xl opacity-10"></i>
                                <h3 class="font-bold text-sm text-slate-300 mb-4 flex items-center gap-2"><i
                                        class="fa-solid fa-fire text-orange-500"></i> Momentum Comercial</h3>
                                <div class="space-y-4">
                                    <div>
                                        <p class="text-[10px] text-slate-400 uppercase tracking-wider mb-1">Seguimientos
                                            7 días</p>
                                        <p class="text-2xl font-bold" id="mo_segs">0</p>
                                    </div>
                                    <div class="flex gap-4">
                                        <div class="flex-1">
                                            <p class="text-[10px] text-slate-400 uppercase tracking-wider mb-1">Tratos
                                                Movidos</p>
                                            <p class="text-lg font-bold text-accent" id="mo_moved">0</p>
                                        </div>
                                        <div class="flex-1">
                                            <p class="text-[10px] text-slate-400 uppercase tracking-wider mb-1">Avg
                                                Respuesta</p>
                                            <p class="text-lg font-bold text-success">&lt;24h</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Meta Mensual Simplificada -->
                            <div class="card p-5 text-center flex-1 flex flex-col justify-center">
                                <h3 class="font-bold text-primary mb-4 text-sm">Progreso de Meta Mensual</h3>
                                <div class="relative w-32 h-32 mx-auto mb-2">
                                    <canvas id="goalChart"></canvas>
                                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                                        <span class="text-xl font-bold text-primary" id="goalPct">0%</span>
                                    </div>
                                </div>
                                <p class="text-xs text-secondary">Objetivo: <strong id="goalTarget">$200,000</strong>
                                </p>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- TAB 2: PIPELINE KANBAN (INTELIGENTE) -->
                <div id="tab-kanban" class="tab-pane h-[calc(100vh-140px)]">
                    <div class="flex gap-4 h-full overflow-x-auto pb-4" id="kanbanBoard">
                        <!-- JS renders here -->
                    </div>
                </div>

                <!-- TAB 3: SIMULADOR DE CIERRE -->
                <div id="tab-simulador" class="tab-pane">
                    <div class="max-w-4xl mx-auto">
                        <div class="card p-0 overflow-hidden shadow-lg">
                            <div class="bg-gradient-to-r from-accent to-blue-600 p-6 text-white text-center">
                                <i class="fa-solid fa-calculator text-3xl mb-3 opacity-80"></i>
                                <h2 class="text-xl font-bold">Simulador de Escenarios de Cierre</h2>
                                <p class="text-sm text-blue-100 opacity-90 mt-1">Selecciona los prospectos que crees
                                    poder cerrar este mes para ver el impacto económico en tu meta antes de que suceda.
                                </p>
                            </div>

                            <div class="p-6 bg-slate-50 flex gap-6 border-b border-border">
                                <div class="flex-1 text-center">
                                    <p class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1">Ventas
                                        Actuales</p>
                                    <p class="text-2xl font-bold text-primary" id="sim_actual">$0</p>
                                </div>
                                <div class="flex items-center text-slate-300 justify-center"><i
                                        class="fa-solid fa-plus text-xl"></i></div>
                                <div class="flex-1 text-center">
                                    <p class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1">Simulado
                                        a Cerrar</p>
                                    <p class="text-2xl font-bold text-green-500" id="sim_proyectado">+$0</p>
                                </div>
                                <div class="flex items-center text-slate-300 justify-center"><i
                                        class="fa-solid fa-equals text-xl"></i></div>
                                <div class="flex-1 text-center">
                                    <p class="text-xs font-bold text-accent uppercase tracking-widest mb-1">Total
                                        Resultante</p>
                                    <p class="text-3xl font-bold text-accent" id="sim_total">$0</p>
                                    <div class="text-[10px] font-bold text-slate-400 mt-1">Meta: $200k</div>
                                </div>
                            </div>

                            <div class="p-6">
                                <h3 class="font-bold text-primary mb-4 text-sm"><i
                                        class="fa-solid fa-list-check opacity-50 mr-2"></i> Tratos en Negociación y
                                    Cotizados</h3>
                                <div class="space-y-2 max-h-96 overflow-y-auto" id="simBoxList">
                                    <!-- JS check list -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 4: MAPA TERRITORIAL (LEAFLET REAL) -->
                <div id="tab-mapa" class="tab-pane">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 h-[calc(100vh-140px)]">

                        <div class="md:col-span-3 card p-0 overflow-hidden relative">
                            <div id="map" class="w-full h-full border-none rounded-none"></div>
                            <!-- Map Overlay Widget -->
                            <div
                                class="absolute top-4 left-1/2 transform -translate-x-1/2 bg-white/90 backdrop-blur shadow-lg px-4 py-2 rounded-full border border-slate-200 z-[1000] flex gap-4 text-xs font-bold">
                                <label class="flex items-center gap-1 cursor-pointer hover:text-accent"><input
                                        type="radio" name="mfilter" value="all" checked onchange="renderMap()">
                                    Todos</label>
                                <label class="flex items-center gap-1 cursor-pointer hover:text-success"><input
                                        type="radio" name="mfilter" value="won" onchange="renderMap()"> Ganados</label>
                                <label class="flex items-center gap-1 cursor-pointer hover:text-warning"><input
                                        type="radio" name="mfilter" value="active" onchange="renderMap()"> En
                                    Juego</label>
                            </div>
                        </div>

                        <div class="card p-5 flex flex-col gap-4 overflow-y-auto">
                            <h3 class="font-bold text-primary text-sm mb-2 border-b border-border pb-2"><i
                                    class="fa-solid fa-chart-area mr-2 text-accent"></i> Resumen Territorial</h3>

                            <div class="bg-slate-50 border border-border p-3 rounded-lg">
                                <p class="text-[10px] text-slate-500 uppercase font-bold text-center">Zona Más Caliente
                                </p>
                                <p class="text-sm font-bold text-center text-primary mt-1" id="z_hot">Guadalajara Centro
                                </p>
                                <p class="text-xs text-center text-success font-semibold mt-1" id="z_hot_val">0 tratos
                                </p>
                            </div>

                            <div class="bg-red-50 border border-red-100 p-3 rounded-lg">
                                <p class="text-[10px] text-red-400 uppercase font-bold text-center">Zona con Pérdida</p>
                                <p class="text-sm font-bold text-center text-danger mt-1" id="z_cold">Zapopan Norte</p>
                                <p class="text-[10px] text-center text-red-500 mt-1" id="z_cold_val">Requiere atención
                                    urgente</p>
                            </div>

                            <div class="mt-4 flex-1">
                                <h4 class="text-xs font-bold text-slate-600 mb-3">Distribución de Cartera</h4>
                                <canvas id="zoneChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- App Logic Injection -->
    <script>
        const TOKEN_KEY = 'admin_token';
        let adminToken = localStorage.getItem(TOKEN_KEY) || sessionStorage.getItem('admin-token');
        const META_MENSUAL = 200000; // Parametrizable
    </script>
    <script src="/assets/js/crm.js"></script>

</body>

</html>