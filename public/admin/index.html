<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Cat√°logo Pro | Integral</title>
    <style>
        :root {
            --apple-bg: #f5f5f7;
            --apple-card: rgba(255, 255, 255, 0.8);
            --apple-text: #1d1d1f;
            --apple-subtext: #86868b;
            --apple-blue: #0071e3;
            --apple-red: #ff3b30;
            --apple-green: #34c759;
            --apple-border: rgba(0, 0, 0, 0.08);
            --glass-blur: blur(25px) saturate(180%);
            --modal-bg: #ffffff;
            --input-bg: #ffffff;
            --card-shadow: 0 12px 40px rgba(0, 0, 0, 0.04);
        }

        [data-theme="dark"] {
            --apple-bg: #000000;
            --apple-card: rgba(28, 28, 30, 0.7);
            --apple-text: #f5f5f7;
            --apple-subtext: #a1a1a6;
            --apple-blue: #0A84FF;
            --apple-red: #ff453a;
            --apple-green: #32d74b;
            --apple-border: rgba(255, 255, 255, 0.15);
            --modal-bg: #1c1c1e;
            --input-bg: #2c2c2e;
            --card-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        [data-theme="fallout"] {
            --apple-bg: #030a03;
            --apple-card: rgba(0, 20, 0, 0.85);
            --apple-text: #18ff62;
            --apple-subtext: #0b9e3b;
            --apple-blue: #18ff62;
            --apple-red: #ff3b30;
            --apple-green: #18ff62;
            --apple-border: rgba(24, 255, 98, 0.2);
            --glass-blur: blur(8px) saturate(120%);
            --modal-bg: #030a03;
            --input-bg: #001100;
            --card-shadow: 0 0 20px rgba(24, 255, 98, 0.2);
            --brand-bg: rgba(0, 20, 0, 0.9);
            --brand-border: rgba(24, 255, 98, 0.3);
        }

        [data-theme="fallout"] body,
        [data-theme="fallout"] *:not(.fa):not(.fas):not(.far):not(.fab):not(.fa-solid):not(.fa-regular):not(.fa-thin):not(.fa-duotone):not(i) {
            font-family: 'Courier New', Courier, monospace !important;
            text-shadow: 0 0 8px rgba(24, 255, 98, 0.8);
        }

        [data-theme="fallout"] .container {
            border: 2px solid var(--apple-blue);
            box-shadow: 0 0 30px rgba(24, 255, 98, 0.15);
        }

        [data-theme="fallout"]::before {
            content: " ";
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%),
                linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            z-index: 9999;
            background-size: 100% 4px, 3px 100%;
            pointer-events: none;
            opacity: 0.3;
        }

        [data-theme="fallout"] .main-logo {
            filter: brightness(0) invert(1) sepia(1) saturate(5000%) hue-rotate(100deg) brightness(1.2) drop-shadow(0 0 12px #18ff62) !important;
        }

        [data-theme="fallout"] .date-cell {
            color: #18ff62 !important;
            opacity: 0.8;
            font-weight: bold;
        }

        [data-theme="fallout"] .brand-container {
            background: var(--brand-bg) !important;
            border-color: var(--brand-border) !important;
        }

        [data-theme="fallout"] .brand-container img {
            filter: brightness(0) invert(1) sepia(1) saturate(3000%) hue-rotate(100deg) brightness(1.2);
        }

        [data-theme="fallout"] #totalCount {
            background: rgba(24, 255, 98, 0.1) !important;
            color: #18ff62 !important;
            border: 1px solid rgba(24, 255, 98, 0.3) !important;
            text-shadow: 0 0 5px #18ff62;
        }

        [data-theme="fallout"] th {
            color: #18ff62;
            border-bottom: 2px solid #18ff62;
            text-transform: uppercase;
            font-weight: 800;
        }

        [data-theme="fallout"] input,
        [data-theme="fallout"] select {
            border: 1px solid #18ff62 !important;
            background: #001100 !important;
            color: #18ff62 !important;
        }

        * {
            box-sizing: border-box;
            transition: background 0.4s ease, color 0.4s ease, border-color 0.4s ease, box-shadow 0.4s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            padding: 40px 20px;
            background: var(--apple-bg);
            color: var(--apple-text);
            -webkit-font-smoothing: antialiased;
            letter-spacing: -0.01em;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            background: var(--apple-card);
            backdrop-filter: var(--glass-blur);
            padding: 32px;
            border-radius: 24px;
            border: 1px solid var(--apple-border);
            box-shadow: var(--card-shadow);
        }

        h1 {
            font-weight: 600;
            font-size: 24px;
            letter-spacing: -0.02em;
        }

        .toolbar {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 16px;
            border: 1px solid var(--apple-border);
        }

        .sort-chips {
            display: flex;
            gap: 4px;
            background: rgba(0, 0, 0, 0.03);
            padding: 4px;
            border-radius: 12px;
        }

        .chip {
            padding: 6px 14px;
            font-size: 13px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--apple-subtext);
        }

        .chip.active {
            background: var(--apple-blue);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 113, 227, 0.3);
        }

        input,
        select {
            padding: 10px 14px;
            background: var(--input-bg);
            border: 1px solid var(--apple-border);
            border-radius: 12px;
            font-size: 14px;
            color: var(--apple-text);
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--apple-blue);
            box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.1);
        }

        button {
            padding: 10px 20px;
            background: var(--apple-blue);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            filter: brightness(1.05);
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        /* Monochrome Dark Mode Buttons */
        [data-theme="dark"] button {
            background: #2c2c2e;
            color: #f5f5f7;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] button:hover {
            background: #3a3a3c;
            border-color: rgba(255, 255, 255, 0.2);
        }

        [data-theme="dark"] button.success {
            background: #f5f5f7;
            color: #1c1c1e;
            border: none;
        }

        [data-theme="dark"] button.success:hover {
            background: #ffffff;
            opacity: 0.9;
        }

        [data-theme="dark"] button.danger {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #f5f5f7;
        }

        [data-theme="dark"] button.danger:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.4);
        }

        [data-theme="dark"] .chip.active {
            background: #f5f5f7;
            color: #1c1c1e;
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] button.secondary {
            background: rgba(255, 255, 255, 0.05);
            color: #f5f5f7;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        button.secondary {
            background: rgba(0, 0, 0, 0.05);
            color: var(--apple-text);
        }

        button.success {
            background: var(--apple-green);
        }

        button.danger {
            background: var(--apple-red);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        th {
            background: transparent;
            font-size: 12px;
            font-weight: 600;
            color: var(--apple-subtext);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 16px 12px;
            border-bottom: 1px solid var(--apple-border);
        }

        td {
            padding: 16px 12px;
            border-bottom: 1px solid var(--apple-border);
            font-size: 14px;
        }

        tr:hover td {
            background: rgba(0, 0, 0, 0.01);
        }

        tr.pending {
            background: rgba(251, 192, 45, 0.05) !important;
        }

        .pending-tag {
            font-size: 10px;
            background: var(--apple-text);
            color: #fff;
            padding: 2px 8px;
            border-radius: 20px;
            font-weight: 600;
            margin-left: 8px;
        }

        .thumb {
            width: 52px;
            height: 52px;
            object-fit: contain;
            border-radius: 14px;
            background: var(--input-bg);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            cursor: zoom-in;
            border: 1px solid var(--apple-border);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--modal-bg);
            padding: 40px;
            border-radius: 36px;
            width: 520px;
            border: 1px solid var(--apple-border);
            box-shadow: 0 40px 80px rgba(0, 0, 0, 0.3);
            color: var(--apple-text);
        }

        #themeToggle {
            background: var(--apple-card);
            border: 1px solid var(--apple-border);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: var(--apple-text);
            backdrop-filter: var(--glass-blur);
        }

        #themeToggle:hover {
            transform: scale(1.1);
        }

        .drop-zone {
            border: 2px dashed var(--apple-border);
            padding: 32px;
            text-align: center;
            border-radius: 20px;
            color: var(--apple-subtext);
            margin-bottom: 24px;
            background: var(--apple-bg);
        }

        .drop-zone:hover {
            border-color: var(--apple-blue);
            background: rgba(0, 113, 227, 0.02);
        }

        .p-desc {
            font-size: 11px;
            color: var(--apple-subtext);
            max-width: 380px;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.4;
            margin-top: 3px;
            font-weight: 400;
        }

        [data-theme="fallout"] .p-desc {
            color: rgba(24, 255, 98, 0.7);
            text-shadow: none;
        }

        #zoomOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            cursor: zoom-out;
        }

        #zoomOverlay img {
            max-width: 90%;
            max-height: 90%;
        }

        .main-logo {
            height: 48px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
            transition: filter 0.4s ease;
        }

        [data-theme="dark"] .main-logo {
            filter: brightness(0) invert(1) drop-shadow(0 4px 12px rgba(255, 255, 255, 0.1));
        }

        [data-theme="fallout"] button,
        [data-theme="fallout"] .chip {
            background: transparent !important;
            color: #18ff62 !important;
            border: 1px solid #18ff62 !important;
        }

        [data-theme="fallout"] button.success,
        [data-theme="fallout"] .chip.active {
            background: #18ff62 !important;
            color: #000 !important;
        }
    </style>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Librer√≠as de Exportaci√≥n -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>

<body>

    <div class="container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
            <div style="display:flex; align-items:center; gap:20px;">
                <img src="/assets/logo.svg" alt="Integral" class="main-logo">
                <div style="display:flex; align-items:center; gap:12px;">
                    <h1 style="margin:0; font-size: 1.6rem;">Gestor de Cat√°logo Pro</h1>
                    <span id="pendingCount"
                        style="background:var(--apple-red); color:white; padding:4px 12px; border-radius:20px; font-size:12px; font-weight:700; display:none;">0
                        pendientes</span>
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:12px;">
                <button id="falloutToggle" onclick="toggleTheme('fallout')" title="Modo Fallout"
                    style="background: transparent; border: 1px solid var(--apple-border); color: var(--apple-text); border-radius: 50%; width: 44px; height: 44px; justify-content: center;">
                    <i class="fa-solid fa-radiation"></i>
                </button>
                <button id="themeToggle" onclick="toggleTheme()" title="Cambiar Tema">
                    <i class="fa-solid fa-moon"></i>
                </button>
                <button class="success" id="btnPublish" onclick="publishChanges()">üöÄ ENVIAR A LA WEB</button>
            </div>
        </div>

        <div class="toolbar">
            <input type="text" id="search" placeholder="Buscar por nombre, ID o marca..." onkeyup="filterAndSort()"
                style="width:300px">

            <div class="sort-chips">
                <span class="chip active" onclick="setSort('recent', this)">√öltimos cargados</span>
                <span class="chip" onclick="setSort('alpha', this)">Alfab√©tico</span>
                <span class="chip" onclick="setSort('category', this)">Por Categor√≠a</span>
            </div>

            <select id="filterBrand" onchange="filterAndSort()" style="margin-left: 10px; max-width: 150px;">
                <option value="">Todas las marcas</option>
            </select>

            <span id="totalCount"
                style="margin-left: 15px; font-weight: bold; padding: 4px 10px; border-radius: 4px; font-size: 13px;">
                0 productos
            </span>

            <div style="margin-left: 10px; display: flex; gap: 5px;">
                <button onclick="exportToExcel()" class="secondary"
                    style="background: transparent; border: 1px solid var(--apple-border); color: #1d6f42;"
                    title="Exportar a Excel">
                    <i class="fa-solid fa-file-excel"></i>
                </button>
                <button onclick="exportToPDF()" class="secondary"
                    style="background: transparent; border: 1px solid var(--apple-border); color: #a30000;"
                    title="Exportar a PDF">
                    <i class="fa-solid fa-file-pdf"></i>
                </button>
            </div>

            <div style="margin-left:auto; display:flex; gap:10px;">
                <button class="secondary" onclick="openBulkModal()" title="Carga Masiva">
                    <i class="fa-solid fa-file-import"></i> Carga Masiva
                </button>
                <button onclick="newProduct()">+ Nuevo Producto</button>
            </div>
        </div>

        <table id="productTable">
            <thead>
                <tr>
                    <th>Foto</th>
                    <th>ID</th>
                    <th>Marca</th>
                    <th>Nombre</th>
                    <th>Categor√≠a</th>
                    <th>Fecha Alta</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Modal Form -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Nuevo Producto</h2>

            <div id="dropZone" class="drop-zone" onclick="document.getElementById('fileInput').click()">
                <p id="dropText">üìÅ Arrastra o selecciona la foto</p>
            </div>
            <input type="file" id="fileInput" style="display:none" onchange="handleFileUpload(this.files[0])">
            <input type="hidden" id="p_image">

            <label>Nombre del Producto (Sin Marca)</label><br>
            <input type="text" id="p_name" placeholder="Ej. Cartucho 12A Negro" style="width:100%"><br><br>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div>
                    <label>ID / Modelo</label><br>
                    <input type="text" id="p_id" style="width:100%">
                </div>
                <div>
                    <label>Categor√≠a Web</label><br>
                    <select id="p_category" style="width:100%">
                        <option value="toner">TONERS</option>
                        <option value="papeleria">PAPELER√çA</option>
                        <option value="accesorios">ACCESORIOS</option>
                    </select>
                </div>
            </div>

            <br>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div>
                    <label>Marca</label><br>
                    <div style="display:flex; gap:5px;">
                        <select id="p_brand" style="flex-grow:1"></select>
                        <button type="button" onclick="addNewBrand()"
                            style="padding:5px 10px; background:#6c757d;">+</button>
                    </div>
                </div>
                <div>
                    <label>Compatibilidad</label><br>
                    <input type="text" id="p_compatibility" placeholder="Ej. M15w, P1102" style="width:100%">
                </div>
            </div>

            <br>
            <label>Descripci√≥n</label><br>
            <textarea id="p_description" placeholder="Descripci√≥n detallada del producto..."
                style="width:100%; height:80px; padding:10px; border-radius:12px; border:1px solid var(--apple-border); background:var(--input-bg); color:var(--apple-text); font-family:inherit; resize: none;"></textarea>

            <div style="display:flex; justify-content:space-between; margin-top:20px;">
                <button class="secondary" onclick="closeModal()">Cancelar</button>
                <button onclick="saveProduct()">üíæ Guardar Producto</button>
            </div>
        </div>
    </div>

    <!-- Modal Masivo -->
    <div id="bulkModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top:0">Carga Masiva Apple-style Ô£ø</h2>
            <p style="color:var(--apple-subtext); font-size:14px">Sube un CSV y las im√°genes (el nombre del archivo debe
                ser el ID del producto).</p>

            <div style="margin-bottom:20px">
                <label style="display:block; margin-bottom:8px; font-weight:600">1. Archivo CSV</label>
                <input type="file" id="bulkCSV" accept=".csv" style="width:100%">
            </div>

            <div style="margin-bottom:20px">
                <label style="display:block; margin-bottom:8px; font-weight:600">2. Carpeta de Im√°genes</label>
                <input type="file" id="bulkImages" multiple accept="image/*" style="width:100%">
            </div>

            <div id="bulkProgress" style="display:none; margin-bottom:20px">
                <div style="height:6px; background:var(--apple-bg); border-radius:10px; overflow:hidden">
                    <div id="progressBar" style="height:100%; background:var(--apple-blue); width:0%"></div>
                </div>
                <p id="progressText" style="font-size:12px; margin-top:5px; text-align:center"></p>
            </div>

            <div style="display:flex; justify-content:space-between; margin-top:30px;">
                <button class="secondary" onclick="closeBulkModal()">Cancelar</button>
                <button onclick="processBulk()" id="btnProcessBulk">Iniciar Carga</button>
            </div>
        </div>
    </div>
    <!-- Price Scout Modal -->
    <div id="scoutModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div id="scoutProductHeader"
                style="display: flex; align-items: center; gap: 20px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid var(--apple-border);">
                <img id="scoutProductImg" src=""
                    style="width: 100px; height: 100px; object-fit: cover; border-radius: 12px; background: rgba(0,0,0,0.03); border: 1px solid var(--apple-border);">
                <div style="flex: 1;">
                    <h2
                        style="margin: 0; font-size: 14px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--apple-subtext); margin-bottom: 4px;">
                        Radar de Mercado</h2>
                    <div id="scoutProductModel"
                        style="font-weight: 800; font-size: 24px; color: var(--apple-blue); line-height: 1.1;"></div>
                    <div id="scoutProductName"
                        style="font-size: 13px; color: var(--apple-text); margin-top: 6px; opacity: 0.8; font-weight: 500;">
                    </div>
                </div>
            </div>

            <div id="scoutLoading" style="text-align:center; padding: 20px; display:none;">
                <i class="fa-solid fa-satellite-dish fa-spin" style="font-size: 30px; color: var(--apple-blue);"></i>
                <p style="margin-top:10px; font-weight:600;">Escaneando precios en tiempo real...</p>
            </div>
            <div id="scoutResults" style="margin-top:10px;"></div>
            <div style="display:flex; justify-content:center; margin-top:20px;">
                <button class="secondary" onclick="document.getElementById('scoutModal').style.display='none'">Cerrar
                    Radar</button>
            </div>
        </div>
    </div>
    <!-- Image Wizard Modal -->
    <div id="imageWizardModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                <div id="wizardIcon"
                    style="background: var(--apple-blue); color: white; width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <i class="fa-solid fa-wand-magic-sparkles" style="font-size: 20px;"></i>
                </div>
                <div>
                    <h2 id="wizardTitle" style="margin:0; font-size: 18px;">Asistente Inteligente</h2>
                    <p id="wizardProductTitle" style="margin:0; font-size: 13px; color: var(--apple-subtext);"></p>
                </div>
            </div>

            <div
                style="background: rgba(0, 113, 227, 0.05); padding: 18px; border-radius: 16px; border: 1px solid rgba(0, 113, 227, 0.1); margin-bottom: 20px;">
                <p style="margin-top:0; font-size: 14px; font-weight: 600; display:flex; align-items:center; gap:8px;">
                    <span
                        style="background:var(--apple-blue); color:white; width:20px; height:20px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:10px;">1</span>
                    Busca la imagen
                </p>
                <button id="btnWizardSearch" onclick=""
                    style="width: 100%; justify-content: center; background: #4285f4; margin-bottom: 10px; border-radius: 12px; height: 45px;">
                    <i class="fa-brands fa-google"></i> Buscar en Google
                </button>
                <p style="font-size: 12px; color: var(--apple-subtext); margin: 0; line-height: 1.4;">
                    Haz clic derecho en la imagen que te guste y selecciona <br><b>"Copiar direcci√≥n de imagen"</b>.
                </p>
            </div>

            <div style="margin-bottom: 20px;">
                <p style="margin-top:0; font-size: 14px; font-weight: 600; display:flex; align-items:center; gap:8px;">
                    <span
                        style="background:var(--apple-blue); color:white; width:20px; height:20px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:10px;">2</span>
                    Pega el enlace aqu√≠
                </p>
                <input type="text" id="wizardImageUrl" placeholder="Pega el link aqu√≠ (ej. https://.../foto.jpg)"
                    style="width: 100%; margin-bottom: 12px; height: 45px;">
                <button id="btnImportImage" onclick="importWizardImage()"
                    style="width: 100%; justify-content: center; height: 45px; border-radius: 12px;">
                    <i class="fa-solid fa-cloud-arrow-down"></i> Procesar y Guardar
                </button>
            </div>

            <div id="wizardStatus"
                style="display:none; text-align: center; padding: 15px; background: rgba(0,0,0,0.03); border-radius: 12px; margin-bottom: 15px;">
                <i class="fa-solid fa-circle-notch fa-spin" style="color:var(--apple-blue);"></i>
                <p id="wizardStatusText" style="font-size: 13px; margin-top: 8px; font-weight: 500;"></p>
            </div>

            <div style="display:flex; justify-content:center;">
                <button class="secondary" onclick="document.getElementById('imageWizardModal').style.display='none'"
                    style="background:none; border:none; color:var(--apple-subtext);">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Zoom Overlay (Restored) -->
    <div id="zoomOverlay" onclick="this.style.display='none'"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; align-items:center; justify-content:center; cursor:zoom-out;">
        <img id="zoomedImg"
            style="max-width:90%; max-height:90%; border-radius:12px; box-shadow:0 0 50px rgba(0,0,0,0.5);">
    </div>

    <script>
        let products = [];
        let currentSort = 'recent';

        let filteredList = [];

        async function loadProducts() {
            const res = await fetch('/api/products');
            const data = await res.json();
            products = data.data;
            updateBrandSelector();
            filterAndSort();
        }

        function updateBrandSelector() {
            // Marcas base que siempre deben estar + las que existan en la DB
            const standardBrands = ['HP', 'Brother', 'Canon', 'Lexmark', 'Xerox'];
            let dbBrands = [...new Set(products.map(p => p.brand).filter(b => b && !standardBrands.includes(b) && b !== 'Otros'))];
            let allBrands = [...standardBrands, ...dbBrands].sort();
            allBrands.push('Otros');

            // Selector del Modal
            const sel = document.getElementById('p_brand');
            const currentVal = sel.value;
            sel.innerHTML = '<option value="">Seleccione marca...</option>';

            // Selector de Filtro en Tabla
            const filterSel = document.getElementById('filterBrand');
            const currentFilter = filterSel.value;
            filterSel.innerHTML = '<option value="">Todas las marcas</option>';

            allBrands.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b; opt.textContent = b;
                sel.appendChild(opt.cloneNode(true));
                filterSel.appendChild(opt);
            });

            if (currentVal) sel.value = currentVal;
            if (currentFilter) filterSel.value = currentFilter;
        }

        function addNewBrand() {
            const newB = prompt("Nombre de la nueva marca:");
            if (newB) {
                const sel = document.getElementById('p_brand');
                const opt = document.createElement('option');
                opt.value = newB;
                opt.textContent = newB;
                sel.appendChild(opt);
                sel.value = newB;
            }
        }

        function setSort(type, el) {
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            currentSort = type;
            filterAndSort();
        }

        function filterAndSort() {
            const term = document.getElementById('search').value.toLowerCase();
            const brandFilter = document.getElementById('filterBrand').value;

            let list = products.filter(p => {
                const matchesSearch = (p.id && p.id.toLowerCase().includes(term)) ||
                    (p.name && p.name.toLowerCase().includes(term)) ||
                    (p.brand && p.brand.toLowerCase().includes(term));

                const matchesBrand = !brandFilter || p.brand === brandFilter;

                return matchesSearch && matchesBrand;
            });

            if (currentSort === 'alpha') list.sort((a, b) => (a.brand || "").localeCompare(b.brand || "") || a.name.localeCompare(b.name));
            if (currentSort === 'recent') list.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            if (currentSort === 'category') list.sort((a, b) => a.category.localeCompare(b.category));

            document.getElementById('totalCount').innerText = `${list.length} productos`;
            filteredList = list;
            renderTable(list);
        }

        // --- FUNCIONES DE EXPORTACI√ìN ---
        function exportToExcel() {
            try {
                if (filteredList.length === 0) return alert("No hay datos para exportar");

                const data = filteredList.map(p => ({
                    'ID': p.id,
                    'Marca': p.brand,
                    'Nombre': p.name,
                    'Categor√≠a': catMap[p.category] || p.category,
                    'Fecha Alta': p.created_at ? new Date(p.created_at).toLocaleDateString('es-MX') : '-',
                    'Compatibilidad': p.compatibility
                }));

                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Inventario");
                XLSX.writeFile(wb, `Inventario_Integral_${new Date().toISOString().split('T')[0]}.xlsx`);
            } catch (err) {
                console.error(err);
                alert("Error t√©cnico al exportar Excel: " + err.message);
            }
        }

        async function exportToPDF() {
            try {
                if (filteredList.length === 0) return alert("No hay datos para exportar");
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const isDark = document.body.getAttribute('data-theme') === 'dark';

                // Apple-style color palette
                const colors = isDark ? {
                    bg: [0, 0, 0],
                    text: [245, 245, 247],
                    headBg: [28, 28, 30],
                    headText: [255, 255, 255],
                    alternateRow: [18, 18, 20],
                    border: [44, 44, 46]
                } : {
                    bg: [255, 255, 255],
                    text: [29, 29, 31],
                    headBg: [245, 245, 247],
                    headText: [134, 134, 139],
                    alternateRow: [250, 250, 252],
                    border: [240, 240, 245]
                };

                // Fill background if dark mode
                if (isDark) {
                    doc.setFillColor(...colors.bg);
                    doc.rect(0, 0, 210, 297, 'F');
                }

                // Styled Header
                doc.setFont("helvetica", "bold");
                doc.setFontSize(22);
                doc.setTextColor(...colors.text);
                doc.text("Gestor de Cat√°logo Pro", 14, 25);

                doc.setFont("helvetica", "normal");
                doc.setFontSize(9);
                doc.setTextColor(isDark ? 161 : 134, isDark ? 161 : 134, isDark ? 166 : 139);
                doc.text("Reporte de Inventario | Integral Computaci√≥n", 14, 32);
                doc.text(`Generado: ${new Date().toLocaleString('es-MX')}`, 14, 37);

                const rows = filteredList.map(p => [
                    p.id,
                    p.brand,
                    p.name,
                    catMap[p.category] || p.category,
                    p.created_at ? new Date(p.created_at).toLocaleDateString('es-MX') : '-',
                    p.compatibility || '-'
                ]);

                doc.autoTable({
                    head: [['ID', 'Marca', 'Nombre', 'Categor√≠a', 'Alta', 'Compatibilidad']],
                    body: rows,
                    startY: 45,
                    margin: { left: 14, right: 14 },
                    styles: {
                        font: "helvetica",
                        fontSize: 8,
                        cellPadding: 4,
                        textColor: colors.text,
                        fillColor: isDark ? [0, 0, 0] : [255, 255, 255],
                        lineColor: colors.border,
                        lineWidth: 0.1,
                    },
                    headStyles: {
                        fillColor: colors.headBg,
                        textColor: colors.headText,
                        fontSize: 8,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: colors.alternateRow
                    },
                    tableLineColor: colors.border,
                    tableLineWidth: 0.1,
                });

                doc.save(`Inventario_Integral_${new Date().toISOString().split('T')[0]}.pdf`);
            } catch (err) {
                console.error(err);
                alert("Error al generar PDF: " + err.message);
            }
        }

        const catMap = { toner: 'TONERS', papeleria: 'PAPELER√çA', accesorios: 'ACCESORIOS' };

        function renderTable(list) {
            const tbody = document.querySelector('#productTable tbody');
            tbody.innerHTML = '';
            let pending = 0;

            list.forEach(p => {
                const tr = document.createElement('tr');
                if (p.published === 0) { tr.classList.add('pending'); pending++; }

                // L√≥gica de Imagen: Si p.image es null o logo.svg, marcar como vac√≠o
                const hasNoImage = !p.image || p.image.includes('logo.svg') || p.image.includes('default');

                // Determinar ruta de imagen
                let imgName = p.image ? p.image.split('/').pop() : 'logo.svg';
                const imgSrc = `/assets/${imgName}`;

                tr.innerHTML = `
                <td>
                    <div style="position:relative; width: 40px; height: 40px;">
                        <img src="${imgSrc}" class="thumb" onclick='zoom("${imgSrc}")' onerror="this.src='/assets/logo.svg'">
                        ${hasNoImage ? `
                            <div onclick='event.stopPropagation(); openImageWizard(${JSON.stringify(p.id)}, ${JSON.stringify(p.name)}, "product")' 
                                 style="position:absolute; bottom:-5px; right:-5px; background:var(--apple-blue); color:white; width:22px; height:22px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:10px; border:2px solid white; box-shadow:0 2px 8px rgba(0,0,0,0.3); z-index: 1;" 
                                 title="Agregar imagen inteligente">
                                <i class="fa-solid fa-wand-magic-sparkles"></i>
                            </div>
                        ` : ''}
                    </div>
                </td>
                <td><b>${p.id}</b></td>
                <td>
                    <div class="brand-container" style="position:relative; display:flex; align-items:center; justify-content: center; background:#f8f9fa; padding:4px; border-radius:6px; border:1px solid #eee; width: 60px; height: 30px;">
                        <img src="/assets/${(p.brand || '').toLowerCase().replace(/[^a-z0-9]/g, '')}.png" 
                             style="max-width: 100%; max-height: 100%; object-fit: contain;" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block'; const wand = this.parentNode.querySelector('.brand-magic'); if(wand && ${p.brand && p.brand !== 'Otros' ? 'true' : 'false'}) wand.style.display='flex';">
                        <span style="display:none; font-size:10px; font-weight:600; color:#999; text-transform:uppercase;">${p.brand || 'S/M'}</span>
                        <div class="brand-magic" onclick='event.stopPropagation(); openImageWizard(${JSON.stringify(p.brand)}, "", "brand")' 
                             style="display:none; position:absolute; bottom:-5px; right:-5px; background:#ff2d55; color:white; width:22px; height:22px; border-radius:50%; align-items:center; justify-content:center; cursor:pointer; font-size:10px; border:2px solid white; box-shadow:0 2px 8px rgba(0,0,0,0.3); z-index: 2;" 
                             title="Agregar logo de marca">
                            <i class="fa-solid fa-wand-magic-sparkles"></i>
                        </div>
                    </div>
                </td>
                <td>
                    <div style="font-weight:600; display:flex; align-items:center; gap:8px;">
                        ${p.name} ${p.published === 0 ? '<span class="pending-tag">NUEVO</span>' : ''}
                    </div>
                    <div class="p-desc" title="${p.description && p.description !== 'null' ? p.description : p.name}">
                        ${p.description && p.description !== 'null' ? p.description : p.name}
                    </div>
                </td>
                <td>${catMap[p.category] || p.category}</td>
                <td class="date-cell" style="font-size: 11px; color: #666;">${p.created_at ? new Date(p.created_at).toLocaleDateString('es-MX') : '-'}</td>
                <td>
                    <div style="display: flex; gap: 6px; white-space: nowrap;">
                        <button class="secondary" style="padding:6px 12px; font-size: 14px; border-radius: 6px;" onclick='editProduct(${JSON.stringify(p)})'>
                            <i class="fa-solid fa-pen-to-square"></i>
                        </button>
                        <button class="secondary" style="padding:6px 12px; font-size: 14px; border-radius: 6px; color: #0071e3;" title="Espiar Precios" onclick='scoutMarket(${JSON.stringify(p.id)}, ${JSON.stringify(p.name)}, "${imgSrc}")'>
                            <i class="fa-solid fa-magnifying-glass-dollar"></i>
                        </button>
                        <button class="danger" style="padding:6px 14px; font-size: 14px; border-radius: 6px; background: #ea4335; color: white; border: none;" onclick='deleteProduct(${JSON.stringify(p.id)})'>
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                </td>
            `;
                tbody.appendChild(tr);
            });

            const badge = document.getElementById('pendingCount');
            if (pending > 0) { badge.innerText = `${pending} pendientes`; badge.style.display = 'block'; }
            else { badge.style.display = 'none'; }
        }

        async function handleFileUpload(file) {
            if (!file) return;
            const dropZone = document.getElementById('dropZone');
            dropZone.innerHTML = "‚è≥ Subiendo...";
            const formData = new FormData();
            formData.append('image', file);
            const res = await fetch('/api/upload', { method: 'POST', body: formData });
            const data = await res.json();
            document.getElementById('p_image').value = data.url;
            dropZone.innerHTML = `<img src="/${data.url}" style="height:60px; border-radius:4px;">`;
        }

        async function saveProduct() {
            const id = document.getElementById('p_id').value.trim();
            if (!id) return alert("‚ùå El ID/Modelo es obligatorio.");

            const name = document.getElementById('p_name').value;
            let description = document.getElementById('p_description').value;

            // L√≥gica: Si no hay descripci√≥n o es "null", copiar el nombre
            if (!description || !description.trim() || description.toLowerCase() === 'null') description = name;

            const body = {
                id,
                name,
                category: document.getElementById('p_category').value,
                brand: document.getElementById('p_brand').value,
                price: 0,
                stock: 0,
                compatibility: document.getElementById('p_compatibility').value,
                image: document.getElementById('p_image').value,
                description
            };

            const isEdit = products.find(p => p.id === id);
            const method = isEdit ? 'PUT' : 'POST';
            const url = isEdit ? `/api/products/${id}` : '/api/products';

            const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            if (!res.ok) {
                const errData = await res.json();
                alert("Error al guardar: " + (errData.error || "Desconocido"));
                return;
            }
            closeModal();
            loadProducts();
        }

        async function publishChanges() {
            const btn = document.getElementById('btnPublish');
            btn.innerText = "‚è≥ PROCESANDO...";
            btn.disabled = true;
            await fetch('/api/publish', { method: 'POST' });
            btn.innerText = "‚úÖ ¬°WEB ACTUALIZADA!";
            setTimeout(() => { btn.innerText = "üöÄ ENVIAR A LA WEB"; btn.disabled = false; loadProducts(); }, 3000);
        }

        function newProduct() {
            document.getElementById('modalTitle').innerText = "Nuevo Producto";
            document.getElementById('p_id').value = ""; document.getElementById('p_id').disabled = false;
            document.getElementById('p_name').value = ""; document.getElementById('p_brand').value = "";
            document.getElementById('p_compatibility').value = ""; document.getElementById('p_image').value = "";
            document.getElementById('p_description').value = "";
            document.getElementById('dropZone').innerHTML = "üìÅ Arrastra o selecciona la foto";
            document.getElementById('modal').style.display = 'flex';
        }

        function editProduct(p) {
            document.getElementById('modalTitle').innerText = "Editar Producto";
            document.getElementById('p_id').value = p.id; document.getElementById('p_id').disabled = true;
            document.getElementById('p_name').value = p.name;
            document.getElementById('p_brand').value = p.brand || "";
            document.getElementById('p_category').value = p.category;
            document.getElementById('p_image').value = p.image || "";
            document.getElementById('p_compatibility').value = p.compatibility || "";
            document.getElementById('p_description').value = p.description || "";
            let imgName = p.image ? p.image.split('/').pop() : 'logo.svg';
            document.getElementById('dropZone').innerHTML = `<img src="/assets/${imgName}" style="height:60px; border-radius:4px;">`;
            document.getElementById('modal').style.display = 'flex';
        }

        function openBulkModal() { document.getElementById('bulkModal').style.display = 'flex'; }
        function closeBulkModal() { document.getElementById('bulkModal').style.display = 'none'; }

        async function processBulk() {
            const csvFile = document.getElementById('bulkCSV').files[0];
            const images = document.getElementById('bulkImages').files;
            if (!csvFile) return alert("Selecciona un CSV");

            const btn = document.getElementById('btnProcessBulk');
            const progress = document.getElementById('bulkProgress');
            const bar = document.getElementById('progressBar');
            const text = document.getElementById('progressText');

            btn.disabled = true;
            progress.style.display = 'block';

            Papa.parse(csvFile, {
                header: true,
                skipEmptyLines: true,
                complete: async (results) => {
                    const data = results.data;
                    const total = data.length;
                    let count = 0;

                    for (const row of data) {
                        try {
                            const id = row.id || row.ID || row.Id;
                            if (!id) continue;

                            // Buscar imagen
                            let imageUrl = '';
                            const matchingImage = Array.from(images).find(f => {
                                const nameNoExt = f.name.split('.').slice(0, -1).join('.');
                                return nameNoExt.toLowerCase() === id.toString().toLowerCase();
                            });

                            if (matchingImage) {
                                const formData = new FormData();
                                formData.append('image', matchingImage);
                                const uploadRes = await fetch('/api/upload', { method: 'POST', body: formData });
                                const uploadData = await uploadRes.json();
                                imageUrl = uploadData.url;
                            }

                            const name = row.name || row.Nombre || '';
                            let description = row.description || row.descripcion || row.Descripci√≥n || '';
                            if (!description || !description.trim() || description.toLowerCase() === 'null') description = name;

                            const productData = {
                                id: id,
                                name: name,
                                category: row.category || row.Categoria || 'toner',
                                brand: row.brand || row.Marca || 'Otros',
                                price: 0,
                                stock: 0,
                                compatibility: row.compatibility || row.Compatibilidad || '',
                                image: imageUrl,
                                description: description
                            };

                            // Guardar (POST o PUT si existe)
                            const exists = products.find(p => p.id == id);
                            const method = exists ? 'PUT' : 'POST';
                            const url = exists ? `/api/products/${id}` : '/api/products';

                            await fetch(url, {
                                method: method,
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(productData)
                            });

                        } catch (err) {
                            console.error("Bulk Item Error:", err);
                        }

                        count++;
                        const pct = Math.round((count / total) * 100);
                        bar.style.width = pct + '%';
                        text.innerText = `Procesando ${count} de ${total}...`;
                    }

                    alert("Carga masiva completada");
                    btn.disabled = false;
                    progress.style.display = 'none';
                    closeBulkModal();
                    loadProducts();
                }
            });
        }

        async function scoutMarket(model, name = "", image = "") {
            const modal = document.getElementById('scoutModal');
            const resultsDiv = document.getElementById('scoutResults');
            const loading = document.getElementById('scoutLoading');

            // Set Header Info
            document.getElementById('scoutProductImg').src = image || '/assets/logo.svg';
            document.getElementById('scoutProductModel').innerText = model;
            document.getElementById('scoutProductName').innerText = name;

            resultsDiv.innerHTML = '';
            loading.style.display = 'block';
            modal.style.display = 'flex';

            try {
                const res = await fetch(`/api/scout-price/${encodeURIComponent(model)}?name=${encodeURIComponent(name)}`);
                const data = await res.json();
                loading.style.display = 'none';

                if (!data.data || data.data.length === 0) {
                    resultsDiv.innerHTML = '<p style="text-align:center; color:#999;">No se encontraron precios competitivos en este momento.</p>';
                    return;
                }

                data.data.forEach(item => {
                    const row = document.createElement('div');
                    row.style = 'padding:12px; border-bottom:1px solid var(--apple-border); display:flex; justify-content:space-between; align-items:center;';
                    row.innerHTML = `
                        <div style="flex-grow:1; padding-right:10px;">
                            <div style="font-weight:600; font-size:13px;">${item.store || 'Referencia'}</div>
                            <div style="font-size:11px; color:#666;">${item.title}</div>
                        </div>
                        <div style="display:flex; flex-direction:column; align-items:flex-end;">
                            <div style="font-weight:700; color:var(--apple-blue); min-width:80px; text-align:right;">${item.priceText}</div>
                            ${item.url ? `<a href="${item.url}" target="_blank" style="font-size:10px; color:var(--apple-blue); text-decoration:none; margin-top:4px;"><i class="fa-solid fa-arrow-up-right-from-square"></i> Ver sitio</a>` : ''}
                        </div>
                    `;
                    resultsDiv.appendChild(row);
                });
            } catch (err) {
                loading.style.display = 'none';
                resultsDiv.innerHTML = '<p style="color:red; text-align:center;">Error al conectar con el Radar de Mercado.</p>';
            }
        }

        let wizardMode = 'product'; // 'product' or 'brand'
        let currentWizardTarget = null;

        function openImageWizard(targetId, targetName, mode = 'product') {
            wizardMode = mode;
            currentWizardTarget = { id: targetId, name: targetName };

            const title = document.getElementById('wizardTitle');
            const subTitle = document.getElementById('wizardProductTitle');
            const searchBtn = document.getElementById('btnWizardSearch');

            if (mode === 'product') {
                title.innerText = "Asistente de Imagen";
                subTitle.innerText = `${targetId} - ${targetName}`;
                searchBtn.onclick = () => window.open(`https://www.google.com/search?q=${encodeURIComponent(targetId + ' ' + targetName + ' toner producto')}&tbm=isch`, '_blank');
            } else {
                title.innerText = "Asistente de Logo";
                subTitle.innerText = `Marca: ${targetId}`;
                searchBtn.onclick = () => window.open(`https://www.google.com/search?q=${encodeURIComponent(targetId + ' logo png official')}&tbm=isch`, '_blank');
            }

            document.getElementById('wizardImageUrl').value = '';
            document.getElementById('wizardStatus').style.display = 'none';
            document.getElementById('imageWizardModal').style.display = 'flex';
        }

        async function importWizardImage() {
            const url = document.getElementById('wizardImageUrl').value.trim();
            if (!url) return alert("Por favor, pega un enlace de imagen.");

            const status = document.getElementById('wizardStatus');
            const statusText = document.getElementById('wizardStatusText');
            status.style.display = 'block';
            statusText.innerText = "Procesando imagen...";

            const endpoint = wizardMode === 'product' ? '/api/import-image-url' : '/api/import-brand-logo';
            const body = wizardMode === 'product'
                ? { productId: currentWizardTarget.id, imageUrl: url }
                : { brandName: currentWizardTarget.id, imageUrl: url };

            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await res.json();
                if (data.success) {
                    statusText.innerText = `‚úÖ ¬°√âxito! ${wizardMode === 'product' ? 'Imagen' : 'Logo'} actualizado.`;
                    setTimeout(() => {
                        document.getElementById('imageWizardModal').style.display = 'none';
                        loadProducts();
                    }, 1500);
                } else {
                    throw new Error(data.error);
                }
            } catch (err) {
                statusText.innerText = `‚ùå Error: ${err.message}`;
            }
        }

        async function deleteProduct(id) {
            if (!confirm(`¬øEst√°s seguro de que deseas eliminar el producto "${id}"?`)) return;
            try {
                const res = await fetch(`/api/products/${encodeURIComponent(id)}`, { method: 'DELETE' });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Error al eliminar');

                if (data.changes === 0) {
                    alert("No se encontr√≥ el producto para eliminar.");
                } else {
                    loadProducts();
                }
            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
            }
        }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }
        function zoom(src) { document.getElementById('zoomedImg').src = src; document.getElementById('zoomOverlay').style.display = 'flex'; }

        function toggleTheme(specific) {
            const current = document.body.getAttribute('data-theme');
            let target;

            if (specific === 'fallout') {
                target = current === 'fallout' ? 'light' : 'fallout';
            } else {
                target = current === 'dark' ? 'light' : 'dark';
            }

            document.body.setAttribute('data-theme', target);
            localStorage.setItem('integral-theme', target);
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const current = document.body.getAttribute('data-theme');
            const icon = document.querySelector('#themeToggle i');
            const falloutBtn = document.getElementById('falloutToggle');

            if (current === 'fallout') {
                icon.className = 'fa-solid fa-terminal';
                falloutBtn.style.color = '#18ff62';
                falloutBtn.style.borderColor = '#18ff62';
            } else {
                icon.className = current === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
                falloutBtn.style.color = '';
                falloutBtn.style.borderColor = '';
            }
        }

        // Init Theme
        const savedTheme = localStorage.getItem('integral-theme') || 'light';
        document.body.setAttribute('data-theme', savedTheme);
        updateThemeIcon();

        window.addEventListener('keydown', (e) => { if (e.key === "Escape") closeModal(); });

        loadProducts();
    </script>
</body>

</html>