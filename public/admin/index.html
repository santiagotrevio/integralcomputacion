<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Cat√°logo Pro | Integral</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Inter:wght@400;500;600;700&family=Cinzel+Decorative:wght@400;700;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/admin.css">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Librer√≠as de Exportaci√≥n -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>

<body>

    <div class="container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
            <div style="display:flex; align-items:center; gap:20px;">
                <img src="/assets/logo.svg" alt="Integral" class="main-logo">
                <div style="display:flex; align-items:center; gap:12px;">
                    <h1 style="margin:0; font-size: 1.6rem;">Gestor de Cat√°logo Pro</h1>
                    <span id="pendingCount"
                        style="background:var(--apple-red); color:white; padding:4px 12px; border-radius:20px; font-size:12px; font-weight:700; display:none;">0
                        pendientes</span>
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:12px;">
                <button id="cyberToggle" onclick="toggleTheme('cyberpunk')" title="Modo Cyberpunk"
                    style="background: transparent; border: 1px solid var(--apple-border); color: var(--apple-text); border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; padding: 0;">
                    <i class="fa-solid fa-bolt-lightning"></i>
                </button>
                <button id="falloutToggle" onclick="toggleTheme('fallout')" title="Modo Fallout"
                    style="background: transparent; border: 1px solid var(--apple-border); color: var(--apple-text); border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; padding: 0;">
                    <i class="fa-solid fa-radiation"></i>
                </button>
                <button id="themeToggle" onclick="toggleTheme()" title="Cambiar Tema">
                    <i class="fa-solid fa-moon"></i>
                </button>
                <button id="historyToggle" onclick="toggleHistory()" title="Historial y Papelera"
                    style="background: transparent; border: 1px solid var(--apple-border); color: var(--apple-text); border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; padding: 0;">
                    <i class="fa-solid fa-clock-rotate-left"></i>
                </button>
                <div style="position:relative">
                    <button id="hpSecretBtn" onclick="toggleHPMenu()" title="Magia de Hogwarts">HP</button>
                    <div id="hpMenu" class="hp-menu">
                        <div class="hp-item" onclick="setHPTheme('gryffindor')"><i class="fa-solid fa-fire"></i>
                            Gryffindor</div>
                        <div class="hp-item" onclick="setHPTheme('slytherin')"><i class="fa-solid fa-staff-snake"></i>
                            Slytherin</div>
                        <div class="hp-item" onclick="setHPTheme('ravenclaw')"><i
                                class="fa-solid fa-feather-pointed"></i> Ravenclaw</div>
                        <div class="hp-item" onclick="setHPTheme('hufflepuff')"><i class="fa-solid fa-leaf"></i>
                            Hufflepuff</div>
                        <div class="hp-item" onclick="setHPTheme('clear')"
                            style="border-top:1px solid rgba(211,166,37,0.2); margin-top:5px; color:#aaa;"><i
                                class="fa-solid fa-wand-sparkles"></i> Limpiar Hechizo</div>
                    </div>
                </div>
                <button class="success" id="btnPublish" onclick="publishChanges()">üöÄ ENVIAR A LA WEB</button>
            </div>
        </div>

        <!-- Sidebar Historial -->
        <div id="historySidebar" class="sidebar-panel">
            <div class="sidebar-header">
                <h2 style="font-size: 18px; margin:0"><i class="fa-solid fa-bolt-lightning"></i> Magia Reciente</h2>
                <button onclick="toggleHistory()"
                    style="background:transparent; color:var(--apple-text); border:none; padding:10px; cursor:pointer"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>

            <div style="padding: 10px 24px; display: flex; gap: 10px; border-bottom: 1px solid var(--apple-border)">
                <button id="tabLog" class="secondary" onclick="showHistoryTab('log')"
                    style="flex:1; padding: 6px; font-size:11px">ACTIVIDAD</button>
                <button id="tabTrash" class="secondary" onclick="showHistoryTab('trash')"
                    style="flex:1; padding: 6px; font-size:11px">PAPELERA</button>
            </div>

            <div id="logContent" class="sidebar-content">
                <!-- Se llena din√°micamente -->
                <div style="text-align:center; padding-top:40px; opacity:0.5">Sin actividad reciente</div>
            </div>

            <div id="trashContent" class="sidebar-content" style="display:none">
                <!-- Se llena din√°micamente -->
                <div style="text-align:center; padding-top:40px; opacity:0.5">La papelera est√° vac√≠a</div>
            </div>
        </div>

        <!-- APP NAVIGATION -->
        <div class="app-nav">
            <div id="navCatalog" class="nav-tab active" onclick="switchView('catalog')">
                <i class="fa-solid fa-boxes-stacked"></i> GESTI√ìN DE CAT√ÅLOGO
            </div>
            <div id="navBrands" class="nav-tab" onclick="switchView('brands')">
                <i class="fa-solid fa-tags"></i> PERSONALIZACI√ìN DE MARCA
            </div>
            <div id="navConflicts" class="nav-tab" onclick="switchView('conflicts')" style="position:relative">
                <i class="fa-solid fa-triangle-exclamation"></i> RESOLUCI√ìN DE CONFLICTOS
                <span id="conflictBadge" class="nav-badge"
                    style="display:none; position:absolute; top:-5px; right:-5px; background:#ff3b30; color:white; font-size:9px; min-width:18px; height:18px; border-radius:50%; align-items:center; justify-content:center; font-weight:900; border:2px solid white;">0</span>
            </div>
            <div id="navSnapshots" class="nav-tab" onclick="switchView('snapshots')">
                <i class="fa-solid fa-clock-rotate-left"></i> HISTORIAL DE PUBLICACIONES
            </div>
            <div id="navIntelligence" class="nav-tab" onclick="switchView('intelligence')">
                <i class="fa-solid fa-magnifying-glass-chart"></i> INTELIGENCIA DE MERCADO
            </div>
        </div>

        <!-- VIEW 1: CATALOG MANAGEMENT -->
        <div id="viewCatalog" class="view-container active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(0, 113, 22, 0.1); color: var(--apple-blue);">
                        <i class="fa-solid fa-boxes-stacked"></i>
                    </div>
                    <div>
                        <div class="stat-value" id="statTotal">0</div>
                        <div class="stat-label">Total Productos</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(52, 199, 89, 0.1); color: #34c759;">
                        <i class="fa-solid fa-camera-retro"></i>
                    </div>
                    <div>
                        <div class="stat-value" id="statPhotos">0%</div>
                        <div class="stat-label">Calidad Visual</div>
                        <div class="stat-progress-bg">
                            <div class="stat-progress-bar" id="photoProgress" style="width: 0%; background: #34c759;">
                            </div>
                        </div>
                    </div>
                    <button onclick="fixNextPhoto()" class="secondary"
                        style="position:absolute; top:15px; right:15px; padding:4px 8px; font-size:10px; border-radius:10px;">Arreglar
                        Siguiente</button>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(255, 59, 48, 0.1); color: #ff3b30;">
                        <i class="fa-solid fa-cloud-arrow-up"></i>
                    </div>
                    <div>
                        <div class="stat-value" id="statPending">0</div>
                        <div class="stat-label">Por Publicar</div>
                    </div>
                    <div id="publishAlert" style="font-size:10px; color:#ff3b30; font-weight:700; display:none;">‚ö†Ô∏è
                        Requiere
                        actualizaci√≥n</div>
                    <div style="display: flex; gap: 8px; margin-top: 12px; flex-direction: column;">
                        <button onclick="setSort('pending', document.getElementById('chipPending'))" class="secondary"
                            style="background: rgba(0, 113, 227, 0.1); color: var(--apple-blue); border: 1px solid rgba(0, 113, 227, 0.2); padding: 4px 8px; border-radius: 6px; font-size: 10px; cursor: pointer; font-weight: 700;">
                            <i class="fa-solid fa-eye"></i> VER PENDIENTES
                        </button>
                        <button id="btnDeletePending" onclick="deletePendingProducts()"
                            style="display:none; background:rgba(255, 59, 48, 0.1); color:#ff3b30; border:1px solid rgba(255, 59, 48, 0.2); padding:4px 8px; border-radius:6px; font-size:9px; cursor:pointer; font-weight:700; width:100%;">
                            <i class="fa-solid fa-trash-can"></i> BORRAR PENDIENTES
                        </button>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(255, 159, 10, 0.1); color: #ff9f0a;">
                        <i class="fa-solid fa-tags"></i>
                    </div>
                    <div>
                        <div class="stat-value" id="statBrands">0</div>
                        <div class="stat-label">Marcas Activas</div>
                    </div>
                </div>
            </div>

            <!-- Brands View was here, moved out -->

            <div class="toolbar">
                <input type="text" id="search" placeholder="Buscar por nombre, ID o marca..." onkeyup="filterAndSort()"
                    style="width:300px">

                <div class="sort-chips">
                    <span class="chip active" onclick="setSort('recent', this)">√öltimos cargados</span>
                    <span id="chipPending" class="chip" onclick="setSort('pending', this)">Pendientes</span>
                    <span class="chip" onclick="setSort('alpha', this)">Alfab√©tico</span>
                    <span class="chip" onclick="setSort('category', this)">Por Categor√≠a</span>
                </div>

                <select id="filterBrand" onchange="filterAndSort()" style="margin-left: 10px; max-width: 150px;">
                    <option value="">Todas las marcas</option>
                </select>

                <div id="totalCount" style="margin-left:auto; font-size: 14px; font-weight: 600; opacity: 0.7;">
                    Cargando...
                </div>

                <div class="view-toggle">
                    <button id="viewTable" class="active" onclick="setView('table')" title="Vista Lista">
                        <i class="fa-solid fa-list-ul"></i>
                    </button>
                    <button id="viewGrid" onclick="setView('grid')" title="Vista Cuadr√≠cula">
                        <i class="fa-solid fa-table-cells"></i>
                    </button>
                </div>

                <div style="display:flex; gap:10px;">
                    <button class="secondary" onclick="exportData('xlsx')" title="Exportar Excel">
                        <i class="fa-solid fa-file-excel"></i>
                    </button>
                    <button class="secondary" onclick="exportData('pdf')" title="Exportar PDF/Imprimir">
                        <i class="fa-solid fa-print"></i>
                    </button>
                </div>
            </div>

            <div style="display:flex; gap:12px; margin-bottom: 24px;">
                <button class="secondary" onclick="openBulkModal()">
                    <i class="fa-solid fa-file-import"></i> Carga Masiva
                </button>
                <button onclick="newProduct()">+ Nuevo Producto</button>
            </div>

            <table id="productTable">
                <thead>
                    <tr>
                        <th>Foto</th>
                        <th>ID</th>
                        <th>Marca</th>
                        <th>Nombre</th>
                        <th>Categor√≠a</th>
                        <th>Fecha Alta</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <div id="productGrid" class="grid-container" style="display:none;"></div>

            <div id="pagination" class="pagination-container"></div>
        </div>

        <!-- VIEW 2: BRAND CUSTOMIZATION -->
        <div id="viewBrands" class="view-container">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(88, 86, 214, 0.1); color: #5856d6;">
                        <i class="fa-solid fa-fingerprint"></i>
                    </div>
                    <div>
                        <div class="stat-value" id="brandCount">0</div>
                        <div class="stat-label">Marcas Identificadas</div>
                    </div>
                </div>
                <div class="stat-card"
                    style="grid-column: span 3; border: 1px solid #34c75933; background: linear-gradient(135deg, rgba(52, 199, 89, 0.05) 0%, rgba(52, 199, 89, 0.02) 100%); flex-direction: row; align-items: center; justify-content: space-between; gap: 30px; padding: 30px;">
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <div class="stat-icon"
                            style="background: #34c759; color: white; flex-shrink: 0; width: 50px; height: 50px; font-size: 20px;">
                            <i class="fa-solid fa-earth-americas"></i>
                        </div>
                        <div>
                            <div class="stat-value" style="font-size: 20px; color: #1a1a1a;">Sincronizaci√≥n Web</div>
                            <div class="stat-label" style="font-size: 13px;">Env√≠a los ajustes de dise√±o a la p√°gina de
                                clientes para actualizar los Badges reales</div>
                        </div>
                    </div>
                    <button class="success" onclick="publishChanges()"
                        style="padding: 15px 30px; font-size: 14px; font-weight: 800; border-radius: 14px; box-shadow: 0 8px 20px rgba(52, 199, 89, 0.3); white-space: nowrap; flex-shrink: 0; cursor: pointer;">
                        <i class="fa-solid fa-rocket"></i> PUBLICAR DISE√ëOS AHORA
                    </button>
                </div>
            </div>

            <div class="admin-table-container" style="margin-top: 2rem;">
                <!-- Toolbar: search + sort -->
                <div style="display:flex; gap:12px; align-items:center; margin-bottom:16px; flex-wrap:wrap;">
                    <div style="position:relative; flex:1; min-width:200px;">
                        <i class="fa-solid fa-magnifying-glass"
                            style="position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#94a3b8; font-size:13px;"></i>
                        <input id="brandSearchInput" type="text" placeholder="Buscar marca‚Ä¶"
                            oninput="filterBrandsTable(this.value)"
                            style="width:100%; padding:10px 12px 10px 36px; border:1px solid #e2e8f0; border-radius:10px; font-size:13px; outline:none; box-sizing:border-box;">
                    </div>
                    <button id="brandSortBtn" onclick="toggleBrandSort()" class="secondary"
                        style="padding:10px 16px; font-size:12px; font-weight:700; display:flex; align-items:center; gap:6px; white-space:nowrap;">
                        <i class="fa-solid fa-arrow-down-a-z"></i> A ‚Üí Z
                    </button>
                </div>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Vista Previa (Badge)</th>
                            <th>Nombre de Marca</th>
                            <th>Personalizaci√≥n (Escala / Offset)</th>
                            <th>Vista Gestor (Admin)</th>
                        </tr>
                    </thead>
                    <tbody id="brandsTableBody">
                        <!-- JS fills this -->
                    </tbody>
                </table>
            </div>
        </div>


        <!-- VIEW: CONFLICT RESOLUTION -->
        <div id="viewConflicts" class="view-container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <div
                        style="background:#ff3b30; color:white; width:48px; height:48px; border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:24px;">
                        <i class="fa-solid fa-code-merge"></i>
                    </div>
                    <div>
                        <h2 style="margin:0; font-size:22px;">Control de Versiones y Conflictos</h2>
                        <p style="margin:0; opacity:0.6; font-size:14px;">Comparaci√≥n y archivado de cambios en
                            productos existentes</p>
                    </div>
                </div>
                <button class="secondary" onclick="loadConflicts()"><i class="fa-solid fa-rotate"></i>
                    REFRESCAR</button>
            </div>

            <div id="conflictsList" class="admin-grid"
                style="grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));">
                <div style="grid-column: 1/-1; text-align:center; padding:100px; opacity:0.3;">
                    <i class="fa-solid fa-check-double" style="font-size:48px; margin-bottom:20px;"></i>
                    <p>No hay conflictos de versi√≥n pendientes</p>
                </div>
            </div>
        </div>

        <!-- VIEW: SITE SNAPSHOTS & ROLLBACK -->
        <div id="viewSnapshots" class="view-container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <div
                        style="background:var(--apple-blue); color:white; width:48px; height:48px; border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:24px;">
                        <i class="fa-solid fa-clock-rotate-left"></i>
                    </div>
                    <div>
                        <h2 style="margin:0; font-size:22px;">Historial de Publicaciones</h2>
                        <p style="margin:0; opacity:0.6; font-size:14px;">Copia de seguridad autom√°tica de cada env√≠o a
                            la web</p>
                    </div>
                </div>
                <button class="secondary" onclick="loadSnapshots()"><i class="fa-solid fa-rotate"></i>
                    REFRESCAR</button>
            </div>

            <div id="snapshotsList" class="admin-table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Estado</th>
                            <th>Versi√≥n</th>
                            <th>Fecha y Hora</th>
                            <th>Descripci√≥n</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="snapshotsTableBody">
                        <!-- JS fills this -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- VIEW: SEARCH INTELLIGENCE -->
        <div id="viewIntelligence" class="view-container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <div
                        style="background:#5856d6; color:white; width:48px; height:48px; border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:24px;">
                        <i class="fa-solid fa-magnifying-glass-chart"></i>
                    </div>
                    <div>
                        <h2 style="margin:0; font-size:22px;">Inteligencia de Mercado</h2>
                        <p style="margin:0; opacity:0.6; font-size:14px;">An√°lisis de lo que buscan tus clientes en
                            tiempo real</p>
                    </div>
                </div>
                <button class="secondary" onclick="loadSearchIntelligence()"><i class="fa-solid fa-rotate"></i>
                    REFRESCAR</button>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
                <!-- Lost Opportunities Card -->
                <div class="admin-card" style="padding:24px; border-left: 5px solid #ff3b30;">
                    <h3 style="margin-top:0; color:#ff3b30;"><i class="fa-solid fa-triangle-exclamation"></i>
                        Oportunidades Perdidas</h3>
                    <p style="font-size:13px; opacity:0.6;">B√∫squedas frecuentes que arrojaron 0 resultados.
                        Considera a√±adir estos productos.</p>
                    <div id="lostOpportunitiesList" style="margin-top:20px;">
                        <!-- JS fills this -->
                    </div>
                </div>

                <!-- Top Searches Card -->
                <div class="admin-card" style="padding:24px; border-left: 5px solid var(--apple-blue);">
                    <h3 style="margin-top:0; color:var(--apple-blue);"><i class="fa-solid fa-chart-line"></i> Top
                        B√∫squedas</h3>
                    <p style="font-size:13px; opacity:0.6;">Lo que m√°s le interesa a tus clientes actualmente.</p>
                    <div id="topSearchesList" style="margin-top:20px;">
                        <!-- JS fills this -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Conflict Editor Modal -->
    <div id="conflictEditorModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0;">Manual de Resoluci√≥n: <span id="ce_id_title"></span></h2>
                <span class="close" onclick="closeConflictEditor()">&times;</span>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
                <!-- EDITABLE SIDE -->
                <div
                    style="background:rgba(0,113,227,0.03); padding:20px; border-radius:16px; border:1px solid rgba(0,113,227,0.1);">
                    <h4
                        style="color:var(--apple-blue); margin-top:0; margin-bottom:15px; font-size:12px; font-weight:800; letter-spacing:0.05em;">
                        DATO ACTUAL (EDITABLE)</h4>

                    <div style="margin-bottom:15px;">
                        <label
                            style="font-size:11px; font-weight:700; opacity:0.6; display:block; margin-bottom:5px;">NOMBRE
                            DEL PRODUCTO</label>
                        <input type="text" id="ce_name" style="width:100%; font-size:13px;">
                    </div>

                    <div style="margin-bottom:15px;">
                        <label
                            style="font-size:11px; font-weight:700; opacity:0.6; display:block; margin-bottom:5px;">DESCRIPCI√ìN
                            T√âCNICA</label>
                        <textarea id="ce_desc" rows="8"
                            style="width:100%; font-size:12px; line-height:1.5; padding:10px; border-radius:12px; border:1px solid var(--apple-border); background:var(--input-bg); color:var(--apple-text); resize:none;"></textarea>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div>
                            <label
                                style="font-size:11px; font-weight:700; opacity:0.6; display:block; margin-bottom:5px;">MARCA</label>
                            <input type="text" id="ce_brand" style="width:100%; font-size:13px;">
                        </div>
                        <div>
                            <label
                                style="font-size:11px; font-weight:700; opacity:0.6; display:block; margin-bottom:5px;">CATEGOR√çA</label>
                            <select id="ce_cat" style="width:100%; font-size:13px;">
                                <option value="toner">T√≥ners</option>
                                <option value="papeleria">Papeler√≠a</option>
                                <option value="accesorios">Accesorios</option>
                            </select>
                        </div>
                    </div>

                    <div style="margin-top:15px;">
                        <label
                            style="font-size:11px; font-weight:700; opacity:0.6; display:block; margin-bottom:5px;">COMPATIBILIDAD</label>
                        <input type="text" id="ce_comp" style="width:100%; font-size:13px;">
                    </div>
                </div>

                <!-- REFERENCE SIDE -->
                <div style="background:rgba(0,0,0,0.03); padding:20px; border-radius:16px; border:1px dashed #ddd;">
                    <h4
                        style="color:#666; margin-top:0; margin-bottom:15px; font-size:12px; font-weight:800; letter-spacing:0.05em;">
                        DATO ENTRANTE (CSV)</h4>

                    <div style="margin-bottom:15px;">
                        <label
                            style="font-size:11px; font-weight:700; opacity:0.6; display:block; margin-bottom:5px;">NOMBRE
                            SUGERIDO</label>
                        <div id="ce_ref_name"
                            style="font-size:13px; font-weight:600; background:white; padding:10px; border-radius:10px; border:1px solid #eee;">
                        </div>
                    </div>

                    <div style="margin-bottom:15px;">
                        <label
                            style="font-size:11px; font-weight:700; opacity:0.6; display:block; margin-bottom:5px;">DESCRIPCI√ìN
                            SUGERIDA</label>
                        <div id="ce_ref_desc"
                            style="font-size:12px; line-height:1.5; background:white; padding:10px; border-radius:10px; border:1px solid #eee; height:152px; overflow-y:auto;">
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div>
                            <label
                                style="font-size:11px; font-weight:700; opacity:0.6; display:block; margin-bottom:5px;">MARCA
                                CSV</label>
                            <div id="ce_ref_brand"
                                style="font-size:13px; font-weight:600; background:white; padding:10px; border-radius:10px; border:1px solid #eee;">
                            </div>
                        </div>
                        <div>
                            <label
                                style="font-size:11px; font-weight:700; opacity:0.6; display:block; margin-bottom:5px;">CAT
                                CSV</label>
                            <div id="ce_ref_cat"
                                style="font-size:13px; font-weight:600; background:white; padding:10px; border-radius:10px; border:1px solid #eee;">
                            </div>
                        </div>
                    </div>

                    <div style="margin-top:15px;">
                        <label
                            style="font-size:11px; font-weight:700; opacity:0.6; display:block; margin-bottom:5px;">COMPATIBILIDAD
                            CSV</label>
                        <div id="ce_ref_comp"
                            style="font-size:13px; font-weight:600; background:white; padding:10px; border-radius:10px; border:1px solid #eee;">
                        </div>
                    </div>

                    <div
                        style="margin-top:20px; padding:10px; background:#fff9e6; border-radius:10px; border:1px solid #ffeeba; font-size:10px; color:#856404;">
                        <i class="fa-solid fa-circle-info"></i> Puedes copiar del bloque derecho y pegar en el
                        izquierdo
                        para fusionar los datos como prefieras.
                    </div>
                </div>
            </div>

            <div style="margin-top:30px; display:flex; gap:12px; justify-content:flex-end;">
                <button class="secondary" onclick="closeConflictEditor()"><i class="fa-solid fa-xmark"></i>
                    DESCARTAR</button>
                <button class="primary" id="btnSaveCE" onclick="saveConflictEdits()"><i class="fa-solid fa-check"></i>
                    GUARDAR Y RESOLVER</button>
            </div>
        </div>
    </div>


    <!-- Modal Form -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Nuevo Producto</h2>

            <div style="position:relative;">
                <div id="dropZone" class="drop-zone" onclick="document.getElementById('fileInput').click()">
                    <p id="dropText">üìÅ Arrastra o selecciona la foto</p>
                </div>
                <button type="button" onclick="openWizardFromEditor()"
                    style="position:absolute; top:10px; right:10px; background:var(--apple-blue); color:white; width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; border:2px solid white; box-shadow:0 4px 12px rgba(0,0,0,0.2); z-index: 1;"
                    title="Buscar mejor imagen en Google">
                    <i class="fa-solid fa-wand-magic-sparkles"></i>
                </button>
            </div>
            <input type="file" id="fileInput" style="display:none" onchange="handleFileUpload(this.files[0])">
            <input type="hidden" id="p_image">

            <label>Nombre del Producto (Sin Marca)</label><br>
            <input type="text" id="p_name" placeholder="Ej. Cartucho 12A Negro" style="width:100%"><br><br>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div>
                    <label>ID / Modelo</label><br>
                    <input type="text" id="p_id" style="width:100%">
                </div>
                <div>
                    <label>Categor√≠a Web</label><br>
                    <select id="p_category" style="width:100%">
                        <option value="toner">TONERS</option>
                        <option value="papeleria">PAPELER√çA</option>
                        <option value="accesorios">ACCESORIOS</option>
                    </select>
                </div>
            </div>

            <br>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div>
                    <label>Marca</label><br>
                    <div style="display:flex; gap:5px;">
                        <select id="p_brand" style="flex-grow:1"></select>
                        <button type="button" onclick="addNewBrand()" style="padding:5px 10px; background:#6c757d;"
                            title="A√±adir nueva marca">+</button>
                        <button type="button" onclick="openBrandWizardFromEditor()"
                            style="padding:5px 10px; background:#ff2d55; color:white; border-radius: 12px; border:none; display:flex; align-items:center; justify-content:center;"
                            title="Buscar logo de esta marca">
                            <i class="fa-solid fa-wand-magic-sparkles"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <label>Compatibilidad</label><br>
                    <input type="text" id="p_compatibility" placeholder="Ej. M15w, P1102" style="width:100%">
                </div>
            </div>

            <br>
            <label>Descripci√≥n</label><br>
            <textarea id="p_description" placeholder="Descripci√≥n detallada del producto..."
                style="width:100%; height:80px; padding:10px; border-radius:12px; border:1px solid var(--apple-border); background:var(--input-bg); color:var(--apple-text); font-family:inherit; resize: none;"></textarea>

            <div style="display:flex; justify-content:space-between; margin-top:20px;">
                <button class="secondary" onclick="closeModal()">Cancelar</button>
                <button onclick="saveProduct()">üíæ Guardar Producto</button>
            </div>
        </div>
    </div>

    <!-- Modal Masivo -->
    <div id="bulkModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top:0">Carga Masiva Apple-style Ô£ø</h2>
            <p style="color:var(--apple-subtext); font-size:14px">Sube un CSV y las im√°genes (el nombre del archivo
                debe
                ser el ID del producto).</p>

            <div style="margin-bottom:20px">
                <label style="display:block; margin-bottom:8px; font-weight:600">1. Archivo CSV</label>
                <input type="file" id="bulkCSV" accept=".csv" style="width:100%">
            </div>

            <div style="margin-bottom:20px">
                <label style="display:block; margin-bottom:8px; font-weight:600">2. Carpeta de Im√°genes</label>
                <input type="file" id="bulkImages" multiple accept="image/*" style="width:100%">
            </div>

            <div id="bulkProgress" style="display:none; margin-bottom:20px">
                <div style="height:6px; background:var(--apple-bg); border-radius:10px; overflow:hidden">
                    <div id="progressBar" style="height:100%; background:var(--apple-blue); width:0%"></div>
                </div>
                <p id="progressText" style="font-size:12px; margin-top:5px; text-align:center"></p>
            </div>

            <div style="display:flex; justify-content:space-between; margin-top:30px;">
                <button class="secondary" onclick="closeBulkModal()">Cancelar</button>
                <button onclick="processBulk()" id="btnProcessBulk">Iniciar Carga</button>
            </div>
        </div>
    </div>

    <!-- Modal de Conflictos en Carga Masiva -->
    <div id="bulkConflictModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 style="margin-top:0">Conflictos Detectados Ô£ø</h2>
            <p style="color:var(--apple-subtext); font-size:14px">
                Se han encontrado productos que ya existen en el cat√°logo. ¬øC√≥mo deseas proceder?
            </p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                <div
                    style="background: rgba(52, 199, 89, 0.05); padding: 15px; border-radius: 12px; border: 1px solid rgba(52, 199, 89, 0.1);">
                    <h3 style="margin:0; font-size:14px; color:#34c759;"><i class="fa-solid fa-plus-circle"></i>
                        NUEVOS
                    </h3>
                    <p id="newItemsCount" style="font-size:24px; font-weight:700; margin:5px 0;">0</p>
                    <div id="newItemsList"
                        style="font-size:11px; max-height:100px; overflow-y:auto; color:var(--apple-subtext);">
                    </div>
                </div>
                <div
                    style="background: rgba(255, 59, 48, 0.05); padding: 15px; border-radius: 12px; border: 1px solid rgba(255, 59, 48, 0.1);">
                    <h3 style="margin:0; font-size:14px; color:#ff3b30;"><i
                            class="fa-solid fa-triangle-exclamation"></i> EXISTENTES</h3>
                    <p id="conflictItemsCount" style="font-size:24px; font-weight:700; margin:5px 0;">0</p>
                    <div id="conflictItemsList"
                        style="font-size:11px; max-height:100px; overflow-y:auto; color:var(--apple-subtext);">
                    </div>
                </div>
            </div>

            <div style="display:flex; flex-direction:column; gap:10px; margin-top:30px;">
                <button onclick="executeBulkImport(true)"
                    style="width:100%; justify-content:center; background:var(--apple-blue); color:white;">
                    üöÄ SOBRESCRIBIR TODO EL CAT√ÅLOGO
                </button>
                <button onclick="executeBulkImport(false, true)" class="secondary"
                    style="width:100%; justify-content:center; background:#ff9f0a; color:white; border:none;">
                    <i class="fa-solid fa-code-branch"></i> ARCHIVAR Y REVISAR DESPU√âS
                </button>
                <button onclick="executeBulkImport(false)" class="secondary"
                    style="width:100%; justify-content:center;">‚úÖ SOLO CARGAR NUEVOS</button>
                <button class="secondary" onclick="document.getElementById('bulkConflictModal').style.display='none'"
                    style="width:100%; justify-content:center; border:none; opacity:0.5;">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Image Wizard Modal -->
    <div id="imageWizardModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                <div id="wizardIcon"
                    style="background: var(--apple-blue); color: white; width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <i class="fa-solid fa-wand-magic-sparkles" style="font-size: 20px;"></i>
                </div>
                <div>
                    <h2 id="wizardTitle" style="margin:0; font-size: 18px;">Asistente Inteligente</h2>
                    <p id="wizardProductTitle" style="margin:0; font-size: 13px; color: var(--apple-subtext);"></p>
                </div>
            </div>

            <div
                style="background: rgba(0, 113, 227, 0.05); padding: 18px; border-radius: 16px; border: 1px solid rgba(0, 113, 227, 0.1); margin-bottom: 20px;">
                <p style="margin-top:0; font-size: 14px; font-weight: 600; display:flex; align-items:center; gap:8px;">
                    <span
                        style="background:var(--apple-blue); color:white; width:20px; height:20px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:10px;">1</span>
                    Busca la imagen
                </p>
                <button id="btnWizardSearch" onclick=""
                    style="width: 100%; justify-content: center; background: #4285f4; margin-bottom: 10px; border-radius: 12px; height: 45px;">
                    <i class="fa-brands fa-google"></i> Buscar en Google
                </button>
                <p style="font-size: 12px; color: var(--apple-subtext); margin: 0; line-height: 1.4;">
                    Haz clic derecho en la imagen que te guste y selecciona <br><b>"Copiar direcci√≥n de imagen"</b>.
                </p>
            </div>

            <div style="margin-bottom: 20px;">
                <p style="margin-top:0; font-size: 14px; font-weight: 600; display:flex; align-items:center; gap:8px;">
                    <span
                        style="background:var(--apple-blue); color:white; width:20px; height:20px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:10px;">2</span>
                    Pega el enlace aqu√≠
                </p>
                <input type="text" id="wizardImageUrl" placeholder="Pega el link aqu√≠ (ej. https://.../foto.jpg)"
                    style="width: 100%; margin-bottom: 12px; height: 45px;">
                <button id="btnImportImage" onclick="importWizardImage()"
                    style="width: 100%; justify-content: center; height: 45px; border-radius: 12px;">
                    <i class="fa-solid fa-cloud-arrow-down"></i> Procesar y Guardar
                </button>
            </div>

            <div id="wizardStatus"
                style="display:none; text-align: center; padding: 15px; background: rgba(0,0,0,0.03); border-radius: 12px; margin-bottom: 15px;">
                <i class="fa-solid fa-circle-notch fa-spin" style="color:var(--apple-blue);"></i>
                <p id="wizardStatusText" style="font-size: 13px; margin-top: 8px; font-weight: 500;"></p>
            </div>

            <div style="display:flex; justify-content:center;">
                <button class="secondary" onclick="document.getElementById('imageWizardModal').style.display='none'"
                    style="background:none; border:none; color:var(--apple-subtext);">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Zoom Overlay (Restored) -->
    <div id="zoomOverlay" onclick="this.style.display='none'"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; align-items:center; justify-content:center; cursor:zoom-out;">
        <img id="zoomedImg"
            style="max-width:90%; max-height:90%; border-radius:12px; box-shadow:0 0 50px rgba(0,0,0,0.5);">
    </div>

    <!-- Spotlight Search Overlay -->
    <div id="spotlightOverlay" onclick="if(event.target === this) closeSpotlight()">
        <div class="spotlight-box">
            <div class="spotlight-input-container">
                <i class="fa-solid fa-magnifying-glass" style="color: var(--apple-blue); font-size: 18px;"></i>
                <input type="text" id="spotlightInput" placeholder="¬øQu√© quieres hacer?" autocomplete="off"
                    onkeydown="handleSpotlightKey(event)" oninput="searchSpotlight()">
            </div>
            <div id="spotlightResults" class="spotlight-results">
                <!-- Results populated by JS -->
            </div>
            <div class="spotlight-hint">
                <span><kbd>‚Üë‚Üì</kbd> Navegar</span>
                <span><kbd>Enter</kbd> Seleccionar</span>
                <span><kbd>Esc</kbd> Cerrar</span>
            </div>
        </div>
    </div>

    <!-- Overlay de Login -->
    <div id="loginOverlay"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); backdrop-filter:blur(20px); z-index:99999; justify-content:center; align-items:center;">
        <div class="modal-content" style="width:400px; text-align:center;">
            <img src="/assets/images/LOGO SIN TEXTO.png" height="80" style="margin-bottom:20px;">
            <h2 style="margin-bottom:10px;">Acceso Protegido</h2>
            <p style="opacity:0.7; font-size:14px; margin-bottom:20px;">El panel de administraci√≥n est√° bloqueado.
                Por
                favor, introduce la contrase√±a.</p>
            <input type="password" id="adminPassword" placeholder="Contrase√±a de administrador"
                style="width:100%; margin-bottom:20px; text-align:center; font-size:18px;">
            <button id="btnLogin" style="width:100%; justify-content:center; padding:15px; font-size:16px;">
                <i class="fa-solid fa-lock-open"></i> DESBLOQUEAR PANEL
            </button>
            <div id="loginError" style="color:var(--apple-red); font-size:12px; margin-top:15px; display:none;">
                Contrase√±a incorrecta. Int√©ntalo de nuevo.</div>
        </div>
    </div>

    <script src="/assets/js/admin-logic.js" defer></script>
</body>

</html>