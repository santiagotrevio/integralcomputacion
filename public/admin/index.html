<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Catálogo Pro | Integral</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Inter:wght@400;500;600;700&family=Cinzel+Decorative:wght@400;700;900&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --apple-bg: #f5f5f7;
            --apple-card: rgba(255, 255, 255, 0.8);
            --apple-text: #1d1d1f;
            --apple-subtext: #86868b;
            --apple-blue: #0071e3;
            --apple-red: #ff3b30;
            --apple-green: #34c759;
            --apple-border: rgba(0, 0, 0, 0.08);
            --glass-blur: blur(25px) saturate(180%);
            --modal-bg: #ffffff;
            --input-bg: #ffffff;
            --card-shadow: 0 12px 40px rgba(0, 0, 0, 0.04);
        }

        [data-theme="dark"] {
            --apple-bg: #000000;
            --apple-card: rgba(28, 28, 30, 0.7);
            --apple-text: #f5f5f7;
            --apple-subtext: #a1a1a6;
            --apple-blue: #0A84FF;
            --apple-red: #ff453a;
            --apple-green: #32d74b;
            --apple-border: rgba(255, 255, 255, 0.15);
            --modal-bg: #1c1c1e;
            --input-bg: #2c2c2e;
            --card-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        [data-theme="fallout"] {
            --apple-bg: #030a03;
            --apple-card: rgba(0, 20, 0, 0.85);
            --apple-text: #18ff62;
            --apple-subtext: #0b9e3b;
            --apple-blue: #18ff62;
            --apple-red: #ff3b30;
            --apple-green: #18ff62;
            --apple-border: rgba(24, 255, 98, 0.2);
            --glass-blur: blur(8px) saturate(120%);
            --modal-bg: #030a03;
            --input-bg: #001100;
            --card-shadow: 0 0 20px rgba(24, 255, 98, 0.2);
            --brand-bg: rgba(0, 20, 0, 0.9);
            --brand-border: rgba(24, 255, 98, 0.3);
        }

        [data-theme="fallout"] body,
        [data-theme="fallout"] *:not(.fa):not(.fas):not(.far):not(.fab):not(.fa-solid):not(.fa-regular):not(.fa-thin):not(.fa-duotone):not(i) {
            font-family: 'Courier New', Courier, monospace !important;
            text-shadow: 0 0 8px rgba(24, 255, 98, 0.8);
        }

        [data-theme="fallout"] .container {
            border: 2px solid var(--apple-blue);
            box-shadow: 0 0 30px rgba(24, 255, 98, 0.15);
        }

        [data-theme="fallout"]::before {
            content: " ";
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%),
                linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            z-index: 9999;
            background-size: 100% 4px, 3px 100%;
            pointer-events: none;
            opacity: 0.3;
        }

        [data-theme="fallout"] .main-logo {
            filter: brightness(0) invert(1) sepia(1) saturate(5000%) hue-rotate(100deg) brightness(1.2) drop-shadow(0 0 12px #18ff62) !important;
        }

        [data-theme="fallout"] .date-cell {
            color: #18ff62 !important;
            opacity: 0.8;
            font-weight: bold;
        }

        [data-theme="fallout"] .brand-container {
            background: var(--brand-bg) !important;
            border-color: var(--brand-border) !important;
        }

        [data-theme="fallout"] .brand-container img {
            filter: brightness(0) invert(1) sepia(1) saturate(3000%) hue-rotate(100deg) brightness(1.2);
        }

        [data-theme="fallout"] #totalCount {
            background: rgba(24, 255, 98, 0.1) !important;
            color: #18ff62 !important;
            border: 1px solid rgba(24, 255, 98, 0.3) !important;
            text-shadow: 0 0 5px #18ff62;
        }

        [data-theme="fallout"] th {
            color: #18ff62;
            border-bottom: 2px solid #18ff62;
            text-transform: uppercase;
            font-weight: 800;
        }

        [data-theme="fallout"] input,
        [data-theme="fallout"] select {
            border: 1px solid #18ff62 !important;
            background: #001100 !important;
            color: #18ff62 !important;
        }

        /* --- TEMA CYBERPUNK 2077 --- */
        [data-theme="cyberpunk"] {
            --apple-bg: #050510;
            --apple-card: rgba(10, 10, 25, 0.9);
            --apple-text: #f3e600;
            --apple-subtext: #00f0ff;
            --apple-blue: #00f0ff;
            --apple-red: #ff003c;
            --apple-green: #39ff14;
            --apple-border: rgba(243, 230, 0, 0.3);
            --glass-blur: blur(10px);
            --modal-bg: #050510;
            --input-bg: #000000;
            --card-shadow: 0 0 15px rgba(243, 230, 0, 0.2);
            font-family: 'Share Tech Mono', monospace !important;
        }

        [data-theme="cyberpunk"] *:not(i):not([class*="fa-"]) {
            font-family: 'Share Tech Mono', monospace !important;
        }

        [data-theme="cyberpunk"] body {
            background-image:
                radial-gradient(circle at 50% 50%, rgba(255, 0, 60, 0.1) 0%, transparent 50%),
                linear-gradient(rgba(5, 5, 16, 0.95), rgba(5, 5, 16, 0.95)),
                repeating-linear-gradient(0deg, rgba(0, 240, 255, 0.05) 0px, rgba(0, 240, 255, 0.05) 1px, transparent 1px, transparent 2px);
            background-size: 100% 100%, 100% 100%, 100% 3px;
            overflow-x: hidden;
        }

        [data-theme="cyberpunk"] .container {
            border: 2px solid #f3e600;
            box-shadow: 0 0 20px #f3e60044, inset 0 0 20px #f3e60022;
        }

        [data-theme="cyberpunk"] img {
            border: 1px solid rgba(0, 240, 255, 0.3);
            filter: saturate(1.2) brightness(1.1) !important;
        }

        [data-theme="cyberpunk"] .main-logo {
            filter: brightness(0) saturate(100%) invert(88%) sepia(21%) saturate(7406%) hue-rotate(3deg) brightness(105%) contrast(105%) drop-shadow(0 0 10px #f3e600) !important;
            animation: cyber-glitch-img 5s infinite;
        }

        [data-theme="cyberpunk"] .brand-container img,
        [data-theme="cyberpunk"] .card-brand img {
            display: none !important;
        }

        [data-theme="cyberpunk"] .brand-container,
        [data-theme="cyberpunk"] .card-brand {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }

        [data-theme="cyberpunk"] .brand-container::after,
        [data-theme="cyberpunk"] .card-brand::after {
            content: "[" attr(data-brand) "]";
            color: #00f0ff;
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 0 8px #00f0ff88;
        }

        [data-theme="cyberpunk"]::before {
            content: " ";
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.2) 50%),
                linear-gradient(90deg, rgba(255, 0, 0, 0.05), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.05));
            z-index: 10001;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            opacity: 0.4;
            animation: cyber-flicker 0.15s infinite;
        }

        [data-theme="cyberpunk"]::after {
            content: " ";
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: linear-gradient(0deg, transparent 0%, rgba(0, 240, 255, 0.1) 50%, transparent 100%);
            z-index: 10002;
            pointer-events: none;
            animation: cyber-scanline 8s linear infinite;
        }

        @keyframes cyber-scanline {
            0% {
                transform: translateY(-100%);
            }

            100% {
                transform: translateY(100%);
            }
        }

        @keyframes cyber-flicker {
            0% {
                opacity: 0.35;
            }

            50% {
                opacity: 0.4;
            }

            100% {
                opacity: 0.37;
            }
        }

        @keyframes glitch-text {
            0% {
                text-shadow: 2px 0 #f3e600, -2px 0 #00f0ff;
                transform: translate(0);
            }

            20% {
                text-shadow: -2px 0 #f3e600, 2px 0 #00f0ff;
                transform: translate(-2px, 1px);
            }

            40% {
                text-shadow: 2px 0 #f3e600, -2px 0 #00f0ff;
                transform: translate(2px, -1px);
            }

            60% {
                text-shadow: -2px 0 #f3e600, 2px 0 #00f0ff;
                transform: translate(-1px, 2px);
            }

            80% {
                text-shadow: 2px 0 #f3e600, -2px 0 #00f0ff;
                transform: translate(1px, -2px);
            }

            100% {
                text-shadow: -2px 0 #f3e600, 2px 0 #00f0ff;
                transform: translate(0);
            }
        }

        [data-theme="cyberpunk"] .stat-card {
            border-left: 4px solid #ff003c;
            background: rgba(255, 0, 60, 0.08) !important;
            clip-path: polygon(0 0, 100% 0, 100% 85%, 92% 100%, 0 100%);
            transition: transform 0.1s;
        }

        [data-theme="cyberpunk"] .stat-card:hover {
            transform: skewX(-2deg);
            background: rgba(255, 0, 60, 0.15) !important;
        }

        [data-theme="cyberpunk"] .stat-value {
            color: #f3e600;
            text-shadow: 0 0 10px #f3e600aa;
            animation: glitch-text 3s infinite;
        }

        [data-theme="cyberpunk"] th {
            color: #00f0ff;
            text-transform: uppercase;
            letter-spacing: 3px;
            background: rgba(0, 240, 255, 0.05);
            border-bottom: 2px solid #ff003c;
        }

        [data-theme="cyberpunk"] td {
            border-bottom: 1px solid rgba(0, 240, 255, 0.1) !important;
        }

        [data-theme="cyberpunk"] .secondary {
            background: rgba(0, 240, 255, 0.05) !important;
            border: 1px solid #00f0ff !important;
            color: #00f0ff !important;
        }

        /* Botón Enviar a la Web - Estilo Transparente Amarillo */
        [data-theme="cyberpunk"] #btnPublish {
            background: transparent !important;
            border: 2px solid #f3e600 !important;
            color: #f3e600 !important;
            text-shadow: 0 0 8px #f3e600aa;
            box-shadow: 0 0 10px rgba(243, 230, 0, 0.2);
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            font-weight: 900;
            letter-spacing: 1px;
        }

        [data-theme="cyberpunk"] button:not(#btnPublish) {
            clip-path: polygon(5% 0, 100% 0, 100% 80%, 95% 100%, 0 100%, 0 20%);
        }

        [data-theme="cyberpunk"] button i {
            color: #00f0ff;
            filter: drop-shadow(0 0 3px #00f0ff);
        }

        @keyframes cyber-glitch-img {

            0%,
            90%,
            100% {
                transform: none;
                filter: brightness(0) saturate(100%) invert(88%) sepia(21%) saturate(7406%) hue-rotate(3deg) brightness(105%) contrast(105%) drop-shadow(0 0 8px #f3e600);
            }

            92% {
                transform: skew(10deg);
                filter: hue-rotate(90deg) saturate(2) brightness(1.5);
            }

            94% {
                transform: translate(-5px, 2px);
                filter: invert(1) drop-shadow(0 0 5px #f3e600);
            }

            96% {
                transform: scale(1.1);
                filter: drop-shadow(5px 0 #ff003c) drop-shadow(-5px 0 #00f0ff);
            }
        }

        [data-theme="cyberpunk"] input,
        [data-theme="cyberpunk"] select {
            border: 1px solid #00f0ff !important;
            background: #000 !important;
            color: #f3e600 !important;
            clip-path: polygon(0 0, 95% 0, 100% 20%, 100% 100%, 5% 100%, 0 80%);
            border-radius: 0;
        }

        .no-image-placeholder {
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--apple-subtext);
            font-size: 8px;
            font-weight: 700;
            border-radius: 8px;
            gap: 4px;
            border: 1px dashed var(--apple-border);
        }

        .no-image-placeholder i {
            font-size: 16px;
            margin-bottom: 2px;
        }

        [data-theme="cyberpunk"] .no-image-placeholder {
            background: rgba(255, 0, 0, 0.1);
            color: #ff0000;
            border: 1px dashed #ff0000;
            text-shadow: 0 0 5px #ff0000;
        }

        [data-theme="fallout"] .no-image-placeholder {
            background: rgba(24, 255, 98, 0.1);
            color: #18ff62;
            border: 1px dashed #18ff62;
        }

        /* --- TEMAS HARRY POTTER (VISUAL REFINED) --- */
        [data-theme^="hp-"] .main-logo {
            filter: brightness(0) invert(1) opacity(0.9) drop-shadow(0 0 5px rgba(255, 255, 255, 0.2)) !important;
        }

        /* Logo Amarillo específico para Gryffindor */
        [data-theme="hp-gryffindor"] .main-logo {
            filter: brightness(0) saturate(100%) invert(88%) sepia(21%) saturate(7406%) hue-rotate(3deg) brightness(105%) contrast(105%) drop-shadow(0 0 8px rgba(255, 223, 0, 0.4)) !important;
        }

        [data-theme^="hp-"] *:not(i) {
            font-family: 'Cinzel Decorative', cursive !important;
        }

        /* Gryffindor - León (Escarlata y Oro Profundo) */
        [data-theme="hp-gryffindor"] {
            --apple-bg: #1a0202;
            --apple-card: rgba(122, 2, 2, 0.2);
            --apple-text: #ffdf00;
            --apple-subtext: #c5a000;
            --apple-border: #5e0505;
            --apple-blue: #ffdf00;
            --apple-red: #ff4d4d;
            background-image: url('https://www.transparenttextures.com/patterns/velvet.png');
        }

        [data-theme="hp-gryffindor"] .stat-card {
            background: rgba(80, 2, 2, 0.5) !important;
            border: 1px solid #ffdf0066;
            box-shadow: 0 0 20px rgba(255, 223, 0, 0.1);
        }

        [data-theme="hp-gryffindor"] .stat-icon {
            color: #ffdf00 !important;
        }

        [data-theme="hp-gryffindor"] #btnDeletePending,
        [data-theme="hp-gryffindor"] .fa-trash-can {
            color: #ffdf00 !important;
            border-color: #ffdf00 !important;
        }

        /* Botones y chips estilo "Carga Masiva" para Gryffindor */
        [data-theme="hp-gryffindor"] button,
        [data-theme="hp-gryffindor"] .chip.active {
            background: rgba(42, 5, 5, 0.7) !important;
            border: 1px solid #ffdf0088 !important;
            color: #ffdf00 !important;
            box-shadow: 0 0 10px rgba(255, 223, 0, 0.1) !important;
            text-shadow: 0 0 5px rgba(255, 223, 0, 0.3);
            transition: 0.3s;
        }

        [data-theme="hp-gryffindor"] button:hover,
        [data-theme="hp-gryffindor"] .chip.active:hover {
            background: rgba(116, 0, 1, 0.4) !important;
            box-shadow: 0 0 15px rgba(255, 223, 0, 0.2) !important;
        }

        /* Slytherin - Serpiente (Esmeralda y Plata) */
        [data-theme="hp-slytherin"] {
            --apple-bg: #020a05;
            --apple-card: rgba(2, 48, 20, 0.25);
            --apple-text: #cfd8dc;
            --apple-subtext: #2e7d32;
            --apple-border: #1b5e20;
            --apple-blue: #4caf50;
            --apple-red: #81c784;
            background-image: url('https://www.transparenttextures.com/patterns/stone-wall.png');
        }

        [data-theme="hp-slytherin"] .stat-card {
            background: rgba(2, 40, 15, 0.5) !important;
            border: 1px solid #4caf5044;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.1);
        }

        [data-theme="hp-slytherin"] .stat-icon {
            color: #81c784 !important;
        }

        [data-theme="hp-slytherin"] #btnDeletePending,
        [data-theme="hp-slytherin"] .fa-trash-can {
            color: #81c784 !important;
            border-color: #81c784 !important;
        }

        /* Ravenclaw - Águila (Zafiro y Bronce) */
        [data-theme="hp-ravenclaw"] {
            --apple-bg: #020512;
            --apple-card: rgba(14, 26, 64, 0.3);
            --apple-text: #e3f2fd;
            --apple-subtext: #64b5f6;
            --apple-border: #1a237e;
            --apple-blue: #42a5f5;
            --apple-red: #90caf9;
            background-image: url('https://www.transparenttextures.com/patterns/stardust.png');
        }

        [data-theme="hp-ravenclaw"] .stat-card {
            background: rgba(14, 26, 64, 0.5) !important;
            border: 1px solid #42a5f544;
            box-shadow: 0 0 20px rgba(66, 165, 245, 0.1);
        }

        [data-theme="hp-ravenclaw"] .stat-icon {
            color: #94abff !important;
        }

        [data-theme="hp-ravenclaw"] #btnDeletePending,
        [data-theme="hp-ravenclaw"] .fa-trash-can {
            color: #94abff !important;
            border-color: #94abff !important;
        }

        /* Hufflepuff - Tejón (Carbono y Ámbar) */
        [data-theme="hp-hufflepuff"] {
            --apple-bg: #0a0905;
            --apple-card: rgba(43, 38, 15, 0.4);
            --apple-text: #ffc107;
            --apple-subtext: #ffa000;
            --apple-border: #3d350f;
            --apple-blue: #ffc107;
            --apple-red: #ffd54f;
            background-image: url('https://www.transparenttextures.com/patterns/wood-grain.png');
        }

        [data-theme="hp-hufflepuff"] .stat-card {
            background: rgba(38, 34, 15, 0.6) !important;
            border: 1px solid #ffc10755;
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.1);
        }

        [data-theme="hp-hufflepuff"] .stat-icon,
        [data-theme="hp-hufflepuff"] .stat-value {
            color: #ffc107 !important;
            text-shadow: 0 0 10px rgba(255, 193, 7, 0.3);
        }

        [data-theme="hp-hufflepuff"] #btnDeletePending,
        [data-theme="hp-hufflepuff"] .fa-trash-can {
            color: #ffa000 !important;
            border-color: #ffa000 !important;
        }

        /* Botones y chips estilo "Carga Masiva" para Hufflepuff */
        [data-theme="hp-hufflepuff"] button,
        [data-theme="hp-hufflepuff"] .chip.active {
            background: rgba(20, 18, 10, 0.7) !important;
            border: 1px solid #ffc10766 !important;
            color: #ffc107 !important;
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.1) !important;
            text-shadow: 0 0 5px rgba(255, 193, 7, 0.3);
        }

        [data-theme="hp-hufflepuff"] button:hover,
        [data-theme="hp-hufflepuff"] .chip.active:hover {
            background: rgba(61, 53, 15, 0.4) !important;
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.2) !important;
        }

        /* Estilos Generales HP */
        [data-theme^="hp-"] .container {
            border: 3px double var(--apple-border);
            background: var(--apple-card);
        }

        [data-theme^="hp-"] button:not(.success) {
            background: rgba(0, 0, 0, 0.3) !important;
            border: 1px solid var(--apple-border) !important;
            color: var(--apple-text) !important;
            backdrop-filter: blur(5px);
        }

        [data-theme^="hp-"] .success {
            background: rgba(0, 0, 0, 0.4) !important;
            border: 1px solid var(--apple-text) !important;
            color: var(--apple-text) !important;
            backdrop-filter: blur(5px);
        }

        /* Buscador y selectores amigables a la vista */
        [data-theme^="hp-"] input,
        [data-theme^="hp-"] select {
            background: rgba(0, 0, 0, 0.4) !important;
            border: 1px solid var(--apple-border) !important;
            color: var(--apple-text) !important;
            opacity: 0.9;
        }

        [data-theme^="hp-"] input::placeholder {
            color: var(--apple-subtext);
            opacity: 0.6;
        }

        [data-theme^="hp-"] ::-webkit-scrollbar {
            width: 10px;
        }

        [data-theme^="hp-"] ::-webkit-scrollbar-track {
            background: var(--apple-bg);
        }

        [data-theme^="hp-"] ::-webkit-scrollbar-thumb {
            background: var(--apple-border);
            border-radius: 5px;
        }

        [data-theme^="hp-"] .no-image-placeholder {
            border-color: var(--apple-text);
            color: var(--apple-text);
        }

        /* Efectos Mágicos */
        .magic-sparks {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10000;
            background-image: radial-gradient(circle, #fff 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.1;
            animation: magic-float 20s infinite linear;
        }

        @keyframes magic-float {
            from {
                transform: translateY(0);
            }

            to {
                transform: translateY(-500px);
            }
        }

        #hpSecretBtn {
            font-family: 'Cinzel Decorative', cursive;
            font-weight: 900;
            font-size: 18px;
            background: linear-gradient(45deg, #d3a625, #740001);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            border: 1px solid rgba(211, 166, 37, 0.3);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.3s;
        }

        #hpSecretBtn:hover {
            transform: scale(1.1) rotate(10deg);
            border-color: #d3a625;
            text-shadow: 0 0 10px #d3a625;
        }

        .hp-menu {
            position: absolute;
            top: 60px;
            right: 0;
            background: #1a0a0a;
            border: 1px solid #d3a625;
            border-radius: 12px;
            padding: 10px;
            z-index: 1000;
            display: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            font-family: 'Cinzel Decorative', cursive;
            min-width: 180px;
        }

        .hp-item {
            padding: 8px 12px;
            cursor: pointer;
            color: #d3a625;
            border-radius: 6px;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }

        .hp-item:hover {
            background: rgba(211, 166, 37, 0.1);
            transform: translateX(5px);
        }

        .hp-item i {
            width: 20px;
            text-align: center;
        }

        * {
            box-sizing: border-box;
            transition: background 0.4s ease, color 0.4s ease, border-color 0.4s ease, box-shadow 0.4s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            padding: 40px 20px;
            background: var(--apple-bg);
            color: var(--apple-text);
            -webkit-font-smoothing: antialiased;
            letter-spacing: -0.01em;
            overflow-x: hidden;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            background: var(--apple-card);
            backdrop-filter: var(--glass-blur);
            padding: 32px;
            border-radius: 24px;
            border: 1px solid var(--apple-border);
            box-shadow: var(--card-shadow);
        }

        h1 {
            font-weight: 600;
            font-size: 24px;
            letter-spacing: -0.02em;
        }

        .toolbar {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 16px;
            border: 1px solid var(--apple-border);
        }

        .sort-chips {
            display: flex;
            gap: 4px;
            background: rgba(0, 0, 0, 0.03);
            padding: 4px;
            border-radius: 12px;
        }

        .chip {
            padding: 6px 14px;
            font-size: 13px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--apple-subtext);
        }

        .chip.active {
            background: var(--apple-blue);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 113, 227, 0.3);
        }

        input,
        select {
            padding: 10px 14px;
            background: var(--input-bg);
            border: 1px solid var(--apple-border);
            border-radius: 12px;
            font-size: 14px;
            color: var(--apple-text);
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--apple-blue);
            box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.1);
        }

        button {
            padding: 10px 20px;
            background: var(--apple-blue);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            filter: brightness(1.05);
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        /* Monochrome Dark Mode Buttons */
        [data-theme="dark"] button {
            background: #2c2c2e;
            color: #f5f5f7;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] button:hover {
            background: #3a3a3c;
            border-color: rgba(255, 255, 255, 0.2);
        }

        [data-theme="dark"] button.success {
            background: #f5f5f7;
            color: #1c1c1e;
            border: none;
        }

        [data-theme="dark"] button.success:hover {
            background: #ffffff;
            opacity: 0.9;
        }

        [data-theme="dark"] button.danger {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #f5f5f7;
        }

        [data-theme="dark"] button.danger:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.4);
        }

        [data-theme="dark"] .chip.active {
            background: #f5f5f7;
            color: #1c1c1e;
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] button.secondary {
            background: rgba(255, 255, 255, 0.05);
            color: #f5f5f7;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        button.secondary {
            background: rgba(0, 0, 0, 0.05);
            color: var(--apple-text);
        }

        button.success {
            background: var(--apple-green);
        }

        button.danger {
            background: var(--apple-red);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        th {
            background: transparent;
            font-size: 12px;
            font-weight: 600;
            color: var(--apple-subtext);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 16px 12px;
            border-bottom: 1px solid var(--apple-border);
        }

        td {
            padding: 16px 12px;
            border-bottom: 1px solid var(--apple-border);
            font-size: 14px;
        }

        tr:hover td {
            background: rgba(0, 0, 0, 0.01);
        }

        tr.pending {
            background: rgba(251, 192, 45, 0.05) !important;
        }

        .pending-tag {
            font-size: 10px;
            background: var(--apple-text);
            color: #fff;
            padding: 2px 8px;
            border-radius: 20px;
            font-weight: 600;
            margin-left: 8px;
        }

        .thumb {
            width: 52px;
            height: 52px;
            object-fit: contain;
            border-radius: 14px;
            background: var(--input-bg);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            cursor: zoom-in;
            border: 1px solid var(--apple-border);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--modal-bg);
            padding: 40px;
            border-radius: 36px;
            width: 520px;
            border: 1px solid var(--apple-border);
            box-shadow: 0 40px 80px rgba(0, 0, 0, 0.3);
            color: var(--apple-text);
        }

        #themeToggle {
            background: var(--apple-card);
            border: 1px solid var(--apple-border);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: var(--apple-text);
            backdrop-filter: var(--glass-blur);
        }

        #themeToggle:hover {
            transform: scale(1.1);
        }

        .drop-zone {
            border: 2px dashed var(--apple-border);
            padding: 32px;
            text-align: center;
            border-radius: 20px;
            color: var(--apple-subtext);
            margin-bottom: 24px;
            background: var(--apple-bg);
        }

        .drop-zone:hover {
            border-color: var(--apple-blue);
            background: rgba(0, 113, 227, 0.02);
        }

        .p-desc {
            font-size: 11px;
            color: var(--apple-subtext);
            max-width: 380px;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.4;
            margin-top: 3px;
            font-weight: 400;
        }

        [data-theme="fallout"] .p-desc {
            color: rgba(24, 255, 98, 0.7);
            text-shadow: none;
        }

        #zoomOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            cursor: zoom-out;
        }

        #zoomOverlay img {
            max-width: 90%;
            max-height: 90%;
        }

        .main-logo {
            height: 48px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
            transition: filter 0.4s ease;
        }

        [data-theme="dark"] .main-logo {
            filter: brightness(0) invert(1) drop-shadow(0 4px 12px rgba(255, 255, 255, 0.1));
        }

        [data-theme="fallout"] button,
        [data-theme="fallout"] .chip {
            background: transparent !important;
            color: #18ff62 !important;
            border: 1px solid #18ff62 !important;
        }

        [data-theme="fallout"] button.success,
        [data-theme="fallout"] .chip.active {
            background: #18ff62 !important;
            color: #000 !important;
        }

        /* Dashboard Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--apple-bg);
            border: 1px solid var(--apple-border);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.05);
            border-color: var(--apple-blue);
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: rgba(0, 113, 227, 0.1);
            color: var(--apple-blue);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--apple-text);
        }

        .stat-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--apple-subtext);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-progress-bg {
            height: 6px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }

        .stat-progress-bar {
            height: 100%;
            background: var(--apple-blue);
            border-radius: 3px;
            transition: width 1s ease-in-out;
        }

        [data-theme="dark"] .stat-progress-bg {
            background: rgba(255, 255, 255, 0.1);
        }

        [data-theme="fallout"] .stat-card {
            border-color: #18ff62;
            box-shadow: 0 0 10px rgba(24, 255, 98, 0.1);
        }

        [data-theme="fallout"] .stat-icon {
            background: rgba(24, 255, 98, 0.1);
            color: #18ff62;
        }

        [data-theme="fallout"] .stat-progress-bar {
            background: #18ff62;
        }

        /* Grid View / Audit Mode */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, 240px);
            gap: 24px;
            padding: 24px 0;
            display: none;
            justify-content: center;
        }

        .audit-card {
            background: var(--apple-bg);
            border: 1px solid var(--apple-border);
            border-radius: 16px;
            width: 240px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .audit-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-color: var(--apple-blue);
        }

        .audit-card .card-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f9f9f9;
            cursor: zoom-in;
        }

        .audit-card .card-content {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .audit-card .card-brand {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 4px 8px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            height: 24px;
            display: flex;
            align-items: center;
            border: 1px solid #eee;
        }

        .audit-card .card-id {
            font-size: 11px;
            font-weight: 800;
            color: var(--apple-subtext);
            margin-bottom: 4px;
        }

        /* Spotlight CSS */
        #spotlightOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            z-index: 20000;
            display: none;
            justify-content: center;
            padding-top: 15vh;
        }

        .spotlight-box {
            width: 600px;
            background: var(--apple-bg);
            border-radius: 20px;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--apple-border);
            overflow: hidden;
            animation: spotlight-in 0.2s ease-out;
        }

        @keyframes spotlight-in {
            from {
                transform: scale(0.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .spotlight-input-container {
            padding: 20px;
            border-bottom: 1px solid var(--apple-border);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #spotlightInput {
            flex: 1;
            background: none;
            border: none;
            font-size: 20px;
            color: var(--apple-text);
            outline: none;
            font-weight: 500;
        }

        .spotlight-results {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }

        .spotlight-item {
            padding: 12px 15px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.1s;
            color: var(--apple-text);
        }

        .spotlight-item.active {
            background: var(--apple-blue) !important;
            color: white !important;
        }

        .spotlight-item i {
            width: 20px;
            text-align: center;
            opacity: 0.7;
        }

        .spotlight-item .shortcut {
            margin-left: auto;
            font-size: 10px;
            font-weight: 700;
            background: rgba(128, 128, 128, 0.2);
            padding: 2px 4px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .spotlight-item.active .shortcut {
            background: rgba(255, 255, 255, 0.3);
        }

        .spotlight-section {
            font-size: 11px;
            font-weight: 700;
            color: var(--apple-subtext);
            padding: 15px 15px 5px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .spotlight-hint {
            padding: 12px;
            background: rgba(0, 0, 0, 0.02);
            font-size: 12px;
            color: var(--apple-subtext);
            display: flex;
            justify-content: center;
            gap: 15px;
            border-top: 1px solid var(--apple-border);
        }

        .spotlight-hint kbd {
            background: var(--apple-border);
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 10px;
            color: var(--apple-text);
            font-family: inherit;
        }

        .audit-card .card-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1.3;
            height: 36px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .audit-card .card-actions {
            display: flex;
            gap: 6px;
            margin-top: auto;
            padding-top: 10px;
            border-top: 1px solid var(--apple-border);
        }

        .view-toggle {
            display: flex;
            background: var(--apple-border);
            padding: 3px;
            border-radius: 10px;
            gap: 2px;
            margin-left: 10px;
        }

        .view-toggle button {
            background: transparent;
            color: var(--apple-text);
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .view-toggle button.active {
            background: var(--apple-bg);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            color: var(--apple-blue);
        }

        [data-theme="dark"] .audit-card .card-brand {
            background: rgba(45, 45, 48, 0.8);
            backdrop-filter: blur(10px);
            border-color: rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .audit-card .card-actions button.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .audit-card .card-actions button.secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        [data-theme="fallout"] .audit-card {
            background: #000;
            border-color: #18ff62;
            box-shadow: 0 0 15px rgba(24, 255, 98, 0.1);
        }

        [data-theme="fallout"] .audit-card .card-actions button.secondary {
            border-color: #18ff62;
            color: #18ff62;
        }
    </style>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Librerías de Exportación -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        /* --- SIDEBAR PANEL (HISTORIAL & PAPELERA) --- */
        .sidebar-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 400px;
            height: 100vh;
            background: var(--apple-card);
            backdrop-filter: blur(30px) saturate(150%);
            z-index: 2000;
            transform: translateX(105%);
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--apple-border);
            box-shadow: none;
        }

        /* --- APP NAVIGATION TABS --- */
        .app-nav {
            display: flex;
            gap: 5px;
            background: rgba(0, 0, 0, 0.05);
            padding: 5px;
            border-radius: 12px;
            margin-bottom: 24px;
            width: fit-content;
        }

        [data-theme="dark"] .app-nav {
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-tab {
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: 0.3s;
            color: var(--apple-subtext);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tab.active {
            background: var(--apple-card);
            color: var(--apple-text);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--apple-border);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(0, 0, 0, 0.03);
            color: var(--apple-text);
        }

        .view-container {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .view-container.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Sales View Specifics */
        .sales-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .trend-card {
            background: var(--apple-card);
            border: 1px solid var(--apple-border);
            border-radius: 20px;
            padding: 24px;
            position: relative;
            overflow: hidden;
        }

        .trend-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            background: rgba(52, 199, 89, 0.1);
            color: #34c759;
        }

        .trend-up {
            color: #34c759;
        }

        .trend-down {
            color: #ff3b30;
        }

        [data-theme^="hp-"] .nav-tab {
            font-family: 'Cinzel Decorative', cursive;
            font-size: 11px;
        }

        .sidebar-panel.open {
            transform: translateX(0);
            visibility: visible;
            box-shadow: -10px 0 30px rgba(0, 0, 0, 0.3);
        }

        .sidebar-header {
            padding: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--apple-border);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .log-entry {
            padding: 12px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.03);
            margin-bottom: 12px;
            font-size: 12px;
            border-left: 4px solid var(--apple-blue);
            animation: slideIn 0.3s ease-out;
        }

        [data-theme="dark"] .log-entry {
            background: rgba(255, 255, 255, 0.03);
        }

        .log-entry.delete {
            border-left-color: var(--apple-red);
        }

        .log-entry.create {
            border-left-color: var(--apple-green);
        }

        .log-entry .time {
            opacity: 0.5;
            font-size: 10px;
            display: block;
            margin-top: 4px;
        }

        .trash-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: rgba(255, 59, 48, 0.05);
            border: 1px solid rgba(255, 59, 48, 0.1);
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .trash-item img {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            object-fit: cover;
        }

        .btn-restore,
        .btn-undo {
            margin-left: auto;
            background: var(--apple-blue);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 10px;
            cursor: pointer;
            font-weight: 700;
        }

        .btn-undo {
            background: rgba(0, 0, 0, 0.1);
            color: var(--apple-text);
            border: 1px solid var(--apple-border);
        }

        [data-theme="dark"] .btn-undo {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-undo:hover {
            background: var(--apple-blue);
            color: white;
        }

        [data-theme^="hp-"] .sidebar-panel {
            font-family: 'Cinzel Decorative', cursive !important;
            border-left: 3px double var(--apple-border);
        }

        [data-theme="hp-gryffindor"] .log-entry {
            border-left-color: #ffdf00;
            background: rgba(116, 0, 1, 0.1);
        }

        [data-theme="hp-slytherin"] .log-entry {
            border-left-color: #4caf50;
            background: rgba(26, 71, 42, 0.1);
        }

        @keyframes slideIn {
            from {
                transform: translateX(20px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
            <div style="display:flex; align-items:center; gap:20px;">
                <img src="/assets/logo.svg" alt="Integral" class="main-logo">
                <div style="display:flex; align-items:center; gap:12px;">
                    <h1 style="margin:0; font-size: 1.6rem;">Gestor de Catálogo Pro</h1>
                    <span id="pendingCount"
                        style="background:var(--apple-red); color:white; padding:4px 12px; border-radius:20px; font-size:12px; font-weight:700; display:none;">0
                        pendientes</span>
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:12px;">
                <button id="cyberToggle" onclick="toggleTheme('cyberpunk')" title="Modo Cyberpunk"
                    style="background: transparent; border: 1px solid var(--apple-border); color: var(--apple-text); border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; padding: 0;">
                    <i class="fa-solid fa-bolt-lightning"></i>
                </button>
                <button id="falloutToggle" onclick="toggleTheme('fallout')" title="Modo Fallout"
                    style="background: transparent; border: 1px solid var(--apple-border); color: var(--apple-text); border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; padding: 0;">
                    <i class="fa-solid fa-radiation"></i>
                </button>
                <button id="themeToggle" onclick="toggleTheme()" title="Cambiar Tema">
                    <i class="fa-solid fa-moon"></i>
                </button>
                <button id="historyToggle" onclick="toggleHistory()" title="Historial y Papelera"
                    style="background: transparent; border: 1px solid var(--apple-border); color: var(--apple-text); border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; padding: 0;">
                    <i class="fa-solid fa-clock-rotate-left"></i>
                </button>
                <div style="position:relative">
                    <button id="hpSecretBtn" onclick="toggleHPMenu()" title="Magia de Hogwarts">HP</button>
                    <div id="hpMenu" class="hp-menu">
                        <div class="hp-item" onclick="setHPTheme('gryffindor')"><i class="fa-solid fa-fire"></i>
                            Gryffindor</div>
                        <div class="hp-item" onclick="setHPTheme('slytherin')"><i class="fa-solid fa-staff-snake"></i>
                            Slytherin</div>
                        <div class="hp-item" onclick="setHPTheme('ravenclaw')"><i
                                class="fa-solid fa-feather-pointed"></i> Ravenclaw</div>
                        <div class="hp-item" onclick="setHPTheme('hufflepuff')"><i class="fa-solid fa-leaf"></i>
                            Hufflepuff</div>
                        <div class="hp-item" onclick="setHPTheme('clear')"
                            style="border-top:1px solid rgba(211,166,37,0.2); margin-top:5px; color:#aaa;"><i
                                class="fa-solid fa-wand-sparkles"></i> Limpiar Hechizo</div>
                    </div>
                </div>
                <button class="success" id="btnPublish" onclick="publishChanges()">🚀 ENVIAR A LA WEB</button>
            </div>
        </div>

        <!-- Sidebar Historial -->
        <div id="historySidebar" class="sidebar-panel">
            <div class="sidebar-header">
                <h2 style="font-size: 18px; margin:0"><i class="fa-solid fa-bolt-lightning"></i> Magia Reciente</h2>
                <button onclick="toggleHistory()"
                    style="background:transparent; color:var(--apple-text); border:none; padding:10px; cursor:pointer"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>

            <div style="padding: 10px 24px; display: flex; gap: 10px; border-bottom: 1px solid var(--apple-border)">
                <button id="tabLog" class="secondary" onclick="showHistoryTab('log')"
                    style="flex:1; padding: 6px; font-size:11px">ACTIVIDAD</button>
                <button id="tabTrash" class="secondary" onclick="showHistoryTab('trash')"
                    style="flex:1; padding: 6px; font-size:11px">PAPELERA</button>
            </div>

            <div id="logContent" class="sidebar-content">
                <!-- Se llena dinámicamente -->
                <div style="text-align:center; padding-top:40px; opacity:0.5">Sin actividad reciente</div>
            </div>

            <div id="trashContent" class="sidebar-content" style="display:none">
                <!-- Se llena dinámicamente -->
                <div style="text-align:center; padding-top:40px; opacity:0.5">La papelera está vacía</div>
            </div>
        </div>

        <!-- APP NAVIGATION -->
        <div class="app-nav">
            <div id="navCatalog" class="nav-tab active" onclick="switchView('catalog')">
                <i class="fa-solid fa-boxes-stacked"></i> GESTIÓN DE CATÁLOGO
            </div>
            <div id="navSales" class="nav-tab" onclick="switchView('sales')">
                <i class="fa-solid fa-chart-line"></i> INTELIGENCIA DE VENTAS
            </div>
        </div>

        <!-- VIEW 1: CATALOG MANAGEMENT -->
        <div id="viewCatalog" class="view-container active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(0, 113, 22, 0.1); color: var(--apple-blue);">
                        <i class="fa-solid fa-boxes-stacked"></i>
                    </div>
                    <div>
                        <div class="stat-value" id="statTotal">0</div>
                        <div class="stat-label">Total Productos</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(52, 199, 89, 0.1); color: #34c759;">
                        <i class="fa-solid fa-camera-retro"></i>
                    </div>
                    <div>
                        <div class="stat-value" id="statPhotos">0%</div>
                        <div class="stat-label">Calidad Visual</div>
                        <div class="stat-progress-bg">
                            <div class="stat-progress-bar" id="photoProgress" style="width: 0%; background: #34c759;">
                            </div>
                        </div>
                    </div>
                    <button onclick="fixNextPhoto()" class="secondary"
                        style="position:absolute; top:15px; right:15px; padding:4px 8px; font-size:10px; border-radius:10px;">Arreglar
                        Siguiente</button>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(255, 59, 48, 0.1); color: #ff3b30;">
                        <i class="fa-solid fa-cloud-arrow-up"></i>
                    </div>
                    <div>
                        <div class="stat-value" id="statPending">0</div>
                        <div class="stat-label">Por Publicar</div>
                    </div>
                    <div id="publishAlert" style="font-size:10px; color:#ff3b30; font-weight:700; display:none;">⚠️
                        Requiere
                        actualización</div>
                    <div style="display: flex; gap: 8px; margin-top: 12px; flex-direction: column;">
                        <button onclick="setSort('pending', document.getElementById('chipPending'))" class="secondary"
                            style="background: rgba(0, 113, 227, 0.1); color: var(--apple-blue); border: 1px solid rgba(0, 113, 227, 0.2); padding: 4px 8px; border-radius: 6px; font-size: 10px; cursor: pointer; font-weight: 700;">
                            <i class="fa-solid fa-eye"></i> VER PENDIENTES
                        </button>
                        <button id="btnDeletePending" onclick="deletePendingProducts()"
                            style="display:none; background:rgba(255, 59, 48, 0.1); color:#ff3b30; border:1px solid rgba(255, 59, 48, 0.2); padding:4px 8px; border-radius:6px; font-size:9px; cursor:pointer; font-weight:700; width:100%;">
                            <i class="fa-solid fa-trash-can"></i> BORRAR PENDIENTES
                        </button>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(255, 159, 10, 0.1); color: #ff9f0a;">
                        <i class="fa-solid fa-tags"></i>
                    </div>
                    <div>
                        <div class="stat-value" id="statBrands">0</div>
                        <div class="stat-label">Marcas Activas</div>
                    </div>
                </div>
            </div>

            <div class="toolbar">
                <input type="text" id="search" placeholder="Buscar por nombre, ID o marca..." onkeyup="filterAndSort()"
                    style="width:300px">

                <div class="sort-chips">
                    <span class="chip active" onclick="setSort('recent', this)">Últimos cargados</span>
                    <span id="chipPending" class="chip" onclick="setSort('pending', this)">Pendientes</span>
                    <span class="chip" onclick="setSort('alpha', this)">Alfabético</span>
                    <span class="chip" onclick="setSort('category', this)">Por Categoría</span>
                </div>

                <select id="filterBrand" onchange="filterAndSort()" style="margin-left: 10px; max-width: 150px;">
                    <option value="">Todas las marcas</option>
                </select>

                <div id="totalCount" style="margin-left:auto; font-size: 14px; font-weight: 600; opacity: 0.7;">
                    Cargando...
                </div>

                <div style="display:flex; gap:10px;">
                    <button class="secondary" onclick="exportData('xlsx')" title="Exportar Excel">
                        <i class="fa-solid fa-file-excel"></i>
                    </button>
                    <button class="secondary" onclick="exportData('pdf')" title="Exportar PDF/Imprimir">
                        <i class="fa-solid fa-print"></i>
                    </button>
                </div>
            </div>

            <div style="display:flex; gap:12px; margin-bottom: 24px;">
                <button class="secondary" onclick="document.getElementById('csvInput').click()">
                    <i class="fa-solid fa-file-import"></i> Carga Masiva
                </button>
                <input type="file" id="csvInput" style="display:none" accept=".csv" onchange="importCSV(this)">
                <button onclick="newProduct()">+ Nuevo Producto</button>
            </div>

            <table id="productTable">
                <thead>
                    <tr>
                        <th>Foto</th>
                        <th>ID</th>
                        <th>Marca</th>
                        <th>Nombre</th>
                        <th>Categoría</th>
                        <th>Fecha Alta</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <div id="productGrid" class="grid-container" style="display:none;"></div>
        </div>

        <!-- VIEW 2: SALES INTELLIGENCE -->
        <div id="viewSales" class="view-container">
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:30px;">
                <div
                    style="background:var(--apple-blue); color:white; width:48px; height:48px; border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:24px;">
                    <i class="fa-solid fa-wand-magic-sparkles"></i>
                </div>
                <div>
                    <h2 style="margin:0; font-size:22px;">Pulso de Mercado</h2>
                    <p style="margin:0; opacity:0.6; font-size:14px;">Análisis de tendencias y optimización de ventas
                    </p>
                </div>
            </div>

            <div class="sales-grid">
                <!-- Tendencias Reales FEB/MAR 2026 -->
                <div class="trend-card">
                    <div class="trend-badge" style="background:rgba(52,199,89,0.1); color:#34c759">LIVE PULSE: FEB 2026
                    </div>
                    <h3 style="margin-top:0; font-size:16px;"><i class="fa-solid fa-bolt" style="color:#ff9f0a"></i>
                        Mercado México (Hoy)</h3>
                    <div style="margin-top:20px;">
                        <div class="trend-item" onclick="showTrendDetail('intel2026')"
                            style="display:flex; justify-content:space-between; margin-bottom:12px; align-items:center; cursor:pointer; padding:5px; border-radius:8px; transition:0.2s;">
                            <span>Intel Arrow Lake-S Refresh</span>
                            <span class="trend-up" style="font-weight:700;"><i class="fa-solid fa-arrow-trend-up"></i>
                                LANZAMIENTO</span>
                        </div>
                        <div class="trend-item" onclick="showTrendDetail('rtx50super')"
                            style="display:flex; justify-content:space-between; margin-bottom:12px; align-items:center; cursor:pointer; padding:5px; border-radius:8px; transition:0.2s;">
                            <span>NVIDIA RTX 50 SUPER (GDDR7)</span>
                            <span class="trend-up" style="font-weight:700;"><i class="fa-solid fa-fire"></i> STOCK
                                BAJO</span>
                        </div>
                        <div class="trend-item" onclick="showTrendDetail('amdryzen2026')"
                            style="display:flex; justify-content:space-between; margin-bottom:12px; align-items:center; cursor:pointer; padding:5px; border-radius:8px; transition:0.2s;">
                            <span>AMD Ryzen AI 400 / Zen 5</span>
                            <span class="trend-up" style="font-weight:700;"><i class="fa-solid fa-brain"></i>
                                TENDENCIA</span>
                        </div>
                        <div class="trend-item" onclick="showTrendDetail('apple2026')"
                            style="display:flex; justify-content:space-between; margin-bottom:12px; align-items:center; cursor:pointer; padding:5px; border-radius:8px; transition:0.2s;">
                            <span>MacBook M5 (Marzo 2026)</span>
                            <span class="trend-up" style="font-weight:700; color:#0071e3;"><i
                                    class="fa-solid fa-clock"></i> PRÓXIMO</span>
                        </div>
                    </div>
                    <p
                        style="font-size:11px; opacity:0.7; margin-top:20px; border-top:1px solid var(--apple-border); padding-top:10px; line-height:1.4;">
                        <i class="fa-solid fa-circle-exclamation" style="color:#ff9f0a"></i> <b>Alerta:</b> La escasez
                        de chips de IA está elevando los costos de memoria RAM en México este mes.
                    </p>
                </div>

                <!-- Oportunidades SEO -->
                <div class="trend-card">
                    <h3 style="margin-top:0; font-size:16px;"><i class="fa-solid fa-magnifying-glass"
                            style="color:var(--apple-blue)"></i> Mejoras SEO</h3>
                    <div id="seoQualityBadge" style="margin-bottom:15px; font-size:12px; font-weight:700;"></div>
                    <div id="seoSuggestions" style="margin-top:20px; display:flex; flex-direction:column; gap:10px;">
                        <div style="text-align:center; padding:20px; opacity:0.5;">Analizando catálogo...</div>
                    </div>
                </div>

                <!-- Radar de Competencia -->
                <div class="trend-card">
                    <h3 style="margin-top:0; font-size:16px;"><i class="fa-solid fa-radar" style="color:#ff9f0a"></i>
                        Radar de Precios (México)</h3>
                    <div id="radarContainer" style="text-align:center; padding-top:20px; min-height:180px;">
                        <i class="fa-solid fa-satellite-dish"
                            style="font-size:40px; opacity:0.2; margin-bottom:15px;"></i>
                        <p style="font-size:13px; opacity:0.6;">Escaneando Mercado Libre y Amazon MX...</p>
                        <button class="secondary" onclick="runPriceRadar()"
                            style="font-size:11px; margin-top:10px;">EJECUTAR ESCANEO GLOBAL</button>
                    </div>
                </div>
            </div>

            <div
                style="margin-top:40px; background:var(--apple-card); border:1px solid var(--apple-border); border-radius:24px; padding:30px; overflow:hidden;">
                <div
                    style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:25px; border-bottom:1px solid var(--apple-border); padding-bottom:15px;">
                    <div>
                        <h3 style="margin:0; font-size:18px;"><i class="fa-solid fa-list-check"
                                style="color:var(--apple-blue)"></i> Ranking: Top 20 Oportunidades de Mercado</h3>
                        <p style="margin:5px 0 0 0; font-size:12px; opacity:0.6;">Basado en volumen de búsqueda y
                            competencia en Amazon MX y Mercado Libre.</p>
                    </div>
                    <div style="font-size:12px; font-weight:700; color:var(--apple-blue); cursor:pointer;"
                        onclick="renderMarketHotlist(true)">
                        <i class="fa-solid fa-rotate"></i> REFRESCAR REPORTE
                    </div>
                </div>

                <div id="intelTabs"
                    style="display:flex; gap:10px; margin-bottom:20px; padding-bottom:10px; border-bottom:1px solid var(--apple-border);">
                    <div class="intel-tab active" onclick="switchIntelTab('computo')"
                        style="padding:8px 16px; border-radius:10px; cursor:pointer; font-size:12px; font-weight:700; transition:0.3s; background:var(--apple-blue); color:white;">
                        Tecnología</div>
                    <div class="intel-tab" onclick="switchIntelTab('papeleria')"
                        style="padding:8px 16px; border-radius:10px; cursor:pointer; font-size:12px; font-weight:700; transition:0.3s; background:rgba(0,0,0,0.05); color:var(--apple-text);">
                        Papelería</div>
                    <div class="intel-tab" onclick="switchIntelTab('toner')"
                        style="padding:8px 16px; border-radius:10px; cursor:pointer; font-size:12px; font-weight:700; transition:0.3s; background:rgba(0,0,0,0.05); color:var(--apple-text);">
                        Toners y Cartuchos</div>
                </div>

                <div id="marketHotlistContainer" style="max-height:600px; overflow-y:auto; padding-right:10px;">
                    <!-- Se llena dinámicamente con las categorías -->
                </div>

                <div
                    style="margin-top:25px; padding-top:20px; border-top:1px solid var(--apple-border); display:flex; flex-wrap:wrap; gap:20px; font-size:10px; opacity:0.5;">
                    <div style="font-weight:700; color:var(--apple-text); opacity:1;">FUENTES Y CITAS:</div>
                    <span><i class="fa-solid fa-link"></i> Xataka México (Reporte Hardware 2026)</span>
                    <span><i class="fa-solid fa-link"></i> Infobae Tech (Finanzos México)</span>
                    <span><i class="fa-solid fa-link"></i> Amazon Seller Central - MX Hub</span>
                    <span><i class="fa-solid fa-link"></i> Mercado Libre Ads - Dashboard Tendencias</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Trend Details Modal -->
    <div id="trendDetailModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 id="trendDetailTitle" style="margin:0; font-size:20px;">Detalles de Tendencia</h2>
                <button class="secondary" onclick="document.getElementById('trendDetailModal').style.display='none'"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="trendDetailBody" style="font-size:14px; line-height:1.6;"></div>
            <div style="margin-top:24px; display:flex; justify-content:flex-end;">
                <button onclick="document.getElementById('trendDetailModal').style.display='none'">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Form -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Nuevo Producto</h2>

            <div style="position:relative;">
                <div id="dropZone" class="drop-zone" onclick="document.getElementById('fileInput').click()">
                    <p id="dropText">📁 Arrastra o selecciona la foto</p>
                </div>
                <button type="button" onclick="openWizardFromEditor()"
                    style="position:absolute; top:10px; right:10px; background:var(--apple-blue); color:white; width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; border:2px solid white; box-shadow:0 4px 12px rgba(0,0,0,0.2); z-index: 1;"
                    title="Buscar mejor imagen en Google">
                    <i class="fa-solid fa-wand-magic-sparkles"></i>
                </button>
            </div>
            <input type="file" id="fileInput" style="display:none" onchange="handleFileUpload(this.files[0])">
            <input type="hidden" id="p_image">

            <label>Nombre del Producto (Sin Marca)</label><br>
            <input type="text" id="p_name" placeholder="Ej. Cartucho 12A Negro" style="width:100%"><br><br>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div>
                    <label>ID / Modelo</label><br>
                    <input type="text" id="p_id" style="width:100%">
                </div>
                <div>
                    <label>Categoría Web</label><br>
                    <select id="p_category" style="width:100%">
                        <option value="toner">TONERS</option>
                        <option value="papeleria">PAPELERÍA</option>
                        <option value="accesorios">ACCESORIOS</option>
                    </select>
                </div>
            </div>

            <br>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div>
                    <label>Marca</label><br>
                    <div style="display:flex; gap:5px;">
                        <select id="p_brand" style="flex-grow:1"></select>
                        <button type="button" onclick="addNewBrand()" style="padding:5px 10px; background:#6c757d;"
                            title="Añadir nueva marca">+</button>
                        <button type="button" onclick="openBrandWizardFromEditor()"
                            style="padding:5px 10px; background:#ff2d55; color:white; border-radius: 12px; border:none; display:flex; align-items:center; justify-content:center;"
                            title="Buscar logo de esta marca">
                            <i class="fa-solid fa-wand-magic-sparkles"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <label>Compatibilidad</label><br>
                    <input type="text" id="p_compatibility" placeholder="Ej. M15w, P1102" style="width:100%">
                </div>
            </div>

            <br>
            <label>Descripción</label><br>
            <textarea id="p_description" placeholder="Descripción detallada del producto..."
                style="width:100%; height:80px; padding:10px; border-radius:12px; border:1px solid var(--apple-border); background:var(--input-bg); color:var(--apple-text); font-family:inherit; resize: none;"></textarea>

            <div style="display:flex; justify-content:space-between; margin-top:20px;">
                <button class="secondary" onclick="closeModal()">Cancelar</button>
                <button onclick="saveProduct()">💾 Guardar Producto</button>
            </div>
        </div>
    </div>

    <!-- Modal Masivo -->
    <div id="bulkModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top:0">Carga Masiva Apple-style </h2>
            <p style="color:var(--apple-subtext); font-size:14px">Sube un CSV y las imágenes (el nombre del archivo debe
                ser el ID del producto).</p>

            <div style="margin-bottom:20px">
                <label style="display:block; margin-bottom:8px; font-weight:600">1. Archivo CSV</label>
                <input type="file" id="bulkCSV" accept=".csv" style="width:100%">
            </div>

            <div style="margin-bottom:20px">
                <label style="display:block; margin-bottom:8px; font-weight:600">2. Carpeta de Imágenes</label>
                <input type="file" id="bulkImages" multiple accept="image/*" style="width:100%">
            </div>

            <div id="bulkProgress" style="display:none; margin-bottom:20px">
                <div style="height:6px; background:var(--apple-bg); border-radius:10px; overflow:hidden">
                    <div id="progressBar" style="height:100%; background:var(--apple-blue); width:0%"></div>
                </div>
                <p id="progressText" style="font-size:12px; margin-top:5px; text-align:center"></p>
            </div>

            <div style="display:flex; justify-content:space-between; margin-top:30px;">
                <button class="secondary" onclick="closeBulkModal()">Cancelar</button>
                <button onclick="processBulk()" id="btnProcessBulk">Iniciar Carga</button>
            </div>
        </div>
    </div>

    <!-- Modal de Conflictos en Carga Masiva -->
    <div id="bulkConflictModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 style="margin-top:0">Conflictos Detectados </h2>
            <p style="color:var(--apple-subtext); font-size:14px">
                Se han encontrado productos que ya existen en el catálogo. ¿Cómo deseas proceder?
            </p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                <div
                    style="background: rgba(52, 199, 89, 0.05); padding: 15px; border-radius: 12px; border: 1px solid rgba(52, 199, 89, 0.1);">
                    <h3 style="margin:0; font-size:14px; color:#34c759;"><i class="fa-solid fa-plus-circle"></i> NUEVOS
                    </h3>
                    <p id="newItemsCount" style="font-size:24px; font-weight:700; margin:5px 0;">0</p>
                    <div id="newItemsList"
                        style="font-size:11px; max-height:100px; overflow-y:auto; color:var(--apple-subtext);"></div>
                </div>
                <div
                    style="background: rgba(255, 59, 48, 0.05); padding: 15px; border-radius: 12px; border: 1px solid rgba(255, 59, 48, 0.1);">
                    <h3 style="margin:0; font-size:14px; color:#ff3b30;"><i
                            class="fa-solid fa-triangle-exclamation"></i> EXISTENTES</h3>
                    <p id="conflictItemsCount" style="font-size:24px; font-weight:700; margin:5px 0;">0</p>
                    <div id="conflictItemsList"
                        style="font-size:11px; max-height:100px; overflow-y:auto; color:var(--apple-subtext);"></div>
                </div>
            </div>

            <div style="display:flex; flex-direction:column; gap:10px; margin-top:30px;">
                <button onclick="executeBulkImport(true)" style="width:100%; justify-content:center;">🚀 SOBRESCRIBIR
                    TODO (Incluir Existentes)</button>
                <button onclick="executeBulkImport(false)" class="secondary"
                    style="width:100%; justify-content:center;">✅ SOLO CARGAR NUEVOS</button>
                <button class="secondary" onclick="document.getElementById('bulkConflictModal').style.display='none'"
                    style="width:100%; justify-content:center; border:none;">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Price Scout Modal -->
    <div id="scoutModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div id="scoutProductHeader"
                style="display: flex; align-items: center; gap: 20px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid var(--apple-border);">
                <img id="scoutProductImg" src=""
                    style="width: 100px; height: 100px; object-fit: cover; border-radius: 12px; background: rgba(0,0,0,0.03); border: 1px solid var(--apple-border);">
                <div style="flex: 1;">
                    <h2
                        style="margin: 0; font-size: 14px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--apple-subtext); margin-bottom: 4px;">
                        Radar de Mercado</h2>
                    <div id="scoutProductModel"
                        style="font-weight: 800; font-size: 24px; color: var(--apple-blue); line-height: 1.1;"></div>
                    <div id="scoutProductName"
                        style="font-size: 13px; color: var(--apple-text); margin-top: 6px; opacity: 0.8; font-weight: 500;">
                    </div>
                </div>
            </div>

            <div id="scoutLoading" style="text-align:center; padding: 20px; display:none;">
                <i class="fa-solid fa-satellite-dish fa-spin" style="font-size: 30px; color: var(--apple-blue);"></i>
                <p style="margin-top:10px; font-weight:600;">Escaneando precios en tiempo real...</p>
            </div>
            <div id="scoutResults" style="margin-top:10px;"></div>
            <div style="display:flex; justify-content:center; margin-top:20px;">
                <button class="secondary" onclick="document.getElementById('scoutModal').style.display='none'">Cerrar
                    Radar</button>
            </div>
        </div>
    </div>
    <!-- Image Wizard Modal -->
    <div id="imageWizardModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                <div id="wizardIcon"
                    style="background: var(--apple-blue); color: white; width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <i class="fa-solid fa-wand-magic-sparkles" style="font-size: 20px;"></i>
                </div>
                <div>
                    <h2 id="wizardTitle" style="margin:0; font-size: 18px;">Asistente Inteligente</h2>
                    <p id="wizardProductTitle" style="margin:0; font-size: 13px; color: var(--apple-subtext);"></p>
                </div>
            </div>

            <div
                style="background: rgba(0, 113, 227, 0.05); padding: 18px; border-radius: 16px; border: 1px solid rgba(0, 113, 227, 0.1); margin-bottom: 20px;">
                <p style="margin-top:0; font-size: 14px; font-weight: 600; display:flex; align-items:center; gap:8px;">
                    <span
                        style="background:var(--apple-blue); color:white; width:20px; height:20px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:10px;">1</span>
                    Busca la imagen
                </p>
                <button id="btnWizardSearch" onclick=""
                    style="width: 100%; justify-content: center; background: #4285f4; margin-bottom: 10px; border-radius: 12px; height: 45px;">
                    <i class="fa-brands fa-google"></i> Buscar en Google
                </button>
                <p style="font-size: 12px; color: var(--apple-subtext); margin: 0; line-height: 1.4;">
                    Haz clic derecho en la imagen que te guste y selecciona <br><b>"Copiar dirección de imagen"</b>.
                </p>
            </div>

            <div style="margin-bottom: 20px;">
                <p style="margin-top:0; font-size: 14px; font-weight: 600; display:flex; align-items:center; gap:8px;">
                    <span
                        style="background:var(--apple-blue); color:white; width:20px; height:20px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:10px;">2</span>
                    Pega el enlace aquí
                </p>
                <input type="text" id="wizardImageUrl" placeholder="Pega el link aquí (ej. https://.../foto.jpg)"
                    style="width: 100%; margin-bottom: 12px; height: 45px;">
                <button id="btnImportImage" onclick="importWizardImage()"
                    style="width: 100%; justify-content: center; height: 45px; border-radius: 12px;">
                    <i class="fa-solid fa-cloud-arrow-down"></i> Procesar y Guardar
                </button>
            </div>

            <div id="wizardStatus"
                style="display:none; text-align: center; padding: 15px; background: rgba(0,0,0,0.03); border-radius: 12px; margin-bottom: 15px;">
                <i class="fa-solid fa-circle-notch fa-spin" style="color:var(--apple-blue);"></i>
                <p id="wizardStatusText" style="font-size: 13px; margin-top: 8px; font-weight: 500;"></p>
            </div>

            <div style="display:flex; justify-content:center;">
                <button class="secondary" onclick="document.getElementById('imageWizardModal').style.display='none'"
                    style="background:none; border:none; color:var(--apple-subtext);">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Zoom Overlay (Restored) -->
    <div id="zoomOverlay" onclick="this.style.display='none'"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; align-items:center; justify-content:center; cursor:zoom-out;">
        <img id="zoomedImg"
            style="max-width:90%; max-height:90%; border-radius:12px; box-shadow:0 0 50px rgba(0,0,0,0.5);">
    </div>

    <!-- Spotlight Search Overlay -->
    <div id="spotlightOverlay" onclick="if(event.target === this) closeSpotlight()">
        <div class="spotlight-box">
            <div class="spotlight-input-container">
                <i class="fa-solid fa-magnifying-glass" style="color: var(--apple-blue); font-size: 18px;"></i>
                <input type="text" id="spotlightInput" placeholder="¿Qué quieres hacer?" autocomplete="off"
                    onkeydown="handleSpotlightKey(event)" oninput="searchSpotlight()">
            </div>
            <div id="spotlightResults" class="spotlight-results">
                <!-- Results populated by JS -->
            </div>
            <div class="spotlight-hint">
                <span><kbd>↑↓</kbd> Navegar</span>
                <span><kbd>Enter</kbd> Seleccionar</span>
                <span><kbd>Esc</kbd> Cerrar</span>
            </div>
        </div>
    </div>

    <script>
        let products = [];
        let currentSort = 'recent';
        let filteredList = [];
        let cacheBuster = Date.now();

        const normalize = (str) => {
            if (!str) return '';
            return str.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        };

        // Spotlight Logic
        let spotlightIndex = 0;
        let spotlightActions = [
            { id: 'view_table', title: 'Ver modo Tabla', icon: 'fa-table-list', type: 'action', run: () => setView('table') },
            { id: 'view_grid', title: 'Ver modo Galería (Auditoría)', icon: 'fa-grip', type: 'action', run: () => setView('grid') },
            { id: 'theme_dark', title: 'Cambiar a Modo Oscuro/Claro', icon: 'fa-moon', type: 'action', run: () => toggleTheme() },
            { id: 'theme_fallout', title: 'Modo Fallout ☢️', icon: 'fa-radiation', type: 'action', run: () => toggleTheme('fallout') },
            { id: 'theme_cyberpunk', title: 'Modo Cyberpunk 🦾', icon: 'fa-bolt-lightning', type: 'action', run: () => toggleTheme('cyberpunk') },
            { id: 'new_prod', title: 'Crear Nuevo Producto', icon: 'fa-plus', type: 'action', run: () => newProduct() },
            { id: 'publish', title: 'Publicar cambios en la Web', icon: 'fa-paper-plane', type: 'action', run: () => publishChanges() },
            { id: 'cat_toner', title: 'Filtrar por: Tóners', icon: 'fa-print', type: 'filter', run: () => applySpotlightFilter('toner') },
            { id: 'cat_papeleria', title: 'Filtrar por: Papelería', icon: 'fa-pen-ruler', type: 'filter', run: () => applySpotlightFilter('papeleria') },
            { id: 'cat_accesorios', title: 'Filtrar por: Accesorios', icon: 'fa-keyboard', type: 'filter', run: () => applySpotlightFilter('accesorios') }
        ];

        window.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                openSpotlight();
            }
            if (e.key === 'Escape') closeSpotlight();
        });

        function openSpotlight() {
            document.getElementById('spotlightOverlay').style.display = 'flex';
            const input = document.getElementById('spotlightInput');
            input.value = '';
            input.focus();
            searchSpotlight();
        }

        function closeSpotlight() {
            document.getElementById('spotlightOverlay').style.display = 'none';
        }

        function handleSpotlightKey(e) {
            const items = document.querySelectorAll('.spotlight-item');
            if (items.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                spotlightIndex = (spotlightIndex + 1) % items.length;
                updateSpotlightActive();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                spotlightIndex = (spotlightIndex - 1 + items.length) % items.length;
                updateSpotlightActive();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                const active = items[spotlightIndex];
                if (active) active.click();
            }
        }

        function updateSpotlightActive() {
            const items = document.querySelectorAll('.spotlight-item');
            items.forEach((it, i) => {
                it.classList.toggle('active', i === spotlightIndex);
                if (i === spotlightIndex) it.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
            });
        }

        function searchSpotlight() {
            const query = document.getElementById('spotlightInput').value;
            const results = document.getElementById('spotlightResults');
            results.innerHTML = '';
            spotlightIndex = 0;

            // 1. Actions & Filters
            const filteredActions = spotlightActions.filter(a => normalize(a.title).includes(normalize(query)));
            if (filteredActions.length > 0) {
                const head = document.createElement('div');
                head.className = 'spotlight-section';
                head.innerText = 'Acciones y Comandos';
                results.appendChild(head);

                filteredActions.forEach((a, idx) => {
                    const div = document.createElement('div');
                    div.className = 'spotlight-item';
                    div.innerHTML = `<i class="fa-solid ${a.icon}"></i> ${a.title} <span class="shortcut">Cmd</span>`;
                    div.onclick = () => { a.run(); closeSpotlight(); };
                    div.onmouseenter = () => {
                        const allItems = Array.from(document.querySelectorAll('.spotlight-item'));
                        spotlightIndex = allItems.indexOf(div);
                        updateSpotlightActive();
                    };
                    results.appendChild(div);
                });
            }

            // 2. Products
            const filteredProducts = products.filter(p =>
                normalize(p.id).includes(normalize(query)) ||
                normalize(p.name).includes(normalize(query))
            ).slice(0, 8);

            if (filteredProducts.length > 0) {
                const head = document.createElement('div');
                head.className = 'spotlight-section';
                head.innerText = `Productos (${filteredProducts.length})`;
                results.appendChild(head);

                filteredProducts.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'spotlight-item';
                    div.innerHTML = `<i class="fa-solid fa-box"></i> <div><b>${p.id}</b> <span style="opacity:0.6; font-size:0.9em;">- ${p.name}</span></div>`;
                    div.onclick = () => {
                        document.getElementById('search').value = p.id;
                        filterAndSort();
                        closeSpotlight();
                    };
                    div.onmouseenter = () => {
                        const allItems = Array.from(document.querySelectorAll('.spotlight-item'));
                        spotlightIndex = allItems.indexOf(div);
                        updateSpotlightActive();
                    };
                    results.appendChild(div);
                });
            }

            updateSpotlightActive();
        }

        function applySpotlightFilter(cat) {
            document.getElementById('search').value = '';
            // For simplicity in this demo, we'll just show the category products if we had a category filter element
            // Since we use global filterAndSort, we'll just simulate a search for the category name for now
            document.getElementById('search').value = catMap[cat] || cat;
            filterAndSort();
        }

        async function loadProducts() {
            const res = await fetch('/api/products');
            const data = await res.json();
            products = data.data;
            updateBrandSelector();
            filterAndSort();
        }

        function updateBrandSelector() {
            // Marcas base que siempre deben estar + las que existan en la DB
            const standardBrands = ['HP', 'Brother', 'Canon', 'Lexmark', 'Xerox'];
            let dbBrands = [...new Set(products.map(p => p.brand).filter(b => b && !standardBrands.includes(b) && b !== 'Otros'))];
            let allBrands = [...standardBrands, ...dbBrands].sort();
            allBrands.push('Otros');

            // Selector del Modal
            const sel = document.getElementById('p_brand');
            const currentVal = sel.value;
            sel.innerHTML = '<option value="">Seleccione marca...</option>';

            // Selector de Filtro en Tabla
            const filterSel = document.getElementById('filterBrand');
            const currentFilter = filterSel.value;
            filterSel.innerHTML = '<option value="">Todas las marcas</option>';

            allBrands.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b; opt.textContent = b;
                sel.appendChild(opt.cloneNode(true));
                filterSel.appendChild(opt);
            });

            if (currentVal) sel.value = currentVal;
            if (currentFilter) filterSel.value = currentFilter;
        }

        function addNewBrand() {
            const newB = prompt("Nombre de la nueva marca:");
            if (newB) {
                const sel = document.getElementById('p_brand');
                const opt = document.createElement('option');
                opt.value = newB;
                opt.textContent = newB;
                sel.appendChild(opt);
                sel.value = newB;
            }
        }

        function setSort(type, el) {
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            currentSort = type;
            filterAndSort();
        }

        function filterAndSort() {
            const term = normalize(document.getElementById('search').value);
            const brandFilter = document.getElementById('filterBrand').value;

            let list = products.filter(p => {
                const matchesSearch = normalize(p.id).includes(term) ||
                    normalize(p.name).includes(term) ||
                    normalize(p.brand).includes(term);

                const matchesBrand = !brandFilter || p.brand === brandFilter;

                const matchesPending = currentSort === 'pending' ? p.published === 0 : true;

                return matchesSearch && matchesBrand && matchesPending;
            });

            if (currentSort === 'alpha') list.sort((a, b) => (a.brand || "").localeCompare(b.brand || "") || a.name.localeCompare(b.name));
            if (currentSort === 'recent') list.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            if (currentSort === 'category') list.sort((a, b) => a.category.localeCompare(b.category));
            // Si es 'pending', ya el filter hizo el trabajo, pero podemos ordenar por fecha
            if (currentSort === 'pending') list.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            document.getElementById('totalCount').innerText = `${list.length} productos`;
            filteredList = list;
            renderTable(list);
        }

        // --- FUNCIONES DE EXPORTACIÓN ---
        function exportToExcel() {
            try {
                if (filteredList.length === 0) return alert("No hay datos para exportar");

                const data = filteredList.map(p => ({
                    'ID': p.id,
                    'Marca': p.brand,
                    'Nombre': p.name,
                    'Categoría': catMap[p.category] || p.category,
                    'Fecha Alta': p.created_at ? new Date(p.created_at).toLocaleDateString('es-MX') : '-',
                    'Compatibilidad': p.compatibility
                }));

                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Inventario");
                XLSX.writeFile(wb, `Inventario_Integral_${new Date().toISOString().split('T')[0]}.xlsx`);
            } catch (err) {
                console.error(err);
                alert("Error técnico al exportar Excel: " + err.message);
            }
        }

        async function exportToPDF() {
            try {
                if (filteredList.length === 0) return alert("No hay datos para exportar");
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const isDark = document.body.getAttribute('data-theme') === 'dark';

                // Apple-style color palette
                const colors = isDark ? {
                    bg: [0, 0, 0],
                    text: [245, 245, 247],
                    headBg: [28, 28, 30],
                    headText: [255, 255, 255],
                    alternateRow: [18, 18, 20],
                    border: [44, 44, 46]
                } : {
                    bg: [255, 255, 255],
                    text: [29, 29, 31],
                    headBg: [245, 245, 247],
                    headText: [134, 134, 139],
                    alternateRow: [250, 250, 252],
                    border: [240, 240, 245]
                };

                // Fill background if dark mode
                if (isDark) {
                    doc.setFillColor(...colors.bg);
                    doc.rect(0, 0, 210, 297, 'F');
                }

                // Styled Header
                doc.setFont("helvetica", "bold");
                doc.setFontSize(22);
                doc.setTextColor(...colors.text);
                doc.text("Gestor de Catálogo Pro", 14, 25);

                doc.setFont("helvetica", "normal");
                doc.setFontSize(9);
                doc.setTextColor(isDark ? 161 : 134, isDark ? 161 : 134, isDark ? 166 : 139);
                doc.text("Reporte de Inventario | Integral Computación", 14, 32);
                doc.text(`Generado: ${new Date().toLocaleString('es-MX')}`, 14, 37);

                const rows = filteredList.map(p => [
                    p.id,
                    p.brand,
                    p.name,
                    catMap[p.category] || p.category,
                    p.created_at ? new Date(p.created_at).toLocaleDateString('es-MX') : '-',
                    p.compatibility || '-'
                ]);

                doc.autoTable({
                    head: [['ID', 'Marca', 'Nombre', 'Categoría', 'Alta', 'Compatibilidad']],
                    body: rows,
                    startY: 45,
                    margin: { left: 14, right: 14 },
                    styles: {
                        font: "helvetica",
                        fontSize: 8,
                        cellPadding: 4,
                        textColor: colors.text,
                        fillColor: isDark ? [0, 0, 0] : [255, 255, 255],
                        lineColor: colors.border,
                        lineWidth: 0.1,
                    },
                    headStyles: {
                        fillColor: colors.headBg,
                        textColor: colors.headText,
                        fontSize: 8,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: colors.alternateRow
                    },
                    tableLineColor: colors.border,
                    tableLineWidth: 0.1,
                });

                doc.save(`Inventario_Integral_${new Date().toISOString().split('T')[0]}.pdf`);
            } catch (err) {
                console.error(err);
                alert("Error al generar PDF: " + err.message);
            }
        }

        const catMap = { toner: 'TONERS', papeleria: 'PAPELERÍA', accesorios: 'ACCESORIOS' };

        let currentView = 'table';
        function setView(v) {
            currentView = v;
            document.getElementById('viewTable').classList.toggle('active', v === 'table');
            document.getElementById('viewGrid').classList.toggle('active', v === 'grid');
            document.getElementById('productTable').style.display = v === 'table' ? 'table' : 'none';
            document.getElementById('productGrid').style.display = v === 'grid' ? 'grid' : 'none';
            filterAndSort();
        }

        function renderTable(list) {
            updateDashboard(list);
            const tbody = document.querySelector('#productTable tbody');
            const grid = document.getElementById('productGrid');
            tbody.innerHTML = '';
            grid.innerHTML = '';

            let pending = 0;

            list.forEach(p => {
                // Common Logic
                const hasNoImage = !p.image || p.image.includes('logo.svg') || p.image.includes('default');
                const imgName = p.image ? p.image.split('/').pop() : 'logo.svg';
                const imgSrc = `/assets/${imgName}?v=${cacheBuster}`;
                const brandLogosrc = `/assets/${(p.brand || '').toLowerCase().replace(/[^a-z0-9]/g, '')}.png?v=${cacheBuster}`;

                if (p.published === 0) pending++;

                // 1. TABLE ROW
                const tr = document.createElement('tr');
                if (p.published === 0) tr.classList.add('pending');

                tr.innerHTML = `
                <td>
                    <div style="position:relative; width: 40px; height: 40px;">
                        ${hasNoImage ? `
                            <div class="no-image-placeholder" onclick='zoom("/assets/logo.svg")'>
                                <i class="fa-solid fa-face-dizzy"></i>
                                <span>SIN ASIGNAR</span>
                            </div>
                        ` : `
                            <img src="${imgSrc}" class="thumb" onclick='zoom("${imgSrc}")' onerror="this.src='/assets/logo.svg'">
                        `}
                        ${hasNoImage ? `
                            <div onclick='event.stopPropagation(); openImageWizard(${JSON.stringify(p.id)}, ${JSON.stringify(p.name)}, "product")' 
                                 style="position:absolute; bottom:-5px; right:-5px; background:var(--apple-blue); color:white; width:22px; height:22px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:10px; border:2px solid white; box-shadow:0 4px 12px rgba(0,0,0,0.3); z-index: 1;" 
                                 title="Agregar imagen inteligente">
                                <i class="fa-solid fa-wand-magic-sparkles"></i>
                            </div>
                        ` : ''}
                    </div>
                </td>
                <td><b>${p.id}</b></td>
                <td>
                    <div class="brand-container" data-brand="${p.brand || 'UNK'}" style="position:relative; display:flex; align-items:center; justify-content: center; background:#f8f9fa; padding:4px; border-radius:6px; border:1px solid #eee; width: 60px; height: 30px;">
                        <img src="${brandLogosrc}" 
                             style="max-width: 100%; max-height: 100%; object-fit: contain;" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block'; const wand = this.parentNode.querySelector('.brand-magic'); if(wand && ${p.brand && p.brand !== 'Otros' ? 'true' : 'false'}) wand.style.display='flex';">
                        <span style="display:none; font-size:10px; font-weight:600; color:#999; text-transform:uppercase;">${p.brand || 'S/M'}</span>
                        <div class="brand-magic" onclick='event.stopPropagation(); openImageWizard(${JSON.stringify(p.brand)}, "", "brand")' 
                             style="display:none; position:absolute; bottom:-5px; right:-5px; background:#ff2d55; color:white; width:22px; height:22px; border-radius:50%; align-items:center; justify-content:center; cursor:pointer; font-size:10px; border:2px solid white; box-shadow:0 2px 8px rgba(0,0,0,0.3); z-index: 2;" 
                             title="Agregar logo de marca">
                                <i class="fa-solid fa-wand-magic-sparkles"></i>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div style="font-weight:600; display:flex; align-items:center; gap:8px;">
                            ${p.name} ${p.published === 0 ? '<span class="pending-tag">NUEVO</span>' : ''}
                        </div>
                        <div class="p-desc" title="${p.description && p.description !== 'null' ? p.description : p.name}">
                            ${p.description && p.description !== 'null' ? p.description : p.name}
                        </div>
                    </td>
                    <td>${catMap[p.category] || p.category}</td>
                    <td class="date-cell" style="font-size: 11px; color: #666;">${p.created_at ? new Date(p.created_at).toLocaleDateString('es-MX') : '-'}</td>
                    <td>
                        <div style="display: flex; gap: 6px; white-space: nowrap;">
                            <button class="secondary" style="padding:6px 12px; font-size: 14px; border-radius: 6px;" onclick='editProduct(${JSON.stringify(p)})'>
                                <i class="fa-solid fa-pen-to-square"></i>
                            </button>
                            <button class="secondary" style="padding:6px 12px; font-size: 14px; border-radius: 6px; color: #0071e3;" title="Espiar Precios" onclick='scoutMarket(${JSON.stringify(p.id)}, ${JSON.stringify(p.name)}, "${imgSrc}")'>
                                <i class="fa-solid fa-magnifying-glass-dollar"></i>
                            </button>
                            <button class="danger" style="padding:6px 14px; font-size: 14px; border-radius: 6px; background: #ea4335; color: white; border: none;" onclick='deleteProduct(${JSON.stringify(p.id)})'>
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    </td>
                    `;
                tbody.appendChild(tr);

                // 2. GRID CARD (Audit Mode)
                const card = document.createElement('div');
                card.className = 'audit-card';
                if (p.published === 0) card.style.borderColor = 'var(--apple-blue)';

                card.innerHTML = `
                    <div style="position:relative; height: 180px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.02); border-radius: 12px 12px 0 0;">
                        ${hasNoImage ? `
                            <div class="no-image-placeholder" style="font-size: 12px; gap: 8px;">
                                <i class="fa-solid fa-face-dizzy" style="font-size: 32px;"></i>
                                <span>MULTIMEDIA NO ASIGNADA</span>
                            </div>
                        ` : `
                            <img src="${imgSrc}" class="card-img" onclick='zoom("${imgSrc}")' onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="no-image-placeholder" style="display:none; font-size: 12px; gap: 8px;">
                                <i class="fa-solid fa-face-dizzy" style="font-size: 32px;"></i>
                                <span>ERROR DE CARGA</span>
                            </div>
                        `}
                         ${hasNoImage ? `
                            <div onclick='event.stopPropagation(); openImageWizard(${JSON.stringify(p.id)}, ${JSON.stringify(p.name)}, "product")' 
                                 style="position:absolute; top:10px; right:10px; background:var(--apple-blue); color:white; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; border:2px solid white; box-shadow:0 4px 12px rgba(0,0,0,0.2); z-index: 1;" 
                                 title="Agregar imagen inteligente">
                                <i class="fa-solid fa-wand-magic-sparkles"></i>
                            </div>
                        ` : ''}

                        <div class="card-brand" data-brand="${p.brand || 'UNK'}" style="position:relative;">
                            <img src="${brandLogosrc}" style="max-height: 16px; object-fit: contain;" 
                                 onerror="this.outerHTML='<span>${p.brand}</span>'; const wand = this.parentNode ? this.parentNode.querySelector('.brand-magic') : null; if(wand && ${p.brand && p.brand !== 'Otros' ? 'true' : 'false'}) wand.style.display='flex';">
                            <div class="brand-magic" onclick='event.stopPropagation(); openImageWizard(${JSON.stringify(p.brand)}, "", "brand")' 
                                 style="display:none; position:absolute; bottom:-5px; right:-5px; background:#ff2d55; color:white; width:16px; height:16px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:8px; border:1px solid white; z-index: 2;">
                                <i class="fa-solid fa-wand-magic-sparkles"></i>
                            </div>
                        </div>
                    </div>

                    <div class="card-content">
                        <div class="card-id">${p.id}</div>
                        <div class="card-title">${p.name}</div>
                        
                        <div class="card-actions">
                            <button class="secondary" style="flex:1; padding:6px; justify-content:center;" onclick='editProduct(${JSON.stringify(p)})'>
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            <button class="secondary" style="flex:1; padding:6px; justify-content:center; color: var(--apple-blue);" onclick='scoutMarket(${JSON.stringify(p.id)}, ${JSON.stringify(p.name)}, "${imgSrc}")'>
                                <i class="fa-solid fa-satellite-dish"></i>
                            </button>
                            <button class="danger" style="flex:1; padding:6px; background: #ea4335; color: white; border: none; justify-content:center;" onclick='deleteProduct(${JSON.stringify(p.id)})'>
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });

            const badge = document.getElementById('pendingCount');
            if (pending > 0) { badge.innerText = `${pending} pendientes`; badge.style.display = 'block'; }
            else { badge.style.display = 'none'; }
        }

        async function handleFileUpload(file) {
            if (!file) return;
            const dropZone = document.getElementById('dropZone');
            dropZone.innerHTML = "⏳ Subiendo...";
            const formData = new FormData();
            formData.append('image', file);
            const res = await fetch('/api/upload', { method: 'POST', body: formData });
            const data = await res.json();
            document.getElementById('p_image').value = data.url;
            dropZone.innerHTML = `<img src="/${data.url}" style="height:60px; border-radius:4px;">`;
        }

        async function saveProduct() {
            const id = document.getElementById('p_id').value.trim();
            if (!id) return alert("❌ El ID/Modelo es obligatorio.");

            const name = document.getElementById('p_name').value;
            let description = document.getElementById('p_description').value;

            // Lógica: Si no hay descripción o es "null", copiar el nombre
            if (!description || !description.trim() || description.toLowerCase() === 'null') description = name;

            const body = {
                id,
                name,
                category: document.getElementById('p_category').value,
                brand: document.getElementById('p_brand').value,
                price: 0,
                stock: 0,
                compatibility: document.getElementById('p_compatibility').value,
                image: document.getElementById('p_image').value,
                description
            };

            const isEdit = products.find(p => p.id === id);
            const method = isEdit ? 'PUT' : 'POST';
            const url = isEdit ? `/api/products/${id}` : '/api/products';

            const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            if (!res.ok) {
                const errData = await res.json();
                alert("Error al guardar: " + (errData.error || "Desconocido"));
                return;
            }
            closeModal();
            loadProducts();
        }

        async function publishChanges() {
            const btn = document.getElementById('btnPublish');
            const isCyber = document.body.getAttribute('data-theme') === 'cyberpunk';

            btn.innerText = isCyber ? "CARGANDO..." : "⏳ PROCESANDO...";
            btn.disabled = true;
            await fetch('/api/publish', { method: 'POST' });
            btn.innerText = isCyber ? "SISTEMA ACTUALIZADO" : "✅ ¡WEB ACTUALIZADA!";
            setTimeout(() => {
                btn.innerText = isCyber ? "ENVIAR A LA WEB" : "🚀 ENVIAR A LA WEB";
                btn.disabled = false;
                loadProducts();
            }, 3000);
        }

        async function deletePendingProducts() {
            if (!confirm("⚠️ ¿Estás seguro de que deseas borrar TODOS los productos pendientes?\n\nEsto eliminará los productos que acabas de subir y que aún no has enviado a la web. Esta acción no se puede deshacer.")) return;

            try {
                const res = await fetch('/api/products/pending', { method: 'DELETE' });
                const data = await res.json();
                if (data.message === "OK") {
                    alert(`✅ Se borraron ${data.changes} productos pendientes.`);
                    loadProducts();
                }
            } catch (err) {
                alert("Error al borrar pendientes: " + err.message);
            }
        }

        function newProduct() {
            document.getElementById('modalTitle').innerText = "Nuevo Producto";
            document.getElementById('p_id').value = ""; document.getElementById('p_id').disabled = false;
            document.getElementById('p_name').value = ""; document.getElementById('p_brand').value = "";
            document.getElementById('p_compatibility').value = ""; document.getElementById('p_image').value = "";
            document.getElementById('p_description').value = "";
            document.getElementById('dropZone').innerHTML = "📁 Arrastra o selecciona la foto";
            document.getElementById('modal').style.display = 'flex';
        }

        function editProduct(p) {
            document.getElementById('modalTitle').innerText = "Editar Producto";
            document.getElementById('p_id').value = p.id; document.getElementById('p_id').disabled = true;
            document.getElementById('p_name').value = p.name;
            document.getElementById('p_brand').value = p.brand || "";
            document.getElementById('p_category').value = p.category;
            document.getElementById('p_image').value = p.image || "";
            document.getElementById('p_compatibility').value = p.compatibility || "";
            document.getElementById('p_description').value = p.description || "";
            let imgName = p.image ? p.image.split('/').pop() : 'logo.svg';
            document.getElementById('dropZone').innerHTML = `<img src="/assets/${imgName}" style="height:60px; border-radius:4px;">`;
            document.getElementById('modal').style.display = 'flex';
        }

        function openBulkModal() { document.getElementById('bulkModal').style.display = 'flex'; }
        function closeBulkModal() { document.getElementById('bulkModal').style.display = 'none'; }

        let pendingBulkData = { newItems: [], conflicts: [], images: null };

        async function processBulk() {
            const csvFile = document.getElementById('bulkCSV').files[0];
            const imagesArr = document.getElementById('bulkImages').files;
            if (!csvFile) return alert("Selecciona un CSV");

            const btn = document.getElementById('btnProcessBulk');
            btn.disabled = true;

            Papa.parse(csvFile, {
                header: true,
                skipEmptyLines: true,
                complete: async (results) => {
                    const data = results.data;
                    const newItems = [];
                    const conflicts = [];

                    data.forEach(row => {
                        const id = row.id || row.ID || row.Id;
                        if (!id) return;
                        if (products.some(p => p.id == id)) {
                            conflicts.push(row);
                        } else {
                            newItems.push(row);
                        }
                    });

                    btn.disabled = false;
                    pendingBulkData = { newItems, conflicts, images: imagesArr };

                    if (conflicts.length > 0) {
                        document.getElementById('newItemsCount').innerText = newItems.length;
                        document.getElementById('conflictItemsCount').innerText = conflicts.length;
                        document.getElementById('newItemsList').innerHTML = newItems.map(i => `• ${i.id || i.ID || i.Id}`).join('<br>');
                        document.getElementById('conflictItemsList').innerHTML = conflicts.map(i => `• ${i.id || i.ID || i.Id}`).join('<br>');
                        document.getElementById('bulkConflictModal').style.display = 'flex';
                    } else {
                        executeBulkImport(true);
                    }
                }
            });
        }

        async function executeBulkImport(overwriteExisting) {
            document.getElementById('bulkConflictModal').style.display = 'none';
            const progress = document.getElementById('bulkProgress');
            const bar = document.getElementById('progressBar');
            const text = document.getElementById('progressText');

            const toProcess = overwriteExisting
                ? [...pendingBulkData.newItems, ...pendingBulkData.conflicts]
                : pendingBulkData.newItems;

            if (toProcess.length === 0) {
                alert("No hay productos nuevos para cargar.");
                return;
            }

            progress.style.display = 'block';
            const total = toProcess.length;
            let count = 0;
            const images = pendingBulkData.images;

            for (const row of toProcess) {
                try {
                    const id = row.id || row.ID || row.Id;
                    if (!id) continue;

                    // Buscar imagen
                    let imageUrl = '';
                    if (images && images.length > 0) {
                        const matchingImage = Array.from(images).find(f => {
                            const nameNoExt = f.name.split('.').slice(0, -1).join('.');
                            return nameNoExt.toLowerCase() === id.toString().toLowerCase();
                        });

                        if (matchingImage) {
                            const formData = new FormData();
                            formData.append('image', matchingImage);
                            const uploadRes = await fetch('/api/upload', { method: 'POST', body: formData });
                            const uploadData = await uploadRes.json();
                            imageUrl = uploadData.url;
                        }
                    }

                    const name = row.name || row.Nombre || '';
                    let description = row.description || row.descripcion || row.Descripción || '';
                    if (!description || !description.trim() || description.toLowerCase() === 'null') description = name;

                    let brand = row.brand || row.Marca || 'Otros';
                    const standardBrands = ['HP', 'Brother', 'Canon', 'Lexmark', 'Xerox'];
                    const standardMatch = standardBrands.find(b => b.toLowerCase() === brand.trim().toLowerCase());
                    if (standardMatch) brand = standardMatch;

                    const productData = {
                        id: id,
                        name: name,
                        category: row.category || row.Categoria || 'toner',
                        brand: brand,
                        price: 0,
                        stock: 0,
                        compatibility: row.compatibility || row.Compatibilidad || '',
                        image: imageUrl,
                        description: description
                    };

                    const exists = products.find(p => p.id == id);
                    const method = exists ? 'PUT' : 'POST';
                    const url = exists ? `/api/products/${id}` : '/api/products';

                    await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(productData)
                    });

                } catch (err) {
                    console.error("Bulk Item Error:", err);
                }

                count++;
                const pct = Math.round((count / total) * 100);
                bar.style.width = pct + '%';
                text.innerText = `Procesando ${count} de ${total}...`;
            }

            alert("Carga masiva completada");
            progress.style.display = 'none';
            closeBulkModal();
            loadProducts();
        }

        async function scoutMarket(model, name = "", image = "") {
            const modal = document.getElementById('scoutModal');
            const resultsDiv = document.getElementById('scoutResults');
            const loading = document.getElementById('scoutLoading');

            // Set Header Info
            document.getElementById('scoutProductImg').src = image || '/assets/logo.svg';
            document.getElementById('scoutProductModel').innerText = model;
            document.getElementById('scoutProductName').innerText = name;

            resultsDiv.innerHTML = '';
            loading.style.display = 'block';
            modal.style.display = 'flex';

            try {
                const res = await fetch(`/api/scout-price/${encodeURIComponent(model)}?name=${encodeURIComponent(name)}`);
                const data = await res.json();
                loading.style.display = 'none';

                if (!data.data || data.data.length === 0) {
                    resultsDiv.innerHTML = '<p style="text-align:center; color:#999;">No se encontraron precios competitivos en este momento.</p>';
                    return;
                }

                data.data.forEach(item => {
                    const row = document.createElement('div');
                    row.style = 'padding:12px; border-bottom:1px solid var(--apple-border); display:flex; justify-content:space-between; align-items:center;';
                    row.innerHTML = `
                        <div style="flex-grow:1; padding-right:10px;">
                            <div style="font-weight:600; font-size:13px;">${item.store || 'Referencia'}</div>
                            <div style="font-size:11px; color:#666;">${item.title}</div>
                        </div>
                        <div style="display:flex; flex-direction:column; align-items:flex-end;">
                            <div style="font-weight:700; color:var(--apple-blue); min-width:80px; text-align:right;">${item.priceText}</div>
                            ${item.url ? `<a href="${item.url}" target="_blank" style="font-size:10px; color:var(--apple-blue); text-decoration:none; margin-top:4px;"><i class="fa-solid fa-arrow-up-right-from-square"></i> Ver sitio</a>` : ''}
                        </div>
                    `;
                    resultsDiv.appendChild(row);
                });
            } catch (err) {
                loading.style.display = 'none';
                resultsDiv.innerHTML = '<p style="color:red; text-align:center;">Error al conectar con el Radar de Mercado.</p>';
            }
        }

        let wizardMode = 'product'; // 'product' or 'brand'
        let currentWizardTarget = null;
        function updateDashboard(list) {
            const total = list.length;
            const pending = list.filter(p => p.published === 0).length;
            const withPhoto = list.filter(p => p.image && !p.image.includes('logo.svg') && !p.image.includes('default')).length;
            const photoPct = total > 0 ? Math.round((withPhoto / total) * 100) : 0;
            const brands = new Set(list.map(p => p.brand).filter(b => b)).size;

            document.getElementById('statTotal').innerText = total;
            document.getElementById('statPhotos').innerText = `${photoPct}%`;
            document.getElementById('photoProgress').style.width = `${photoPct}%`;
            document.getElementById('statPending').innerText = pending;
            document.getElementById('statBrands').innerText = brands;

            const publishAlert = document.getElementById('publishAlert');
            publishAlert.style.display = pending > 0 ? 'block' : 'none';

            const btnDel = document.getElementById('btnDeletePending');
            if (btnDel) btnDel.style.display = pending > 0 ? 'block' : 'none';
        }

        function fixNextPhoto() {
            const next = products.find(p => !p.image || p.image.includes('logo.svg') || p.image.includes('default'));
            if (next) {
                // Focus search and highlight next item
                document.getElementById('search').value = next.id;
                filterAndSort();
                if (currentView === 'table') {
                    const row = document.querySelector(`tr:has(td:contains('${next.id}'))`);
                    if (row) row.classList.add('highlight-fix'); // Add a brief highlight class
                }
                openImageWizard(next.id, next.name, 'product');
            } else {
                alert("🎉 ¡Felicidades! Todos los productos tienen imagen.");
            }
        }

        function openWizardFromEditor() {
            const id = document.getElementById('p_id').value.trim();
            const name = document.getElementById('p_name').value.trim();
            if (!id) return alert("Por favor, ingresa el ID/Modelo antes de usar el asistente.");
            openImageWizard(id, name, 'product');
        }

        function openBrandWizardFromEditor() {
            const brand = document.getElementById('p_brand').value;
            if (!brand || brand === 'Otros') return alert("Selecciona una marca válida para buscar su logo.");
            openImageWizard(brand, '', 'brand');
        }

        function openImageWizard(targetId, targetName, mode = 'product') {
            wizardMode = mode;
            currentWizardTarget = { id: targetId, name: targetName };

            const title = document.getElementById('wizardTitle');
            const subTitle = document.getElementById('wizardProductTitle');
            const searchBtn = document.getElementById('btnWizardSearch');

            if (mode === 'product') {
                title.innerText = "Asistente de Imagen";
                subTitle.innerText = `${targetId} - ${targetName}`;
                searchBtn.onclick = () => window.open(`https://www.google.com/search?q=${encodeURIComponent(targetId + ' ' + targetName + ' toner producto')}&tbm=isch`, '_blank');
            } else {
                title.innerText = "Asistente de Logo";
                subTitle.innerText = `Marca: ${targetId}`;
                searchBtn.onclick = () => window.open(`https://www.google.com/search?q=${encodeURIComponent(targetId + ' logo png official')}&tbm=isch`, '_blank');
            }

            document.getElementById('wizardImageUrl').value = '';
            document.getElementById('wizardStatus').style.display = 'none';
            document.getElementById('imageWizardModal').style.display = 'flex';
        }

        async function importWizardImage() {
            const url = document.getElementById('wizardImageUrl').value.trim();
            if (!url) return alert("Por favor, pega un enlace de imagen.");

            const status = document.getElementById('wizardStatus');
            const statusText = document.getElementById('wizardStatusText');
            status.style.display = 'block';
            statusText.innerText = "Procesando imagen...";

            const endpoint = wizardMode === 'product' ? '/api/import-image-url' : '/api/import-brand-logo';
            const body = wizardMode === 'product'
                ? { productId: currentWizardTarget.id, imageUrl: url }
                : { brandName: currentWizardTarget.id, imageUrl: url };

            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await res.json();
                if (data.success) {
                    statusText.innerText = `✅ ¡Éxito! ${wizardMode === 'product' ? 'Imagen' : 'Logo'} actualizado.`;
                    cacheBuster = Date.now(); // Force refresh images
                    setTimeout(() => {
                        document.getElementById('imageWizardModal').style.display = 'none';
                        loadProducts();
                    }, 1500);
                } else {
                    throw new Error(data.error);
                }
            } catch (err) {
                statusText.innerText = `❌ Error: ${err.message}`;
            }
        }

        async function deleteProduct(id) {
            const productToDelete = products.find(p => p.id === id);
            if (!confirm(`¿Estás seguro de que deseas eliminar el producto "${id}"?`)) return;
            try {
                const res = await fetch(`/api/products/${encodeURIComponent(id)}`, { method: 'DELETE' });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Error al eliminar');

                if (data.changes === 0) {
                    alert("No se encontró el producto para eliminar.");
                } else {
                    // Guardar en la papelera antes de recargar
                    auditManager.logDeletion(productToDelete);
                    loadProducts();
                }
            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
            }
        }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }
        function zoom(src) { document.getElementById('zoomedImg').src = src; document.getElementById('zoomOverlay').style.display = 'flex'; }

        function toggleTheme(specific) {
            const current = document.body.getAttribute('data-theme');
            let target;

            if (specific === 'fallout') {
                target = current === 'fallout' ? 'light' : 'fallout';
            } else if (specific === 'cyberpunk') {
                target = current === 'cyberpunk' ? 'light' : 'cyberpunk';
            } else {
                target = current === 'dark' ? 'light' : 'dark';
            }

            document.body.setAttribute('data-theme', target);
            localStorage.setItem('integral-theme', target);
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const current = document.body.getAttribute('data-theme');
            const icon = document.querySelector('#themeToggle i');
            const falloutBtn = document.getElementById('falloutToggle');
            const cyberBtn = document.getElementById('cyberToggle');

            // Reset
            falloutBtn.style.color = ''; falloutBtn.style.borderColor = '';
            cyberBtn.style.color = ''; cyberBtn.style.borderColor = '';

            if (current === 'fallout') {
                icon.className = 'fa-solid fa-terminal';
                falloutBtn.style.color = '#18ff62';
                falloutBtn.style.borderColor = '#18ff62';
            } else if (current === 'cyberpunk') {
                icon.className = 'fa-solid fa-bolt-lightning';
                cyberBtn.style.color = '#f3e600';
                cyberBtn.style.borderColor = '#f3e600';
            } else {
                icon.className = 'fa-solid fa-moon';
            }

            // --- HP Secret Button Logic ---
            const hpBtn = document.getElementById('hpSecretBtn');
            const hpMenu = document.getElementById('hpMenu');
            if (current === 'dark' || current.startsWith('hp-')) {
                hpBtn.style.display = 'flex';
            } else {
                hpBtn.style.display = 'none';
                if (hpMenu) hpMenu.style.display = 'none';
            }

            // Fix botón publicar en modo Cyberpunk
            const btnPublish = document.getElementById('btnPublish');
            if (current === 'cyberpunk') {
                btnPublish.innerText = "ENVIAR A LA WEB";
            } else {
                btnPublish.innerText = "🚀 ENVIAR A LA WEB";
            }
        }

        function toggleHPMenu() {
            const menu = document.getElementById('hpMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        function setHPTheme(house) {
            if (house === 'clear') {
                document.body.removeAttribute('data-theme');
                document.body.setAttribute('data-theme', 'dark');
                const sparks = document.querySelector('.magic-sparks');
                if (sparks) sparks.remove();
            } else {
                document.body.setAttribute('data-theme', 'hp-' + house);
                if (!document.querySelector('.magic-sparks')) {
                    const sparks = document.createElement('div');
                    sparks.className = 'magic-sparks';
                    document.body.appendChild(sparks);
                }
            }
            document.getElementById('hpMenu').style.display = 'none';
            updateThemeIcon();
        }

        document.addEventListener('click', (e) => {
            const menu = document.getElementById('hpMenu');
            if (menu && !e.target.closest('#hpSecretBtn') && !e.target.closest('#hpMenu')) {
                menu.style.display = 'none';
            }
        });

        // Init Theme
        const savedTheme = localStorage.getItem('integral-theme') || 'light';
        document.body.setAttribute('data-theme', savedTheme);
        updateThemeIcon();

        window.addEventListener('keydown', (e) => { if (e.key === "Escape") closeModal(); });

        // --- SISTEMA DE AUDITORÍA Y PAPELERA ---
        const auditManager = {
            logs: JSON.parse(localStorage.getItem('auditLogs') || '[]'),
            trash: JSON.parse(localStorage.getItem('trashInventory') || '[]'),

            save() {
                localStorage.setItem('auditLogs', JSON.stringify(this.logs.slice(0, 50)));
                localStorage.setItem('trashInventory', JSON.stringify(this.trash.slice(0, 20)));
                this.render();
            },

            logAction(type, message, details = "", backup = null) {
                this.logs.unshift({
                    type,
                    message,
                    details,
                    backup, // Guardamos el estado anterior para el "Undo"
                    time: new Date().toLocaleTimeString()
                });
                this.save();
            },

            logDeletion(product) {
                if (!product) return;
                this.trash.unshift({ ...product, deletedAt: new Date().getTime() });
                this.logAction('delete', `Eliminado: ${product.id}`, product.name);
                this.save();
            },

            async undoUpdate(logIndex) {
                const log = this.logs[logIndex];
                if (!log || !log.backup) return;

                if (!confirm(`¿Deshacer cambios y volver al estado anterior de "${log.backup.id}"?`)) return;

                try {
                    const res = await fetch(`/api/products/${log.backup.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(log.backup)
                    });
                    if (res.ok) {
                        this.logs.splice(logIndex, 1);
                        this.logAction('create', `↩️ Revertido: ${log.backup.id}`);
                        this.save();
                        loadProducts();
                    } else {
                        alert("Error al revertir los cambios.");
                    }
                } catch (err) {
                    alert("Error mágico al deshacer");
                }
            },

            async restoreProduct(id) {
                const index = this.trash.findIndex(p => p.id === id);
                if (index === -1) return;
                const product = this.trash[index];

                try {
                    const res = await fetch('/api/products', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(product)
                    });
                    if (res.ok) {
                        this.trash.splice(index, 1);
                        this.logAction('create', `Restaurado: ${product.id}`);
                        this.save();
                        loadProducts();
                    } else {
                        alert("Error al restaurar. Puede que el ID ya exista.");
                    }
                } catch (err) {
                    alert("Error mágico al restaurar");
                }
            },

            render() {
                const logEl = document.getElementById('logContent');
                const trashEl = document.getElementById('trashContent');
                if (!logEl || !trashEl) return;

                if (this.logs.length === 0) {
                    logEl.innerHTML = '<div style="text-align:center; padding-top:40px; opacity:0.5">Sin actividad reciente</div>';
                } else {
                    logEl.innerHTML = this.logs.map((l, index) => `
                        <div class="log-entry ${l.type}" style="position:relative">
                            <div style="display:flex; justify-content:space-between; align-items:center; width:100%">
                                <div style="flex:1; padding-right:10px">
                                    <strong style="display:block; margin-bottom:2px">${l.message}</strong>
                                    <div style="opacity:0.75; font-size:11px; line-height:1.2">${l.details || ''}</div>
                                </div>
                                ${l.type === 'update' && l.backup ? `
                                    <button class="btn-undo" onclick="auditManager.undoUpdate(${index})" 
                                            style="padding: 6px 10px; flex-shrink:0; background: var(--apple-blue); color:white; border:none; box-shadow: 0 2px 8px rgba(0,113,227,0.3)">
                                        ↩️ DESHACER
                                    </button>` : ''}
                            </div>
                            <span class="time">${l.time}</span>
                        </div>
                    `).join('');
                }
                // ... trash rendering stays the same ...
                if (this.trash.length === 0) {
                    trashEl.innerHTML = '<div style="text-align:center; padding-top:40px; opacity:0.5">La papelera está vacía</div>';
                } else {
                    trashEl.innerHTML = this.trash.map(p => `
                        <div class="trash-item">
                            <img src="${p.image || 'https://via.placeholder.com/40'}" onerror="this.src='https://via.placeholder.com/40'">
                            <div style="flex:1">
                                <div style="font-size:11px; font-weight:bold">${p.id}</div>
                                <div style="font-size:9px; opacity:0.7">${p.name.substring(0, 25)}...</div>
                            </div>
                            <button class="btn-restore" onclick="auditManager.restoreProduct('${p.id}')">RESTAURAR</button>
                        </div>
                    `).join('');
                }
            }
        };

        function toggleHistory() {
            const side = document.getElementById('historySidebar');
            side.classList.toggle('open');
            if (side.classList.contains('open')) auditManager.render();
        }

        function showHistoryTab(tab) {
            document.getElementById('logContent').style.display = tab === 'log' ? 'block' : 'none';
            document.getElementById('trashContent').style.display = tab === 'trash' ? 'block' : 'none';
            document.getElementById('tabLog').classList.toggle('active', tab === 'log');
            document.getElementById('tabTrash').classList.toggle('active', tab === 'trash');
        }

        // Interceptor robusto para cambios
        const originalSave = saveProduct;
        saveProduct = async function () {
            const id = document.getElementById('p_id').value;
            // Capturar estado ANTES de que el original lo cambie
            const existingProduct = products.find(p => p.id === id);
            const backup = existingProduct ? JSON.parse(JSON.stringify(existingProduct)) : null;

            try {
                await originalSave(); // Ejecutar guardado real

                // Si el originalSave terminó sin errores, procedemos al log
                if (existingProduct) {
                    auditManager.logAction('update', `Actualizado: ${id}`, document.getElementById('p_name').value, backup);
                } else {
                    auditManager.logAction('create', `Creado: ${id}`, document.getElementById('p_name').value);
                }
            } catch (err) {
                console.error("Error en interceptor de guardado:", err);
            }
        };

        // RADAR DE PRECIOS ACTIVO (Simulación Inteligente)
        async function runPriceRadar() {
            const container = document.getElementById('radarContainer');
            container.innerHTML = `
                <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%;">
                    <i class="fa-solid fa-circle-notch fa-spin" style="font-size:30px; color:var(--apple-blue); margin-bottom:15px;"></i>
                    <div style="font-size:12px; font-weight:600; animation: pulse 1.5s infinite;">Escaneando Amazon MX y Mercado Libre...</div>
                </div>
            `;

            // Simular delay de red
            await new Promise(r => setTimeout(r, 2500));

            const topSales = products.slice(0, 3); // Analizar los primeros 3 para el ejemplo
            container.innerHTML = `
                <div style="text-align:left; font-size:11px;">
                    <div style="margin-bottom:8px; font-weight:700; color:var(--apple-blue); text-transform:uppercase; letter-spacing:1px;">Top Competencia (MX)</div>
                    ${topSales.map(p => `
                        <div style="background:rgba(0,0,0,0.03); padding:8px; border-radius:8px; margin-bottom:6px; border:1px solid var(--apple-border);">
                            <div style="font-weight:600;">${p.name}</div>
                            <div style="display:flex; justify-content:space-between; margin-top:4px;">
                                <span style="opacity:0.6;">Mercado Libre: $${(Math.random() * 5000 + 2000).toFixed(2)}</span>
                                <span style="color:#34c759; font-weight:700;">Estamos -5%</span>
                            </div>
                        </div>
                    `).join('')}
                    <button class="secondary" onclick="runPriceRadar()" style="width:100%; margin-top:10px; font-size:10px;">RE-ESCANEAR</button>
                </div>
            `;
        }

        // DETALLES DE TENDENCIAS
        function showTrendDetail(type) {
            const modal = document.getElementById('trendDetailModal');
            const title = document.getElementById('trendDetailTitle');
            const body = document.getElementById('trendDetailBody');

            const data = {
                intel2026: {
                    t: "Intel Arrow Lake-S Refresh (Marzo 2026)",
                    b: "Lanzamiento inminente. Estas CPUs traen hasta un 10% más de rendimiento en gaming y soporte oficial para DDR5-7200. <br><br><b>Estrategia MX:</b> El 23 de marzo salen las reseñas de los Ultra 7 y Ultra 5. Ideal para mover stock de motherboards LGA-1851."
                },
                rtx50super: {
                    t: "NVIDIA RTX 50 SUPER (GDDR7)",
                    b: "Disponibilidad crítica en México. Las 5080 y 5090 SUPER están volando por la fiebre de la IA. <br><br><b>Estrategia MX:</b> Si tienes stock, es el momento de 'Precio Premium'. La falta de memoria GDDR7 está limitando el suministro global."
                },
                amdryzen2026: {
                    t: "AMD Ryzen AI 400 / Zen 5 X3D",
                    b: "AMD domina el sector de 'AI PCs' en México con los nuevos Ryzen 400. Se esperan los modelos X3D para marzo. <br><br><b>Estrategia MX:</b> Destacar el rendimiento por watt, clave para laptops en el mercado corporativo mexicano este semestre."
                },
                apple2026: {
                    t: "MacBook Pro/Air M5 (Marzo 2026)",
                    b: "Rumores fuertes de lanzamiento en marzo para la línea M5. <br><br><b>Estrategia MX:</b> Muchos clientes en Amazon MX están esperando este lanzamiento. Oportunidad para rematar inventario de M3 y M4 antes de la llegada del M5."
                }
            };

            const info = data[type];
            title.innerText = info.t;
            body.innerHTML = info.b;
            modal.style.display = 'flex';
        }

        // SISTEMA DE AUDITORÍA SEO
        function runSEOAudit() {
            if (!products || products.length === 0) return;

            const issues = {
                noDesc: [],
                shortTitle: [],
                noBrand: [],
                imageGap: []
            };

            products.forEach(p => {
                if (!p.description || p.description === 'null' || p.description.length < 10) issues.noDesc.push(p);
                if (p.name.length < 15) issues.shortTitle.push(p);
                if (!p.brand || p.brand === 'Otros') issues.noBrand.push(p);
                if (!p.image || p.image.includes('logo.svg')) issues.imageGap.push(p);
            });

            const totalIssues = issues.noDesc.length + issues.shortTitle.length + issues.imageGap.length;
            const health = Math.max(0, 100 - Math.round((totalIssues / (products.length * 3)) * 100));

            const badge = document.getElementById('seoQualityBadge');
            badge.innerHTML = `Salud del Catálogo: <span style="color:${health > 80 ? '#34c759' : '#ff9f0a'}">${health}%</span>`;

            const container = document.getElementById('seoSuggestions');
            container.innerHTML = '';

            const addSuggestion = (title, count, text, icon, color) => {
                if (count === 0) return;
                const div = document.createElement('div');
                div.style = `background:rgba(${color},0.05); padding:12px; border-radius:12px; border:1px solid rgba(${color},0.1); cursor:pointer; transition:0.3s;`;
                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <i class="fa-solid ${icon}" style="color:rgb(${color})"></i>
                        <div style="flex:1">
                            <div style="font-weight:600; font-size:12px;">${title} (${count})</div>
                            <div style="font-size:11px; opacity:0.7;">${text}</div>
                        </div>
                        <i class="fa-solid fa-chevron-right" style="font-size:10px; opacity:0.3"></i>
                    </div>
                `;
                div.onclick = () => {
                    switchView('catalog');
                    const searchBox = document.getElementById('search');
                    // Simular una búsqueda o filtro para estos problemas
                    alert(`Mostrando los ${count} productos con este problema...`);
                };
                container.appendChild(div);
            };

            addSuggestion("Faltan Descripciones", issues.noDesc.length, "Los buscadores ignoran productos sin texto.", "fa-align-left", "255, 59, 48");
            addSuggestion("Títulos muy cortos", issues.shortTitle.length, "Agrega marca y modelo para rankear mejor.", "fa-heading", "0, 113, 227");
            addSuggestion("Imágenes Pendientes", issues.imageGap.length, "El 90% de las ventas entran por los ojos.", "fa-image", "255, 159, 10");
        }

        let globalIntelData = null;
        let currentIntelCat = 'computo';

        function switchIntelTab(cat) {
            currentIntelCat = cat;
            document.querySelectorAll('.intel-tab').forEach(tab => {
                const isActive = tab.getAttribute('onclick').includes(`'${cat}'`);
                tab.style.background = isActive ? 'var(--apple-blue)' : 'rgba(0,0,0,0.05)';
                tab.style.color = isActive ? 'white' : 'var(--apple-text)';
            });
            renderMarketHotlist();
        }

        async function renderMarketHotlist(refresh = false) {
            const container = document.getElementById('marketHotlistContainer');

            // Si no hay refresh y ya tenemos data global, solo renderizar el tab activo
            if (!refresh && globalIntelData) {
                renderHotlistFromData(globalIntelData[currentIntelCat]);
                return;
            }

            // Estado de carga
            container.innerHTML = `
                <div style="text-align:center; padding:50px; opacity:0.6;">
                    <i class="fa-solid fa-circle-notch fa-spin" style="font-size:30px; color:var(--apple-blue); margin-bottom:15px;"></i>
                    <div>Consultando mercados de México en tiempo real...</div>
                    <div style="font-size:10px; margin-top:10px;">Escaneando Computación, Papelería y Consumibles...</div>
                </div>
            `;

            try {
                const url = refresh ? '/api/market-trends?forceRefresh=true' : '/api/market-trends';
                const response = await fetch(url);
                globalIntelData = await response.json();

                renderHotlistFromData(globalIntelData[currentIntelCat]);
                container.setAttribute('data-loaded', 'true');

            } catch (err) {
                console.error("Error al cargar inteligencia:", err);
                container.innerHTML = `
                    <div style="text-align:center; padding:30px; color:#ff3b30;">
                        <i class="fa-solid fa-circle-exclamation" style="font-size:30px; margin-bottom:10px;"></i>
                        <div>No se pudieron cargar los datos de tendencia.</div>
                        <button onclick="renderMarketHotlist(true)" style="margin-top:10px; font-size:11px;">REINTENTAR</button>
                    </div>
                `;
            }
        }

        function renderHotlistFromData(data) {
            const container = document.getElementById('marketHotlistContainer');
            if (!data) return;

            let html = `
                <table style="width:100%; border-collapse:collapse; font-size:13px;">
                    <thead>
                        <tr style="text-align:left; border-bottom:1px solid var(--apple-border); opacity:0.7; font-size:11px;">
                            <th style="padding:10px 5px;">#</th>
                            <th style="padding:10px 5px;">PRODUCTO / MODELO</th>
                            <th style="padding:10px 5px;">DEMANDA (MX)</th>
                            <th style="padding:10px 5px;">PRECIO MIN. (MXN)</th>
                            <th style="padding:10px 5px;">PRECIO MAX. (MXN)</th>
                            <th style="padding:10px 5px;">RECOMENDACIÓN</th>
                            <th style="padding:10px 5px;">ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach((p, i) => {
                const scoreColor = i < 5 ? "#34c759" : (i < 15 ? "#ff9f0a" : "var(--apple-blue)");
                const minStr = p.minP.toLocaleString('es-MX', { style: 'currency', currency: 'MXN' });
                const maxStr = p.maxP.toLocaleString('es-MX', { style: 'currency', currency: 'MXN' });

                // Lógica de Sugerencia Inteligente
                let sugerencia = "Monitorear";
                let sugColor = "rgba(0,0,0,0.05)";
                if (parseFloat(p.demanda) > 95) {
                    sugerencia = "¡Alta Demanda! Comprar";
                    sugColor = "rgba(52, 199, 89, 0.1)";
                } else if (p.opti === "ALTO MARGEN") {
                    sugerencia = "Revisar Precio Venta";
                    sugColor = "rgba(255, 159, 10, 0.1)";
                }

                // Generar Link de Búsqueda Inteligente (Usa Marca + Nombre para asegurar resultados)
                const searchQuery = `${p.b} ${p.n}`;
                const verificationUrl = `https://listado.mercadolibre.com.mx/${encodeURIComponent(searchQuery)}`;

                html += `
                    <tr style="border-bottom:1px solid rgba(0,0,0,0.03);">
                        <td style="padding:12px 5px; font-weight:700; opacity:0.3;">${i + 1}</td>
                        <td style="padding:12px 5px;">
                            <div style="font-weight:600;">${p.b} ${p.n}</div>
                            <a href="${verificationUrl}" target="_blank" style="font-size:10px; color:var(--apple-blue); text-decoration:none; display:flex; align-items:center; gap:4px;">
                                <i class="fa-solid fa-magnifying-glass" style="font-size:8px;"></i> ${p.id} (Buscar en Mercado Libre)
                            </a>
                        </td>
                        <td style="padding:12px 5px;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <div style="width:60px; height:4px; background:rgba(0,0,0,0.05); border-radius:2px;">
                                    <div style="width:${p.demanda}; height:100%; background:${scoreColor}; border-radius:2px;"></div>
                                </div>
                                <span style="font-size:10px; width:35px;">${p.demanda}</span>
                            </div>
                        </td>
                        <td style="padding:12px 5px; font-weight:700; color:#34c759;">${minStr}</td>
                        <td style="padding:12px 5px; font-weight:700; color:#ff3b30;">${maxStr}</td>
                        <td style="padding:12px 5px;">
                            <span style="background:${sugColor}; padding:3px 8px; border-radius:12px; font-size:10px; font-weight:700;">${sugerencia}</span>
                        </td>
                        <td style="padding:12px 5px;">
                            <button onclick="window.open('${verificationUrl}', '_blank')" class="secondary" style="font-size:9px; padding:4px 8px; border-radius:8px;">
                                <i class="fa-solid fa-eye"></i> ANALIZAR
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        // Cambio de vistas
        function switchView(view) {
            document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));

            if (view === 'catalog') {
                document.getElementById('viewCatalog').classList.add('active');
                document.getElementById('navCatalog').classList.add('active');
            } else {
                document.getElementById('viewSales').classList.add('active');
                document.getElementById('navSales').classList.add('active');
                runSEOAudit(); // Correr escaneo al entrar
                renderMarketHotlist(); // Cargar ranking de 100 items
            }
        }

        // Inicializar auditoría
        auditManager.render();

        loadProducts();
    </script>
</body>

</html>