<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Cotizador | Integral</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg: #f5f5f7;
            --surface: #ffffff;
            --border: #e5e5ea;
            --text: #1c1c1e;
            --subtext: #8e8e93;
            --accent: #0071e3;
            --green: #34c759;
            --red: #ff3b30;
            --orange: #ff9500;
            --radius: 16px;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        body.dark-mode {
            --bg: #000000;
            --surface: #1c1c1e;
            --border: #333336;
            --text: #f5f5f7;
            --subtext: #98989d;
        }

        body.dark-mode .topbar {
            background: rgba(28, 28, 30, 0.92);
        }

        body.dark-mode .sheet,
        body.dark-mode .sheet-handle-area {
            background: var(--surface);
        }

        body.dark-mode .sheet-header,
        body.dark-mode .section-divider {
            color: var(--text);
            border-bottom-color: var(--border);
        }

        body.dark-mode input.field-input,
        body.dark-mode input.inp,
        body.dark-mode select.inp,
        body.dark-mode textarea.paste-area,
        body.dark-mode textarea.inp {
            background-color: #000;
            color: var(--text);
        }

        body.dark-mode .action-bar {
            background: rgba(28, 28, 30, 0.95);
            border-top: 1px solid var(--border);
        }

        body.dark-mode .quote-total {
            background: rgba(0, 0, 0, 0.5);
        }

        body.dark-mode .sidebar {
            background-color: var(--surface);
        }

        html {
            overflow-x: hidden;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100dvh;
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: calc(90px + var(--safe-bottom));
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
            /* evita zoom de texto en iOS al rotar */
        }


        /* â”€â”€ TOP BAR â”€â”€ */
        .topbar {
            position: sticky;
            top: 0;
            z-index: 200;
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 14px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .topbar-back {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--accent);
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .topbar h1 {
            font-size: 17px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--subtext);
            font-size: 18px;
            padding: 4px;
        }

        /* â”€â”€ SIDEBAR (Drawer) â”€â”€ */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.4);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: 0.3s;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: -320px;
            width: 80%;
            max-width: 320px;
            height: 100vh;
            background: var(--surface);
            z-index: 1000;
            transition: 0.3s cubic-bezier(0.1, 0, 0.1, 1);
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .sidebar.active {
            left: 0;
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-header h2 {
            font-size: 18px;
            font-weight: 800;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-close {
            background: rgba(0, 0, 0, 0.05);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--subtext);
        }

        .sidebar-menu {
            padding: 16px 12px;
            flex: 1;
            overflow-y: auto;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            color: var(--text);
            text-decoration: none;
            font-weight: 600;
            font-size: 15px;
            border-radius: 12px;
            margin-bottom: 4px;
            transition: background 0.2s;
        }

        .sidebar-link i {
            color: var(--accent);
            font-size: 18px;
            width: 20px;
            text-align: center;
        }

        .sidebar-link:hover,
        .sidebar-link:active {
            background: rgba(0, 113, 227, 0.08);
            color: var(--accent);
        }

        /* â”€â”€ STEPS â”€â”€ */
        .steps {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px 0;
        }

        .step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border);
            transition: all 0.3s;
        }

        .step-dot.active {
            background: var(--accent);
            width: 24px;
            border-radius: 4px;
        }

        .step-dot.done {
            background: var(--green);
        }

        /* â”€â”€ SECTIONS â”€â”€ */
        .section {
            display: none;
            padding: 20px;
        }

        .section.active {
            display: block;
        }

        /* â”€â”€ INPUTS â”€â”€ */
        .lbl {
            font-size: 11px;
            font-weight: 700;
            color: var(--subtext);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            display: block;
        }

        .inp {
            width: 100%;
            box-sizing: border-box;
            padding: 12px 14px;
            border: 1.5px solid var(--border);
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            color: var(--text);
            background: var(--surface);
            outline: none;
            transition: border-color 0.2s;
        }


        .inp:focus {
            border-color: var(--accent);
        }

        .inp::placeholder {
            color: var(--subtext);
        }

        .field {
            margin-bottom: 14px;
        }

        .row2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .row2>* {
            min-width: 0;
            overflow: hidden;
        }

        /* Fuerza que los inputs (especialmente type=date en iOS) respeten el grid */
        .row2 .inp {
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
            -webkit-appearance: none;
            appearance: none;
            font-size: 14px;
            padding: 11px 10px;
        }




        /* â”€â”€ BUTTONS â”€â”€ */
        .btn-primary {
            width: 100%;
            padding: 16px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: opacity 0.2s, transform 0.1s;
        }

        .btn-primary:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .btn-primary:disabled {
            opacity: 0.45;
            cursor: default;
        }

        .btn-secondary {
            width: 100%;
            padding: 14px;
            background: var(--surface);
            color: var(--text);
            border: 1.5px solid var(--border);
            border-radius: var(--radius);
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* â”€â”€ SEARCH & PASTE STEP â”€â”€ */
        .search-results-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--surface);
            border: 1.5px solid var(--border);
            border-radius: 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-top: 5px;
        }

        body.dark-mode .search-results-dropdown {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .search-result-item {
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: 0.1s;
        }

        .search-result-item:hover {
            background: rgba(0, 113, 227, 0.05);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .manual-selected-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(0, 113, 227, 0.06);
            border: 1px solid rgba(0, 113, 227, 0.2);
            border-radius: 8px;
            font-size: 13px;
        }

        .paste-area {
            width: 100%;
            min-height: 200px;
            padding: 16px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius);
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            line-height: 1.6;
            color: var(--text);
            background: var(--surface);
            resize: none;
            outline: none;
            transition: border-color 0.2s;
        }

        .paste-area:focus {
            border-color: var(--accent);
        }

        .paste-area::placeholder {
            color: var(--subtext);
        }

        .hint-card {
            background: rgba(0, 113, 227, 0.06);
            border: 1px solid rgba(0, 113, 227, 0.15);
            border-radius: 12px;
            padding: 12px 14px;
            margin-top: 14px;
            font-size: 13px;
            color: #0071e3;
            line-height: 1.5;
        }

        /* â”€â”€ PRODUCT LIST â”€â”€ */
        .section-title {
            font-size: 20px;
            font-weight: 800;
            letter-spacing: -0.5px;
            margin-bottom: 6px;
        }

        .section-sub {
            font-size: 14px;
            color: var(--subtext);
            margin-bottom: 20px;
        }

        .product-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .product-item {
            background: var(--surface);
            border: 1.5px solid var(--border);
            border-radius: var(--radius);
            padding: 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .product-item.matched {
            border-color: rgba(52, 199, 89, 0.3);
        }

        .product-header {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .product-status {
            flex-shrink: 0;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            background: rgba(52, 199, 89, 0.12);
            color: var(--green);
        }

        .product-meta {
            flex: 1;
            min-width: 0;
        }

        .product-code {
            font-size: 11px;
            font-weight: 700;
            font-family: monospace;
            color: var(--subtext);
            letter-spacing: 0.5px;
        }

        .product-name {
            font-size: 14px;
            font-weight: 600;
        }

        .product-brand {
            font-size: 12px;
            color: var(--subtext);
        }

        .product-remove {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--subtext);
            padding: 4px;
            font-size: 16px;
            flex-shrink: 0;
        }

        .product-remove:hover {
            color: var(--red);
        }

        .product-qty-price {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .field-wrap {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .field-label {
            font-size: 11px;
            font-weight: 700;
            color: var(--subtext);
            text-transform: uppercase;
        }

        .field-input {
            padding: 10px 12px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            font-weight: 600;
            color: var(--text);
            width: 100%;
            outline: none;
            transition: border-color 0.2s;
        }

        .field-input:focus {
            border-color: var(--accent);
        }

        .field-input.price {
            color: var(--green);
        }

        .not-found-section {
            margin-top: 20px;
            padding: 14px 16px;
            background: rgba(255, 149, 0, 0.06);
            border: 1px solid rgba(255, 149, 0, 0.2);
            border-radius: var(--radius);
        }

        .not-found-label {
            font-size: 12px;
            font-weight: 700;
            color: var(--orange);
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .code-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .code-chip {
            font-size: 11px;
            font-family: monospace;
            font-weight: 700;
            padding: 4px 9px;
            border-radius: 8px;
            background: rgba(255, 149, 0, 0.1);
            color: var(--orange);
        }

        /* â”€â”€ STEP 3: QUICK QUOTE â”€â”€ */
        .quote-card {
            background: var(--surface);
            border: 1.5px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .quote-header {
            padding: 16px 18px;
            background: linear-gradient(135deg, #0071e3, #0051a8);
            color: white;
        }

        .quote-header .q-title {
            font-size: 17px;
            font-weight: 800;
            margin-bottom: 2px;
        }

        .quote-header .q-date {
            font-size: 12px;
            opacity: 0.75;
        }

        .quote-row {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 8px;
            align-items: center;
            padding: 12px 18px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        .quote-row:last-child {
            border-bottom: none;
        }

        .quote-row-name {
            font-weight: 600;
        }

        .quote-row-code {
            font-size: 11px;
            font-family: monospace;
            color: var(--subtext);
        }

        .quote-row-qty {
            font-size: 13px;
            font-weight: 600;
            color: var(--subtext);
            text-align: right;
        }

        .quote-row-price {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent);
            text-align: right;
            white-space: nowrap;
        }

        .quote-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 18px;
            background: var(--bg);
            font-weight: 800;
        }

        .quote-total-label {
            font-size: 13px;
            color: var(--subtext);
        }

        .quote-total-amount {
            font-size: 22px;
            letter-spacing: -0.5px;
        }

        /* â”€â”€ ACTION BAR â”€â”€ */
        .action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 600px;
            margin: 0 auto;
            background: rgba(var(--surface-rgb, 255, 255, 255), 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            padding: 12px 20px calc(12px + var(--safe-bottom));
            display: flex;
            gap: 8px;
        }

        .btn-wa {
            flex: 1;
            padding: 14px;
            background: #25d366;
            color: white;
            border: none;
            border-radius: 14px;
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 7px;
        }

        .btn-pdf {
            flex: 1;
            padding: 14px;
            background: #0071e3;
            color: white;
            border: none;
            border-radius: 14px;
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 7px;
        }

        .btn-icon {
            padding: 14px 16px;
            background: var(--bg);
            color: var(--text);
            border: 1.5px solid var(--border);
            border-radius: 14px;
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* â”€â”€ FORMAL SHEET (bottom modal) â”€â”€ */
        .sheet-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 300;
            align-items: flex-end;
            justify-content: center;
        }

        .sheet-overlay.open {
            display: flex;
        }

        .sheet {
            background: white;
            width: 100%;
            max-width: 600px;
            border-radius: 24px 24px 0 0;
            padding: 0 0 calc(20px + var(--safe-bottom));
            max-height: 90dvh;
            overflow-y: auto;
        }

        .sheet-handle-area {
            padding: 14px 20px 0;
            position: sticky;
            top: 0;
            background: white;
            border-bottom: 1px solid var(--border);
            padding-bottom: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
        }

        .sheet-handle {
            width: 36px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin: 0 auto 14px;
        }

        .sheet-title {
            font-size: 17px;
            font-weight: 800;
        }

        .sheet-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--subtext);
        }

        .sheet-body {
            padding: 20px;
        }

        .section-divider {
            font-size: 11px;
            font-weight: 700;
            color: var(--subtext);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin: 20px 0 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        /* Checkboxes (payment methods) */
        .check-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .check-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            font-size: 13px;
            font-weight: 600;
        }

        .check-item input[type="checkbox"] {
            accent-color: var(--accent);
            width: 16px;
            height: 16px;
        }

        .check-item:has(input:checked) {
            border-color: var(--accent);
            background: rgba(0, 113, 227, 0.05);
        }

        /* â”€â”€ TOAST â”€â”€ */
        .toast {
            position: fixed;
            bottom: 110px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px 20px;
            border-radius: 24px;
            font-size: 13px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            white-space: nowrap;
            z-index: 9999;
        }

        .toast.show {
            opacity: 1;
        }

        /* â”€â”€ EMPTY STATE â”€â”€ */
        .empty-state {
            text-align: center;
            padding: 48px 20px;
            color: var(--subtext);
        }

        .empty-state i {
            font-size: 40px;
            opacity: 0.25;
            margin-bottom: 12px;
            display: block;
        }

        .empty-state p {
            font-size: 14px;
        }

        /* â”€â”€ LOGIN OVERLAY â”€â”€ */
        #loginOverlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(20px);
            z-index: 9999;
            justify-content: center;
            align-items: flex-end;
        }

        .login-sheet {
            background: white;
            width: 100%;
            max-width: 600px;
            border-radius: 24px 24px 0 0;
            padding: 32px 24px calc(32px + var(--safe-bottom));
            text-align: center;
        }

        .login-sheet .handle {
            width: 36px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin: 0 auto 28px;
        }

        .login-sheet img {
            height: 56px;
            margin-bottom: 20px;
        }

        .login-sheet h2 {
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .login-sheet p {
            font-size: 14px;
            color: var(--subtext);
            margin-bottom: 24px;
        }

        .login-sheet input[type="password"] {
            width: 100%;
            padding: 14px;
            border: 1.5px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            text-align: center;
            margin-bottom: 12px;
            outline: none;
            font-family: 'Inter', sans-serif;
        }

        .login-sheet input:focus {
            border-color: var(--accent);
        }

        #loginError {
            color: var(--red);
            font-size: 13px;
            margin-bottom: 8px;
            display: none;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PRINT STYLES â€” CotizaciÃ³n Formal
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #printView {
            display: none;
        }

        @media print {

            html,
            body {
                margin: 0;
                padding: 0;
                background: white !important;
            }

            body>*:not(#printView) {
                display: none !important;
            }

            #printView {
                display: block !important;
                font-family: 'Inter', -apple-system, Arial, sans-serif;
                color: #1c1c1e;
                font-size: 11pt;
                max-width: 100%;
                width: 100%;
                padding: 0 !important;
                margin: 0 !important;
            }

            /* Explicit Multi-Page A4 Structure */
            .pv-page {
                width: 210mm;
                height: 296mm;
                margin: 0 auto;
                padding: 15mm 15mm 15mm 15mm;
                box-sizing: border-box;
                display: flex;
                flex-direction: column;
                break-after: page;
                page-break-after: always;
                overflow: visible;
            }

            .pv-page:last-child {
                break-after: auto !important;
                page-break-after: auto !important;
            }

            .pv-flex-spacer {
                flex-grow: 1;
            }

            /* Global Footer (now anchored perfectly via flexbox) */
            .pv-global-footer {
                margin-top: auto;
                min-height: 12mm;
                display: grid;
                grid-template-columns: 1fr auto 1fr;
                width: 100%;
                align-items: center;
                border-top: 1pt solid #00AEEF;
                border-image: linear-gradient(to right, #00AEEF, #EC008C, #FFF200) 1;
                font-size: 8pt;
                color: #555;
                flex-shrink: 0;
                padding-top: 8pt;
                padding-bottom: 5pt;
            }

            .pv-global-footer strong {
                color: #1c1c1e;
            }

            /* Header */
            .pv-header {
                display: flex;
                justify-content: space-between;
                align-items: stretch;
                padding-bottom: 12pt;
                border-bottom: 2pt solid #00AEEF;
                border-image: linear-gradient(to right, #00AEEF, #EC008C, #FFF200) 1;
                margin-bottom: 16pt;
            }

            .pv-logo {
                width: auto;
                height: 100%;
                max-height: 90pt;
                object-fit: contain;
                object-position: left center;
                display: block;
            }

            .pv-biz {
                text-align: right;
                font-size: 9pt;
                color: #555;
                line-height: 1.5;
            }

            .pv-biz strong {
                font-size: 13pt;
                color: #1c1c1e;
                display: block;
                margin-bottom: 3pt;
            }

            /* Quote meta */
            .pv-meta {
                display: flex;
                justify-content: space-between;
                gap: 12pt;
                margin-bottom: 14pt;
            }

            .pv-meta-box {
                flex: 1;
                border: 0.5pt solid #EC008C;
                border-left: 3pt solid #00AEEF;
                border-radius: 4pt;
                padding: 10pt 12pt;
                background: #fafafc;
            }

            .pv-meta-box h4 {
                font-size: 7pt;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5pt;
                color: #004b93;
                margin-bottom: 6pt;
            }

            .pv-meta-box p {
                font-size: 9pt;
                line-height: 1.6;
                color: #333;
            }

            .pv-meta-box strong {
                color: #1c1c1e;
            }

            /* Table */
            .pv-table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 14pt;
                page-break-inside: auto;
            }

            .pv-table thead {
                display: table-header-group;
            }

            .pv-table thead tr {
                background: #00AEEF;
                color: white;
            }

            .pv-table thead th {
                padding: 7pt 10pt;
                font-size: 8.5pt;
                text-align: left;
            }

            .pv-table thead th:last-child,
            .pv-table thead th:nth-last-child(-n+2) {
                text-align: right;
            }

            .pv-table tbody tr {
                border-bottom: 0.5pt solid #e5e5ea;
                page-break-inside: avoid;
            }

            .pv-table tbody tr:nth-child(even) {
                background: #f8f8fa;
            }

            .pv-table tbody td {
                padding: 7pt 10pt;
                font-size: 9.5pt;
                vertical-align: middle;
            }

            .pv-table tbody td:last-child,
            .pv-table tbody td:nth-last-child(-n+2) {
                text-align: right;
            }

            .pv-td-code {
                font-family: monospace;
                font-size: 8pt;
                color: #666;
                display: block;
            }

            /* Totals */
            .pv-totals {
                display: flex;
                justify-content: flex-end;
                margin-bottom: 14pt;
                page-break-inside: avoid;
            }

            .pv-totals-box {
                width: 190pt;
                background: #fdfdfd;
                border: 1pt solid #e5e5ea;
                border-top: 2pt solid #00AEEF;
                border-radius: 4pt;
                padding: 8pt 10pt;
            }

            .pv-totals-row {
                display: flex;
                justify-content: space-between;
                padding: 3pt 0;
                font-size: 8.5pt;
                font-weight: 400;
                border-bottom: 0.5pt solid #f0f0f0;
            }

            .pv-totals-row.total {
                font-size: 12pt;
                font-weight: 800;
                border: none;
                padding-top: 6pt;
                color: #1c1c1e;
            }

            .pv-totals-row.total span:last-child {
                color: #1c1c1e;
            }

            /* Footer */
            .pv-footer {
                border-top: 1pt solid #e5e5ea;
                padding-top: 8pt;
                display: flex;
                gap: 16pt;
                margin-bottom: 5pt;
            }

            .pv-footer-col {
                flex: 1;
            }

            .pv-footer-col h5 {
                font-size: 7.5pt;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.4pt;
                color: #004b93;
                margin-bottom: 5pt;
            }

            .pv-footer-col p {
                font-size: 8.5pt;
                color: #555;
                line-height: 1.6;
            }

            .pv-legal-notes {
                font-size: 7.5pt;
                color: #777;
                text-align: justify;
                border-top: 0.5pt dashed #ccc;
                padding-top: 6pt;
                line-height: 1.4;
            }

            @page {
                size: A4;
                margin: 0 !important;
            }

            #printView {
                padding: 0;
                box-sizing: border-box;
            }
        }

        /* â”€â”€ iOS preview override: responsive en pantalla chica â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media screen and (max-width: 600px) {
            body.ios-preview #printView .pv-page {
                width: 100% !important;
                max-width: 210mm;
                height: auto !important;
                min-height: 0 !important;
                padding: 16px !important;
                margin: 0 auto 20px !important;
                overflow: visible !important;
                break-after: auto !important;
                page-break-after: auto !important;
                border-bottom: 2px dashed #e5e5ea;
            }

            body.ios-preview #printView .pv-page:last-child {
                border-bottom: none;
            }

            body.ios-preview #printView .pv-meta {
                flex-direction: column;
                gap: 8px;
            }

            body.ios-preview #printView .pv-totals-box {
                width: 100%;
            }
        }

        /* â”€â”€ Ajustes para pantallas muy chicas (ej. iPhone SE 375px) â”€â”€â”€â”€â”€â”€â”€ */
        @media screen and (max-width: 390px) {
            .topbar {
                padding: 12px 14px;
            }

            .topbar h1 {
                font-size: 15px;
            }

            .section {
                padding: 16px 14px;
            }

            .sheet-body {
                padding: 16px 14px;
            }

            /* Toast: limitar ancho en pantallas chicas para no salirse */
            .toast {
                white-space: normal;
                text-align: center;
                max-width: calc(100vw - 48px);
                left: 24px;
                right: 24px;
                transform: none;
            }

            /* Quote row: reducir fuentes para que precio no se corte */
            .quote-row {
                font-size: 13px;
                padding: 10px 14px;
            }

            .quote-row-price {
                font-size: 13px;
            }

            .quote-total-amount {
                font-size: 19px;
            }

            /* Action bar: botones mÃ¡s compactos */
            .btn-wa,
            .btn-pdf {
                font-size: 14px;
                padding: 12px 10px;
            }

            .btn-icon {
                padding: 12px 14px;
            }

            /* Check payment grid: 1 columna en muy chico */
            .check-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>


<body>

    <!-- SIDEBAR OVERLAY -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <!-- SIDEBAR MAIN -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2><i class="fa-solid fa-file-invoice" style="color:var(--accent)"></i> Cotizador</h2>
            <button class="sidebar-close" onclick="closeSidebar()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="sidebar-menu">
            <a href="#" class="sidebar-link" onclick="openSidebarTab('history')">
                <i class="fa-solid fa-clock-rotate-left"></i> Historial de Cotizaciones
            </a>
            <a href="#" class="sidebar-link" onclick="openSidebarTab('contacts')">
                <i class="fa-solid fa-address-book"></i> Contactos Guardados
            </a>
            <hr style="border:0; border-top:1px solid var(--border); margin: 16px 4px;">
            <a href="#" class="sidebar-link" onclick="toggleDarkMode()">
                <i class="fa-solid fa-moon"></i> Modo Oscuro
            </a>
            <a href="home.html" class="sidebar-link">
                <i class="fa-solid fa-arrow-left"></i> Volver a Home
            </a>
        </div>
    </nav>

    <!-- TOP BAR -->
    <header class="topbar">
        <div style="display:flex; align-items:center; gap: 12px;">
            <button class="icon-btn" onclick="openSidebar()" style="color:var(--text); font-size: 20px;">
                <i class="fa-solid fa-bars"></i>
            </button>
            <button class="topbar-back" onclick="goBack()"><i class="fa-solid fa-chevron-left"></i> Admin</button>
        </div>

        <h1>Cotizador</h1>

        <div class="topbar-right">
            <button class="icon-btn" id="btnReset" onclick="resetAll()" title="Nueva cotizaciÃ³n" style="display:none;">
                <i class="fa-solid fa-arrow-rotate-left"></i>
            </button>
        </div>
    </header>

    <!-- STEPS -->
    <div class="steps">
        <div class="step-dot active" id="dot0"></div>
        <div class="step-dot" id="dot1"></div>
        <div class="step-dot" id="dot2"></div>
    </div>

    <!-- â•â• STEP 1: PASTE â•â• -->
    <div class="section active" id="step1">
        <br>
        <span class="lbl">BÃºsqueda rÃ¡pida (manual)</span>
        <div style="position:relative; margin-bottom: 20px;">
            <input type="text" id="manualSearchInput" class="inp" placeholder="Buscar por cÃ³digo, modelo o nombre..."
                autocomplete="off" oninput="handleManualSearch(this.value)">
            <div id="manualSearchResults" class="search-results-dropdown"></div>
        </div>

        <div id="manualSelectedItems" style="margin-bottom: 20px; display: flex; flex-direction: column; gap: 8px;">
        </div>

        <div style="display:flex; align-items:center; gap:10px; margin: 30px 0;">
            <div style="flex:1; height:1px; background:var(--border);"></div>
            <div
                style="font-size:11px; color:var(--subtext); font-weight:700; text-transform:uppercase; letter-spacing:0.5px;">
                o pega un bloque de texto</div>
            <div style="flex:1; height:1px; background:var(--border);"></div>
        </div>

        <span class="lbl">Pega el texto aquÃ­</span>
        <textarea class="paste-area" id="pasteInput"
            placeholder="Pega aquÃ­ una conversaciÃ³n de WhatsApp, email, o texto que contenga cÃ³digosâ€¦"></textarea>
        <div class="hint-card">
            <i class="fa-solid fa-wand-magic-sparkles"></i>
            El sistema detecta automÃ¡ticamente los cÃ³digos de productos.
        </div>
        <button class="btn-primary" id="btnAnalyze" onclick="analyzeText()">
            <i class="fa-solid fa-magnifying-glass"></i> Continuar
        </button>
    </div>

    <!-- â•â• STEP 2: REVIEW â•â• -->
    <div class="section" id="step2">
        <br>
        <div class="section-title">Productos detectados</div>
        <div class="section-sub" id="step2Sub">Revisa y ajusta cantidades y precios.</div>
        <div class="product-list" id="productList"></div>

        <div id="notFoundSection" class="not-found-section" style="display:none;">
            <div class="not-found-label"><i class="fa-solid fa-triangle-exclamation"></i> CÃ³digos no encontrados</div>
            <div class="code-chips" id="notFoundChips"></div>
        </div>

        <button class="btn-primary" id="btnGenerate" onclick="generateQuote()">
            <i class="fa-solid fa-file-invoice-dollar"></i> Generar cotizaciÃ³n
        </button>
        <button class="btn-secondary" onclick="goToStep(1)">
            <i class="fa-solid fa-chevron-left"></i> Volver a editar texto
        </button>
    </div>

    <!-- â•â• STEP 3: QUOTE â•â• -->
    <div class="section" id="step3">
        <br>
        <div class="section-title">Lista para compartir</div>
        <div class="section-sub">CotizaciÃ³n rÃ¡pida para WhatsApp Â· o genera un PDF formal.</div>

        <div class="quote-card">
            <div class="quote-header">
                <div class="q-title">CotizaciÃ³n â€” Integral ComputaciÃ³n</div>
                <div class="q-date" id="quoteDate"></div>
            </div>
            <div id="quoteBody"></div>
            <div class="quote-total">
                <span class="quote-total-label">TOTAL ESTIMADO</span>
                <span class="quote-total-amount" id="quoteTotal">â€”</span>
            </div>
        </div>

        <button class="btn-secondary" onclick="goToStep(2)" style="margin-top:16px;">
            <i class="fa-solid fa-pencil"></i> Editar precios
        </button>
    </div>

    <!-- â•â• ACTION BAR â•â• -->
    <div class="action-bar" id="actionBar" style="display:none;">
        <button class="btn-wa" onclick="shareWhatsApp()">
            <i class="fa-brands fa-whatsapp"></i> WhatsApp
        </button>
        <button class="btn-pdf" onclick="openFormalSheet()">
            <i class="fa-solid fa-file-pdf"></i> PDF Formal
        </button>
        <button class="btn-icon" onclick="copyQuote()" title="Copiar">
            <i class="fa-solid fa-copy"></i>
        </button>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FORMAL PDF SHEET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="sheet-overlay" id="formalOverlay" onclick="if(event.target===this) closeFormalSheet()">
        <div class="sheet" id="formalSheet">
            <div class="sheet-handle-area">
                <div>
                    <div class="sheet-handle"></div>
                    <div class="sheet-title">ðŸ“‹ CotizaciÃ³n Formal (PDF)</div>
                </div>
                <div>
                    <button class="sheet-close" onclick="openSettingsSheet()" style="margin-right:8px;"
                        title="Configurar Empresa"><i class="fa-solid fa-gear"></i></button>
                    <button class="sheet-close" onclick="closeFormalSheet()"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>
            <div class="sheet-body">

                <!-- Cliente -->
                <div class="section-divider">Datos del Cliente</div>
                <div class="field">
                    <label class="lbl" for="fClientCompany">Empresa <span
                            style="font-weight:400;color:var(--subtext);">(opcional)</span></label>
                    <input class="inp" id="fClientCompany" type="text" placeholder="RazÃ³n social o nombre de empresa">
                </div>
                <div class="field">
                    <label class="lbl" for="fClientName">Nombre del contacto</label>
                    <input class="inp" id="fClientName" type="text" placeholder="Nombre completo del cliente"
                        list="clientsList" onchange="onClientSelect(this.value)">
                    <datalist id="clientsList"></datalist>
                </div>
                <div class="row2">
                    <div class="field">
                        <label class="lbl" for="fClientPhone">TelÃ©fono / WhatsApp</label>
                        <input class="inp" id="fClientPhone" type="text" inputmode="tel" placeholder="+52 33..."
                            autocomplete="off">
                    </div>
                    <div class="field">
                        <label class="lbl" for="fClientEmail">Email</label>
                        <input class="inp" id="fClientEmail" type="text" inputmode="email" placeholder="correo@..."
                            autocomplete="off">
                    </div>
                </div>
                <div class="field">
                    <label class="lbl" for="fVendor">Vendedor / Agente</label>
                    <select class="inp" id="fVendor" onchange="updateQuoteId()">
                        <option value="01">RocÃ­o Romero (USUARIO 01)</option>
                        <option value="02">RocÃ­o VÃ¡zquez (USUARIO 02)</option>
                    </select>
                </div>

                <div class="row2">
                    <div class="field">
                        <label class="lbl" for="fQuoteDateDisplay">Fecha de CotizaciÃ³n</label>
                        <div style="position:relative;">
                            <input class="inp" id="fQuoteDateDisplay" type="text" readonly style="cursor:pointer;"
                                onclick="document.getElementById('fQuoteDate').showPicker ? document.getElementById('fQuoteDate').showPicker() : document.getElementById('fQuoteDate').click()">
                            <input id="fQuoteDate" type="date"
                                onchange="updateQuoteId();this.previousElementSibling.value=new Date(this.value+'T12:00:00').toLocaleDateString('es-MX',{day:'2-digit',month:'short',year:'numeric'})"
                                style="position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;pointer-events:none;">
                        </div>
                    </div>
                    <div class="field">
                        <label class="lbl" for="fValidity">Vigencia (dÃ­as)</label>
                        <input class="inp" id="fValidity" type="number" value="15" min="1">
                    </div>
                </div>

                <div class="field">
                    <label class="lbl" for="fQuoteNum">NÃºmero de CotizaciÃ³n</label>
                    <input class="inp" id="fQuoteNum" type="text" readonly
                        style="background:#f5f5f7; color:#8e8e93; font-weight:700;">
                </div>
                <div class="field">
                    <label class="lbl" for="fNotes">Notas adicionales</label>
                    <input class="inp" id="fNotes" type="text" placeholder="Ej. Precio incluye instalaciÃ³n bÃ¡sica">
                </div>

                <!-- IVA -->
                <div class="section-divider">Impuestos</div>
                <div class="row2">
                    <div class="field">
                        <label class="lbl" for="fIvaRate">IVA (%)</label>
                        <input class="inp" id="fIvaRate" type="number" value="16" min="0" max="100">
                    </div>
                    <div class="field">
                        <label class="lbl" for="fDiscount">Descuento (%)</label>
                        <input class="inp" id="fDiscount" type="number" value="0" min="0" max="100">
                    </div>
                </div>

                <!-- Formas de pago -->
                <div class="section-divider">Formas de Pago Aceptadas</div>
                <div class="check-grid">
                    <label class="check-item"><input type="checkbox" id="payEfectivo" checked> Efectivo</label>
                    <label class="check-item"><input type="checkbox" id="payTransferencia" checked>
                        Transferencia</label>
                    <label class="check-item"><input type="checkbox" id="payBBVA"> BBVA CoDi</label>
                    <label class="check-item"><input type="checkbox" id="payOXXO"> OXXO Pay</label>
                    <label class="check-item"><input type="checkbox" id="payTarjeta"> Tarjeta (3% cargo)</label>
                    <label class="check-item"><input type="checkbox" id="payMercadoPago"> MercadoPago</label>
                </div>

                <button class="btn-primary" onclick="printFormal()" style="margin-top:24px;">
                    <i class="fa-solid fa-print" id="printBtnIcon"></i> <span id="printBtnLabel">Generar y Guardar
                        PDF</span>
                </button>
                <button class="btn-secondary" onclick="closeFormalSheet()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SETTINGS SHEET (Company Data)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="sheet-overlay" id="settingsOverlay" onclick="if(event.target===this) closeSettingsSheet()">
        <div class="sheet" id="settingsSheet">
            <div class="sheet-handle-area">
                <div>
                    <div class="sheet-handle"></div>
                    <div class="sheet-title">âš™ï¸ Datos de la Empresa</div>
                </div>
                <button class="sheet-close" onclick="closeSettingsSheet()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="sheet-body">
                <div class="section-divider">Contacto Principal</div>
                <div class="row2">
                    <div class="field">
                        <label class="lbl" for="cfgPhone">TelÃ©fono del Negocio</label>
                        <input class="inp" id="cfgPhone" type="text" placeholder="(33) 12680092">
                    </div>
                    <div class="field">
                        <label class="lbl" for="cfgEmail">Email del Negocio</label>
                        <input class="inp" id="cfgEmail" type="email" placeholder="ventas@...">
                    </div>
                </div>

                <div class="section-divider">Redes Sociales</div>
                <div class="field">
                    <label class="lbl" for="cfgWa">WhatsApp (PDF Footer)</label>
                    <input class="inp" id="cfgWa" type="text" placeholder="(33) 12680092">
                </div>

                <div class="section-divider">Pie de PÃ¡gina (Legales)</div>
                <div class="field">
                    <label class="lbl" for="cfgTerms">Condiciones (fijas en toda cotizaciÃ³n)</label>
                    <input class="inp" id="cfgTerms" type="text"
                        placeholder="Precios sujetos a disponibilidad y cambio sin previo aviso.">
                </div>

                <button class="btn-primary" onclick="saveSettings()" style="margin-top:24px;">
                    <i class="fa-solid fa-save"></i> Guardar Cambios
                </button>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PRINT VIEW (only visible to printer)
 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="printView"></div>

    <!-- TOAST -->
    <div class="toast" id="toast"></div>

    <!-- LOGIN OVERLAY -->
    <div id="loginOverlay">
        <div class="login-sheet">
            <div class="handle"></div>
            <img src="/assets/images/LOGO SIN TEXTO.png" alt="Logo"
                onerror="this.src='/assets/logo.svg'; this.style.height='40px'">
            <h2>Acceso Protegido</h2>
            <p>Introduce la contraseÃ±a del panel de administraciÃ³n para continuar.</p>
            <div id="loginError">ContraseÃ±a incorrecta.</div>
            <input type="password" id="adminPwd" placeholder="ContraseÃ±a" onkeydown="if(event.key==='Enter') doLogin()">
            <button class="btn-primary" onclick="doLogin()" style="margin-top:0;">
                <i class="fa-solid fa-lock-open"></i> Desbloquear
            </button>
        </div>
    </div>

    <script>
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // STATE
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const TOKEN_KEY = 'admin_token';
        let products = [];
        let quoteItems = [];
        let notFound = [];
        let clients = []; // Historial de clientes

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // AUTH & LOAD
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function getToken() { return localStorage.getItem(TOKEN_KEY); }
        async function apiFetch(url, opts = {}) {
            opts.headers = { ...(opts.headers || {}), 'Authorization': `Bearer ${getToken()}` };
            return fetch(url, opts);
        }
        async function checkAuth() {
            if (!getToken()) { showLogin(); return false; }
            try {
                const r = await fetch('/api/brands', { headers: { 'Authorization': `Bearer ${getToken()}` } });
                if (r.status === 401) { showLogin(); return false; }
            } catch (_) { }
            return true;
        }
        function showLogin() {
            document.getElementById('loginOverlay').style.display = 'flex';
            setTimeout(() => document.getElementById('adminPwd').focus(), 300);
        }
        async function doLogin() {
            const pwd = document.getElementById('adminPwd').value;
            const err = document.getElementById('loginError');
            err.style.display = 'none';
            try {
                const r = await fetch('/api/login', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: pwd })
                });
                const d = await r.json();
                if (r.ok && d.token) {
                    localStorage.setItem(TOKEN_KEY, d.token);
                    document.getElementById('loginOverlay').style.display = 'none';
                    loadInitialData();
                } else { err.style.display = 'block'; document.getElementById('adminPwd').value = ''; }
            } catch (e) { err.textContent = 'Error de conexiÃ³n.'; err.style.display = 'block'; }
        }

        async function loadInitialData() {
            loadProducts();
            loadClients();
        }

        async function loadProducts() {
            try {
                const r = await apiFetch('/api/products');
                if (r.status === 401) { showLogin(); return; }
                const d = await r.json();
                products = d.data || [];
                // Guardar en cachÃ© local para modo offline
                localStorage.setItem('offlineProducts', JSON.stringify(products));
            } catch (_) {
                // Modo Offline: intentar usar catÃ¡logo guardado
                const cached = localStorage.getItem('offlineProducts');
                if (cached) {
                    products = JSON.parse(cached);
                    showToast('âš¡ï¸ Modo Offline: Usando catÃ¡logo descargado');
                } else {
                    showToast('âš ï¸ Sin conexiÃ³n y sin catÃ¡logo guardado');
                }
            }
        }

        async function loadClients() {
            try {
                const r = await apiFetch('/api/clients');
                const d = await r.json();
                clients = d.data || [];
                const list = document.getElementById('clientsList');
                list.innerHTML = clients.map(c => `<option value="${c.name}">`).join('');
            } catch (_) { }
        }

        function onClientSelect(name) {
            const c = clients.find(cl => cl.name === name);
            if (c) {
                document.getElementById('fClientPhone').value = c.phone || '';
                document.getElementById('fClientEmail').value = c.email || '';
            }
        }

        async function updateQuoteId() {
            const userId = document.getElementById('fVendor').value;
            const date = document.getElementById('fQuoteDate').value;
            try {
                const r = await apiFetch(`/api/quotes/next-id/${userId}?date=${date}`);
                const d = await r.json();
                document.getElementById('fQuoteNum').value = d.nextId;
            } catch (_) {
                showToast('Error al generar folio');
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // TEXT PARSING
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const SKIP_WORDS = new Set(['HOLA', 'BUENOS', 'DIAS', 'TARDES', 'NOCHES', 'GRACIAS', 'FAVOR',
            'PRECIO', 'PRECIOS', 'CUANTO', 'CUANTOS', 'NECESITO', 'TENGO', 'QUIERO', 'COTIZAR',
            'HACER', 'DAME', 'POR', 'PARA', 'CON', 'SIN', 'DEL', 'LAS', 'LOS', 'UNA', 'UNO', 'QUE',
            'ESA', 'ESE', 'ESTE', 'ESTA', 'INTEGRAL', 'COSTO', 'COSTOS', 'TODOS', 'TIENE',
            'TIENEN', 'COMO', 'CUANDO', 'DONDE', 'SOBRE', 'ENTRE', 'STOCK', 'MARCA', 'MODELO',
            'SERIE', 'CODIGO', 'NUMERO', 'UNIDAD', 'CANTIDAD', 'TOTAL', 'IVA', 'MXN', 'USD',
            'DADO', 'SOBRE', 'ENTRE', 'TENGO', 'BUENAS']);

        function extractCodes(text) {
            const raw = text.toUpperCase();
            const matches = [];
            const re = /\b([A-Z0-9][A-Z0-9\-\.]{2,}[A-Z0-9])\b/g;
            let m;
            while ((m = re.exec(raw)) !== null) {
                const t = m[1];
                if (!SKIP_WORDS.has(t) && t.length >= 4) matches.push(t);
            }
            return [...new Set(matches)];
        }

        function matchCode(code) {
            let p = products.find(pr => pr.id.toUpperCase() === code);
            // Fuzzy match solo si el string es complejo (>= 5 letras y mezcla letras/nÃºmeros) o si parece claramente un cÃ³digo.
            // Esto evita que "2000" de "C/2000" o "INKJET" liguen productos errÃ³neos.
            if (!p && code.length >= 5 && /[A-Z]/.test(code) && /[0-9]/.test(code)) {
                p = products.find(pr => pr.id.toUpperCase().includes(code) || code.includes(pr.id.toUpperCase()));
            }
            return p || null;
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // NAVIGATION
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function goToStep(n) {
            document.querySelectorAll('.section').forEach((s, i) => s.classList.toggle('active', i === n - 1));
            [0, 1, 2].forEach(i => {
                const d = document.getElementById(`dot${i}`);
                d.classList.remove('active', 'done');
                if (i === n - 1) d.classList.add('active');
                else if (i < n - 1) d.classList.add('done');
            });
            document.getElementById('actionBar').style.display = (n === 3) ? 'flex' : 'none';
            document.getElementById('btnReset').style.display = (n > 1) ? 'block' : 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // STEP 1 â†’ SEARCH & ANALYZE
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let manualSelectedProducts = [];

        async function handleManualSearch(val) {
            const resBox = document.getElementById('manualSearchResults');
            const q = val.trim().toLowerCase();
            if (!q) { resBox.style.display = 'none'; return; }
            if (!products.length) await loadProducts();

            const matched = products.filter(p => p.id.toLowerCase().includes(q) || p.name.toLowerCase().includes(q) || (p.brand || '').toLowerCase().includes(q)).slice(0, 10);

            if (matched.length === 0) {
                resBox.innerHTML = '<div style="padding:10px; color:var(--subtext); text-align:center; font-size:13px;">Sin resultados</div>';
                resBox.style.display = 'block';
                return;
            }

            resBox.innerHTML = matched.map(p => `
                <div class="search-result-item" onclick="addManualProduct('${p.id.replace(/'/g, "\\'")}')">
                    <div style="font-size:11px; color:var(--accent); font-weight:700;">${p.id}</div>
                    <div style="font-size:13px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${p.name}</div>
                </div>
            `).join('');
            resBox.style.display = 'block';
        }

        function addManualProduct(id) {
            const p = products.find(x => x.id === id);
            if (p && !manualSelectedProducts.find(x => x.id === id)) {
                manualSelectedProducts.push(p);
                renderManualSelected();
            }
            document.getElementById('manualSearchInput').value = '';
            document.getElementById('manualSearchResults').style.display = 'none';
        }

        function removeManualProduct(id) {
            manualSelectedProducts = manualSelectedProducts.filter(x => x.id !== id);
            renderManualSelected();
        }

        function renderManualSelected() {
            const box = document.getElementById('manualSelectedItems');
            if (manualSelectedProducts.length === 0) {
                box.innerHTML = '';
                return;
            }
            box.innerHTML = manualSelectedProducts.map(p => `
                <div class="manual-selected-item">
                    <div style="flex:1; min-width:0; margin-right:10px;">
                        <span style="font-weight:700; color:var(--accent); margin-right:5px;">${p.id}</span>
                        <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:inline-block; vertical-align:bottom; max-width:70%;">${p.name}</span>
                    </div>
                    <i class="fa-solid fa-xmark" style="color:var(--red); cursor:pointer; padding:5px;" onclick="removeManualProduct('${p.id.replace(/'/g, "\\'")}')"></i>
                </div>
            `).join('');
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('#manualSearchResults') && e.target.id !== 'manualSearchInput') {
                const bx = document.getElementById('manualSearchResults');
                if (bx) bx.style.display = 'none';
            }
        });

        async function analyzeText() {
            const text = document.getElementById('pasteInput').value.trim();
            if (!text && manualSelectedProducts.length === 0) { showToast('Busca un producto o pega un texto'); return; }
            if (!products.length && text) { showToast('Cargando catÃ¡logoâ€¦'); await loadProducts(); }
            const btn = document.getElementById('btnAnalyze');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Procesandoâ€¦';

            quoteItems = []; notFound = [];

            // 1. AÃ±adir los manuales
            manualSelectedProducts.forEach(p => {
                quoteItems.push({ id: p.id, name: p.name, brand: p.brand, qty: 1, price: '' });
            });

            // 2. Extraer del texto si lo hay
            if (text) {
                const codes = extractCodes(text);
                codes.forEach(code => {
                    const p = matchCode(code);
                    if (p && !quoteItems.find(q => q.id === p.id))
                        quoteItems.push({ id: p.id, name: p.name, brand: p.brand, qty: 1, price: '' });
                    else if (!p) notFound.push(code);
                });
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-magnifying-glass"></i> Continuar';
            renderReview();
            goToStep(2);
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // STEP 2 â†’ RENDER
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function renderReview() {
            const list = document.getElementById('productList');
            document.getElementById('step2Sub').textContent = quoteItems.length
                ? `${quoteItems.length} producto${quoteItems.length !== 1 ? 's' : ''} encontrado${quoteItems.length !== 1 ? 's' : ''}. Ajusta cantidades y precios.`
                : 'No se encontraron cÃ³digos conocidos en el texto.';
            if (!quoteItems.length) {
                list.innerHTML = `<div class="empty-state"><i class="fa-solid fa-magnifying-glass"></i><p>NingÃºn cÃ³digo identificado.<br>Intenta con otro texto.</p></div>`;
            } else {
                list.innerHTML = '';
                quoteItems.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.className = 'product-item matched';
                    div.innerHTML = `
                <div class="product-header">
                    <div class="product-status"><i class="fa-solid fa-check"></i></div>
                    <div class="product-meta">
                        <div class="product-code">${item.id}</div>
                        <div class="product-name">${item.name || 'â€”'}</div>
                        ${item.brand ? `<div class="product-brand">${item.brand}</div>` : ''}
                    </div>
                    <button class="product-remove" onclick="removeItem(${idx})"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="product-qty-price">
                    <div class="field-wrap">
                        <label class="field-label">Cantidad</label>
                        <input class="field-input" type="number" min="1" value="${item.qty}"
                            oninput="quoteItems[${idx}].qty=parseInt(this.value)||1" inputmode="numeric">
                    </div>
                    <div class="field-wrap">
                        <label class="field-label">Precio Unit.</label>
                        <input class="field-input price" type="number" min="0" step="0.01"
                            placeholder="$ â€”" value="${item.price}"
                            oninput="quoteItems[${idx}].price=this.value" inputmode="decimal">
                    </div>
                </div>`;
                    list.appendChild(div);
                });
            }
            const nfSection = document.getElementById('notFoundSection');
            const nfChips = document.getElementById('notFoundChips');
            nfSection.style.display = notFound.length ? 'block' : 'none';
            nfChips.innerHTML = notFound.map(c => `<span class="code-chip">${c}</span>`).join('');
            document.getElementById('btnGenerate').disabled = !quoteItems.length;
        }
        function removeItem(idx) { quoteItems.splice(idx, 1); renderReview(); }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // STEP 3 â†’ QUICK QUOTE
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const fmt = n => Number(n).toLocaleString('es-MX', { style: 'currency', currency: 'MXN', minimumFractionDigits: 0 });

        function generateQuote() {
            const date = new Date().toLocaleDateString('es-MX', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('quoteDate').textContent = date.charAt(0).toUpperCase() + date.slice(1);
            const body = document.getElementById('quoteBody');
            body.innerHTML = '';
            let total = 0;
            quoteItems.forEach(item => {
                const qty = item.qty || 1, p = parseFloat(item.price) || 0, sub = qty * p;
                total += sub;
                const row = document.createElement('div');
                row.className = 'quote-row';
                row.innerHTML = `
            <div>
                <div class="quote-row-name">${item.name || item.id}</div>
                <div class="quote-row-code">${item.id}</div>
            </div>
            <div class="quote-row-qty">Ã— ${qty}</div>
            <div class="quote-row-price">${p > 0 ? fmt(sub) : 'â€”'}</div>`;
                body.appendChild(row);
            });
            document.getElementById('quoteTotal').textContent = total > 0 ? fmt(total) : 'â€”';
            goToStep(3);
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // FORMAL PDF SHEET
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // --- AUTO-COMPLETE CRM (desde servidor) ---
        let _crmClients = [];
        async function loadClientCRM() {
            // Cargar clientes del servidor para el datalist
            try {
                const res = await apiFetch('/api/clients');
                const { data } = await res.json();
                _crmClients = data || [];
            } catch (_) {
                _crmClients = JSON.parse(localStorage.getItem('crmClients') || '[]');
            }

            // Poblar datalist con todos los nombres
            const dl = document.getElementById('clientsList');
            if (dl) {
                dl.innerHTML = _crmClients.map(c =>
                    `<option value="${c.name}" data-phone="${c.phone || ''}" data-email="${c.email || ''}">`
                ).join('');
            }

            // Al seleccionar un nombre, autocompletar tel/email
            const nameInput = document.getElementById('fClientName');
            const emailInput = document.getElementById('fClientEmail');
            const phoneInput = document.getElementById('fClientPhone');
            if (nameInput && !nameInput._crmBound) {
                nameInput._crmBound = true;
                nameInput.addEventListener('input', () => {
                    const val = nameInput.value.trim().toLowerCase();
                    const found = _crmClients.find(c => c.name.toLowerCase() === val);
                    if (found) {
                        if (!phoneInput.value) phoneInput.value = found.phone || '';
                        if (!emailInput.value) emailInput.value = found.email || '';
                        showToast('âš¡ï¸ Cliente autocompletado');
                    }
                });
            }
        }

        function saveClientToCRM(name, email, phone) {
            if (!name || name === 'Cliente') return;
            let saved = JSON.parse(localStorage.getItem('crmClients') || '[]');
            const idx = saved.findIndex(c => c.email && c.email === email || (c.name === name && name.length > 3));
            const entry = { name, email, phone };
            if (idx >= 0) saved[idx] = entry;
            else saved.unshift(entry); // newest first
            // Keep max 200 contacts
            saved = saved.slice(0, 200);
            localStorage.setItem('crmClients', JSON.stringify(saved));
        }

        // --- FORMAL SHEET ---
        async function openFormalSheet() {
            // 1. Abrir el sheet INMEDIATAMENTE (no esperar el fetch del folio)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fQuoteDate').value = today;
            document.getElementById('fQuoteDateDisplay').value =
                new Date(today + 'T12:00:00').toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' });

            // Pre-llenar cliente si viene desde Contactos Guardados
            const prefillRaw = localStorage.getItem('_prefillClient');
            if (prefillRaw) {
                try {
                    const { name, company, phone, email } = JSON.parse(prefillRaw);
                    document.getElementById('fClientCompany').value = company || '';
                    document.getElementById('fClientName').value = name || '';
                    document.getElementById('fClientPhone').value = phone || '';
                    document.getElementById('fClientEmail').value = email || '';
                } catch (_) { }
                localStorage.removeItem('_prefillClient');
            }


            loadClientCRM();
            document.getElementById('formalOverlay').classList.add('open');

            // 2. Cargar el folio en segundo plano (sin bloquear apertura)
            const quoteNumEl = document.getElementById('fQuoteNum');
            quoteNumEl.value = '...';
            try {
                const userId = document.getElementById('fVendor').value;
                const r = await apiFetch(`/api/quotes/next-id/${userId}?date=${today}`);
                const d = await r.json();
                quoteNumEl.value = d.nextId || generarFolioLocal(userId, today);
            } catch (_) {
                quoteNumEl.value = generarFolioLocal(
                    document.getElementById('fVendor').value, today
                );
            }
        }
        function generarFolioLocal(userId, dateStr) {
            // Fallback cuando la red falla: genera folio con timestamp Ãºnico
            const [y, m, d] = dateStr.split('-');
            const date = `${d}${m}${y.slice(-2)}`;
            const rand = String(Math.floor(Math.random() * 90) + 10);
            return `IC${userId.padStart(2, '0')}-${date}-${rand}`;
        }
        function closeFormalSheet() {
            document.getElementById('formalOverlay').classList.remove('open');
        }

        // --- SETTINGS SHEET ---
        function openSettingsSheet() {
            closeFormalSheet();
            document.getElementById('settingsOverlay').classList.add('open');

            // Reemplazar antiguo default si quedÃ³ en cachÃ©
            let bizEmail = localStorage.getItem('bizEmail');
            if (bizEmail === 'info@integralcomputacion.com') bizEmail = 'ventas@integralcomputacion.com';

            // Cargar desde localStorage o poner defaults
            document.getElementById('cfgPhone').value = localStorage.getItem('bizPhone') || '(33) 12680092';
            document.getElementById('cfgEmail').value = bizEmail || 'ventas@integralcomputacion.com';
            document.getElementById('cfgWa').value = localStorage.getItem('bizWa') || '(33) 12680092';
            document.getElementById('cfgTerms').value = localStorage.getItem('bizTerms') || 'Todos los precios estÃ¡n expresados en moneda nacional (MXN) e incluyen IVA. Entrega sujeta a disponibilidad y confirmaciÃ³n de pedido.';
        }
        function closeSettingsSheet() {
            document.getElementById('settingsOverlay').classList.remove('open');
            openFormalSheet(); // Vuelve al PDF
        }
        function saveSettings() {
            localStorage.setItem('bizPhone', document.getElementById('cfgPhone').value);
            localStorage.setItem('bizEmail', document.getElementById('cfgEmail').value);
            localStorage.setItem('bizWa', document.getElementById('cfgWa').value);
            localStorage.setItem('bizTerms', document.getElementById('cfgTerms').value);
            showToast('âœ“ Datos de empresa guardados');
            closeSettingsSheet();
        }

        // --- DESIGN SHEET (Moved to Admin Home) ---

        function getCheckedPayments() {
            const map = {
                payEfectivo: 'Efectivo', payTransferencia: 'Transferencia', payBBVA: 'BBVA CoDi',
                payOXXO: 'OXXO Pay', payTarjeta: 'Tarjeta (cargo del 3%)', payMercadoPago: 'MercadoPago'
            };
            return Object.entries(map)
                .filter(([id]) => document.getElementById(id).checked)
                .map(([, label]) => label);
        }

        async function printFormal() {
            // Reemplazar antiguo default si quedÃ³ en cachÃ©
            let currentEmail = localStorage.getItem('bizEmail');
            if (currentEmail === 'info@integralcomputacion.com') {
                currentEmail = 'ventas@integralcomputacion.com';
                localStorage.setItem('bizEmail', currentEmail);
            }

            // Cargar configuraciÃ³n de empresa
            const bizPhone = localStorage.getItem('bizPhone') || '(33) 12680092';
            const bizEmail = currentEmail || 'ventas@integralcomputacion.com';
            const bizWa = localStorage.getItem('bizWa') || '(33) 12680092';
            const bizTerms = localStorage.getItem('bizTerms') || 'Todos los precios estÃ¡n expresados en moneda nacional (MXN) e incluyen IVA. Entrega sujeta a disponibilidad y confirmaciÃ³n de pedido.';

            // Valores inmutables
            const bizWeb = 'www.integralcomputacion.com';
            const bizIg = '@integralcomputacion';
            const bizFb = '/integralcomputacion';

            // Gather form values
            const clientCompany = document.getElementById('fClientCompany').value.trim();
            const clientName = document.getElementById('fClientName').value.trim() || (clientCompany ? '' : 'Cliente');
            const clientPhone = document.getElementById('fClientPhone').value || '';
            const clientEmail = document.getElementById('fClientEmail').value || '';

            const vendorSelect = document.getElementById('fVendor');
            const userId = vendorSelect.value;
            const vendorName = vendorSelect.options[vendorSelect.selectedIndex].text.split(' (')[0];

            saveClientToCRM(clientName, clientEmail, clientPhone); // Guardar en CRM local inmediato

            const quoteNum = document.getElementById('fQuoteNum').value || `IC${userId}-${new Date().toISOString().split('T')[0].split('-').reverse().join('').slice(0, 4)}${new Date().getFullYear().toString().slice(-2)}-01`;
            const validity = document.getElementById('fValidity').value || '15';
            const notes = document.getElementById('fNotes').value || '';
            const ivaRate = parseFloat(document.getElementById('fIvaRate').value) || 16;
            const discount = parseFloat(document.getElementById('fDiscount').value) || 0;
            const payments = getCheckedPayments();

            // Usar la fecha seleccionada en el input
            const selectedDate = new Date(document.getElementById('fQuoteDate').value + 'T00:00:00');
            const dateStr = selectedDate.toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' });

            const expiry = new Date(selectedDate.getTime() + parseInt(validity) * 86400000)
                .toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' });

            // Calculate totals
            let subtotal = quoteItems.reduce((s, i) => s + (parseFloat(i.price) || 0) * (i.qty || 1), 0);
            const disc = subtotal * discount / 100;
            const base = subtotal - disc;
            const iva = base * ivaRate / 100;
            const total = base + iva;

            // Guardar en DB antes de imprimir
            try {
                await apiFetch('/api/quotes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        quoteId: quoteNum, clientName, clientCompany, clientEmail, clientPhone,
                        userId, total, items: quoteItems, notes, validity
                    })
                });
                loadClients(); // Recargar historial de clientes
            } catch (e) { console.error('Error saving quote', e); }


            const payRow = payments.length ? payments.map(p => `â€¢ ${p}`).join('<br>') : 'Consultar con el vendedor';

            // Design Layout Values
            const cfgLogoScale = parseFloat(localStorage.getItem('cfgLogoScale')) || 1;
            const cfgLogoY = parseFloat(localStorage.getItem('cfgLogoY')) || 0;
            const cfgTextY = parseFloat(localStorage.getItem('cfgTextY')) || 0;

            // Explicit Pagination Logic - Optimizada para no dejar huecos
            const chunkedPages = [];
            const itemsCopy = [...quoteItems];

            const FIRST_PAGE_MAX_WITH_TOTALS = 7;
            const FIRST_PAGE_MAX_NO_TOTALS = 12;
            const MIDDLE_PAGE_MAX = 18;
            const LAST_PAGE_MAX_WITH_TOTALS = 12;
            const MIN_ITEMS_LAST_PAGE = 3;

            let isFirst = true;
            while (itemsCopy.length > 0) {
                let take;
                let len = itemsCopy.length;

                if (isFirst) {
                    if (len <= FIRST_PAGE_MAX_WITH_TOTALS) {
                        take = len;
                    } else if (len <= FIRST_PAGE_MAX_NO_TOTALS) {
                        take = len - MIN_ITEMS_LAST_PAGE;
                        if (take < 1) take = 1;
                    } else {
                        let remain = len - FIRST_PAGE_MAX_NO_TOTALS;
                        if (remain > 0 && remain < MIN_ITEMS_LAST_PAGE) {
                            take = FIRST_PAGE_MAX_NO_TOTALS - (MIN_ITEMS_LAST_PAGE - remain);
                        } else {
                            take = FIRST_PAGE_MAX_NO_TOTALS;
                        }
                    }
                    isFirst = false;
                } else {
                    if (len <= LAST_PAGE_MAX_WITH_TOTALS) {
                        take = len;
                    } else if (len <= MIDDLE_PAGE_MAX) {
                        take = len - MIN_ITEMS_LAST_PAGE;
                        if (take < 1) take = 1;
                    } else {
                        let remain = len - MIDDLE_PAGE_MAX;
                        if (remain > 0 && remain < MIN_ITEMS_LAST_PAGE) {
                            take = MIDDLE_PAGE_MAX - (MIN_ITEMS_LAST_PAGE - remain);
                        } else {
                            take = MIDDLE_PAGE_MAX;
                        }
                    }
                }
                chunkedPages.push(itemsCopy.splice(0, take));
            }
            if (chunkedPages.length === 0) chunkedPages.push([]);

            let pagesHtml = '';
            const totalPages = chunkedPages.length;
            let currentGlobalItemIndex = 0;

            chunkedPages.forEach((chunk, pageIndex) => {
                const isFirstPage = pageIndex === 0;
                const isLastPage = pageIndex === totalPages - 1;

                const chunkRows = chunk.map((item) => {
                    currentGlobalItemIndex++;
                    return `
        <tr>
            <td>${currentGlobalItemIndex}</td>
            <td>
                ${item.name || item.id}
                <span class="pv-td-code">${item.id}</span>
            </td>
            <td style="text-align:right">${item.qty || 1}</td>
            <td style="text-align:right">${parseFloat(item.price) > 0 ? fmt(item.price) : 'â€”'}</td>
            <td style="text-align:right">${parseFloat(item.price) > 0 ? fmt((item.qty || 1) * parseFloat(item.price)) : 'â€”'}</td>
        </tr>`;
                }).join('');

                const pagePagination = `PÃ¡gina ${pageIndex + 1} de ${totalPages}`;

                pagesHtml += `
        <div class="pv-page">
            ${isFirstPage ? `
            <div class="pv-header">
                <img class="pv-logo" src="${window.location.origin}/assets/images/HORIZONTAL grande.png" onerror="this.style.display='none'" style="transform: translateY(${cfgLogoY}px) scale(${cfgLogoScale}); transform-origin: left center;">

                <div class="pv-biz" style="transform: translateY(${cfgTextY}px);">
                    Suministros y Equipos de CÃ³mputo<br>
                    Tel: ${bizPhone}<br>
                    ${bizEmail}<br>
                    ${bizWeb}
                </div>
            </div>

            <div class="pv-meta">
                <div class="pv-meta-box">
                    <h4>CotizaciÃ³n para</h4>
                    <p>
                        ${clientCompany ? `<strong style="font-size:10pt;">${clientCompany}</strong><br>` : ''}
                        <strong>${clientName}</strong><br>
                        ${clientPhone ? `Tel: ${clientPhone}<br>` : ''}
                        ${clientEmail ? `${clientEmail}<br>` : ''}
                    </p>
                </div>
                <div class="pv-meta-box">
                    <p>
                        <strong>Folio: ${quoteNum}</strong><br>
                        Fecha: <span style="white-space: nowrap;">${dateStr}</span><br>
                        Vigente hasta: <span style="white-space: nowrap;">${expiry}</span><br>
                        Agente de Ventas: ${vendorName}
                    </p>
                </div>
            </div>

            ${notes ? `<div style="font-size:8.5pt; color:#2c2c2e; padding:6pt 0; font-weight:600;">ðŸ“Œ Nota al cliente: ${notes}</div>` : ''}
            ` : `<div style="height: 15mm;"></div>`}

            <div class="pv-table-container" ${(!isLastPage || (isFirstPage && isLastPage)) ? 'style="flex-grow: 1; display: flex; flex-direction: column; justify-content: center;"' : ''}>
                <table class="pv-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>DescripciÃ³n</th>
                            <th style="text-align:right; white-space: nowrap;">Cant.</th>
                            <th style="text-align:right; white-space: nowrap;">P. Unit.</th>
                            <th style="text-align:right; white-space: nowrap;">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>${chunkRows}</tbody>
                </table>
            </div>

            ${isLastPage ? `
            <div class="pv-totals">
                <div class="pv-totals-box">
                    <div class="pv-totals-row"><span>Subtotal</span><span>${fmt(subtotal)}</span></div>
                    ${discount > 0 ? `<div class="pv-totals-row"><span>Descuento (${discount}%)</span><span>-${fmt(disc)}</span></div>` : ''}
                    <div class="pv-totals-row"><span>IVA (${ivaRate}%)</span><span>${fmt(iva)}</span></div>
                    <div class="pv-totals-row total"><span>TOTAL</span><span>${fmt(total)}</span></div>
                </div>
            </div>

            <div class="pv-flex-spacer" style="flex-grow:1;"></div>

            <div style="page-break-inside: avoid; margin-top: auto; padding-top: 15pt;">
                <div class="pv-legal-notes" style="border-top: none; padding-top: 0; margin-bottom: 12pt; text-align: center;">
                    ${bizTerms}
                </div>



                <div class="pv-footer" style="border-top: 1pt solid #e5e5ea; padding-top: 12pt;">
                    <div class="pv-footer-col">
                        <h5>Formas de Pago</h5>
                        <p>${payRow}</p>
                    </div>
                    <div class="pv-footer-col" style="text-align:right;">
                        <h5>Para Transferencias</h5>
                        <p>
                            NOMBRE: MARIA DEL ROCIO ROMERO AGUIRRE<br>
                            BANCO: BANORTE<br>
                            CUENTA: 1055297913<br>
                            CLABE: 072320 010552979138
                        </p>
                    </div>

                </div>
            </div>
            ` : ``}

            <div class="pv-global-footer">
                <div style="text-align:left;">CotizaciÃ³n No. <strong>${quoteNum}</strong></div>
                <div style="text-align:center; padding: 0 5pt;"></div>
                <div style="text-align:right;">${pagePagination}</div>
            </div>
        </div>
        `;
            });

            // â”€â”€ GENERAR PDF VÃA SERVIDOR (Puppeteer) â”€â”€ funciona en iOS PWA, Safari y desktop
            closeFormalSheet();
            const pdfName = `Cotizacion_${quoteNum}_${clientName.replace(/[^a-zA-Z0-9]/g, '_')}`;
            await generateServerPdf(pagesHtml, pdfName);
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // PDF SERVER â€” Puppeteer genera el A4 perfecto, navigator.share() lo entrega
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function generateServerPdf(pagesHtml, pdfName) {
            // Construir HTML completo autocontenido para Puppeteer
            let css = '';
            document.querySelectorAll('style').forEach(s => { css += s.textContent; });

            const fullHtml = `<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=794">
  <title>${pdfName}</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; background: white;
                 font-family: -apple-system, 'Helvetica Neue', Arial, sans-serif; }
    ${css}
    /* â”€â”€ Override: resetear restricciones de la app que cortan el PDF â”€â”€ */
    html, body {
      max-width: none !important;
      width: 100% !important;
      overflow: visible !important;
      padding: 0 !important;
      margin: 0 !important;
    }
    #printView {
      display: block !important;
      position: static !important;
      width: auto !important;
      max-width: none !important;
      height: auto !important;
      overflow: visible !important;
    }
  </style>

</head>
<body><div id="printView">${pagesHtml}</div></body>
</html>`;


            // Mostrar spinner mientras el servidor genera el PDF
            showToast('â³ Generando PDFâ€¦');

            try {
                const response = await apiFetch('/api/quotes/pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ html: fullHtml, filename: pdfName })
                });

                if (!response.ok) {
                    const e = await response.json().catch(() => ({}));
                    throw new Error(e.error || 'Error del servidor');
                }

                const blob = await response.blob();
                const file = new File([blob], pdfName + '.pdf', { type: 'application/pdf' });

                // iOS PWA + Safari: usar Share Sheet nativo (funciona en todo contexto)
                const isMobile = /iPad|iPhone|iPod|Android/.test(navigator.userAgent);
                if (isMobile && navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({ files: [file], title: pdfName });
                } else {
                    // Desktop: descarga directa
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = pdfName + '.pdf';
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    setTimeout(() => URL.revokeObjectURL(url), 5000);
                    showToast('âœ… PDF descargado');
                }

            } catch (err) {
                console.error('[PDF]', err);
                showToast('âŒ Error: ' + err.message);
            }
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function buildTextQuote() {
            const date = new Date().toLocaleDateString('es-MX');
            let lines = ['ðŸ§¾ *CotizaciÃ³n â€” Integral ComputaciÃ³n*', `ðŸ“… ${date}`, ''];
            quoteItems.forEach(item => {
                const qty = item.qty || 1, p = parseFloat(item.price) || 0, sub = qty * p;
                lines.push(`â–¸ *${item.id}*`);
                if (item.name) lines.push(`  ${item.name}`);
                lines.push(`  Cant: ${qty}   Precio: ${p > 0 ? fmt(p) + ' c/u' : 'Por cotizar'}`);
                if (p > 0 && qty > 1) lines.push(`  Subtotal: ${fmt(sub)}`);
                lines.push('');
            });
            const total = quoteItems.reduce((s, i) => s + (parseFloat(i.price) || 0) * (i.qty || 1), 0);
            if (total > 0) lines.push(`ðŸ’° *Total estimado: ${fmt(total)}*`);
            lines.push('', '_Precios sujetos a disponibilidad._');
            return lines.join('\n');
        }
        function shareWhatsApp() { window.open(`https://wa.me/?text=${encodeURIComponent(buildTextQuote())}`, '_blank'); }
        async function copyQuote() {
            try { await navigator.clipboard.writeText(buildTextQuote()); showToast('âœ“ Copiado'); }
            catch (_) { showToast('âœ“ Copiado'); }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // UTILS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }
        function resetAll() {
            document.getElementById('pasteInput').value = '';
            if (document.getElementById('manualSearchInput')) {
                document.getElementById('manualSearchInput').value = '';
                manualSelectedProducts = [];
                renderManualSelected();
            }
            quoteItems = []; notFound = []; goToStep(1);
        }
        function goBack() { window.location.href = '/public/admin/home.html'; }

        // â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // MigraciÃ³n automÃ¡tica: corregir email antiguo en localStorage
        (function migrateDefaults() {
            const savedEmail = localStorage.getItem('bizEmail');
            if (!savedEmail || savedEmail === 'info@integralcomputacion.com') {
                localStorage.setItem('bizEmail', 'ventas@integralcomputacion.com');
            }
            const savedTerms = localStorage.getItem('bizTerms');
            if (savedTerms && savedTerms.includes('Esta cotizaciÃ³n es vÃ¡lida por 15 dÃ­as naturales')) {
                localStorage.setItem('bizTerms', 'Todos los precios estÃ¡n expresados en moneda nacional (MXN) e incluyen IVA. Entrega sujeta a disponibilidad y confirmaciÃ³n de pedido.');
            }
        })();

        // Theme initialization
        if (localStorage.getItem('admin-theme') === 'dark') {
            document.body.classList.add('dark-mode');
        }

        (async () => { if (await checkAuth()) loadInitialData(); })();

        /* â”€â”€ SIDEBAR JS â”€â”€ */
        function openSidebar() {
            document.getElementById('sidebarOverlay').classList.add('active');
            document.getElementById('sidebar').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeSidebar() {
            document.getElementById('sidebarOverlay').classList.remove('active');
            document.getElementById('sidebar').classList.remove('active');
            document.body.style.overflow = '';
        }

        // â”€â”€ GUARDAR COTIZACIÃ“N AL GENERAR PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function saveQuoteToHistory({ quoteId, clientName, clientEmail, clientPhone, userId, total, items, notes, validity }) {
            try {
                await apiFetch('/api/quotes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quoteId, clientName, clientEmail, clientPhone, userId, total, items, notes, validity })
                });
            } catch (e) {
                console.warn('[Quote Save]', e.message);
            }
        }

        // â”€â”€ HISTORIAL DE COTIZACIONES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let _histFilter = { status: 'active', userId: '' };

        function openSidebarTab(target) {
            closeSidebar();
            if (target === 'history') {
                showHistoryPanel();
            } else if (target === 'contacts') {
                showContactsPanel();
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // PANEL DE CONTACTOS â€” action sheet, ediciÃ³n, llamada, eliminar
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function showContactsPanel() {
            let panel = document.getElementById('contactsPanel');
            if (!panel) {
                panel = document.createElement('div');
                panel.id = 'contactsPanel';
                panel.style.cssText = 'position:fixed;inset:0;z-index:600;background:var(--bg);display:flex;flex-direction:column;';
                panel.innerHTML = `
                    <div style="position:sticky;top:0;background:var(--surface);border-bottom:1px solid var(--border);
                                padding:16px 20px;display:flex;align-items:center;gap:12px;z-index:10;">
                        <button onclick="closeContactsPanel()" style="background:none;border:none;font-size:20px;color:var(--accent);cursor:pointer;">
                            <i class="fa-solid fa-chevron-left"></i>
                        </button>
                        <h2 style="font-size:17px;font-weight:800;flex:1;">Contactos Guardados</h2>
                        <span id="contactsCount" style="font-size:13px;color:var(--subtext);font-weight:600;"></span>
                    </div>
                    <!-- Buscador -->
                    <div style="padding:12px 16px;background:var(--surface);border-bottom:1px solid var(--border);">
                        <div style="position:relative;">
                            <i class="fa-solid fa-magnifying-glass" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--subtext);font-size:14px;"></i>
                            <input id="contactSearch" type="search" placeholder="Buscar por nombre, telÃ©fono o emailâ€¦"
                                oninput="searchContacts(this.value)"
                                style="width:100%;box-sizing:border-box;padding:10px 12px 10px 36px;border:1.5px solid var(--border);
                                       border-radius:12px;font-size:14px;font-family:'Inter',sans-serif;background:var(--bg);
                                       color:var(--text);outline:none;">
                        </div>
                    </div>
                    <!-- Lista -->
                    <div id="contactsList" style="flex:1;overflow-y:auto;padding:12px 16px;"></div>

                    <!-- Action Sheet universal -->
                    <div id="ctxOverlay" onclick="closeCtxSheet()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:800;"></div>
                    <div id="ctxSheet" style="display:none;position:fixed;bottom:0;left:0;right:0;max-width:600px;margin:0 auto;
                         background:var(--surface);border-radius:20px 20px 0 0;padding:8px 12px calc(16px + env(safe-area-inset-bottom));z-index:801;">
                        <div style="width:36px;height:4px;background:var(--border);border-radius:2px;margin:6px auto 16px;"></div>
                        <div id="ctxClientName" style="font-size:16px;font-weight:800;text-align:center;margin-bottom:16px;"></div>
                        <div id="ctxActions" style="display:flex;flex-direction:column;gap:8px;"></div>
                        <button onclick="closeCtxSheet()" style="width:100%;margin-top:10px;padding:14px;border-radius:14px;
                            border:1.5px solid var(--border);background:var(--bg);font-size:15px;font-family:'Inter',sans-serif;
                            font-weight:600;color:var(--subtext);cursor:pointer;">Cancelar</button>
                    </div>

                    <!-- Modal ediciÃ³n de cliente -->
                    <div id="editClientOverlay" onclick="closeEditClient()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);
                         backdrop-filter:blur(8px);z-index:900;align-items:flex-end;justify-content:center;"></div>
                    <div id="editClientSheet" style="display:none;position:fixed;bottom:0;left:0;right:0;max-width:600px;margin:0 auto;
                         background:var(--surface);border-radius:20px 20px 0 0;padding:20px 20px calc(20px + env(safe-area-inset-bottom));z-index:901;">
                        <div style="width:36px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 20px;"></div>
                        <h3 style="font-size:17px;font-weight:800;margin-bottom:20px;">Editar Contacto</h3>
                        <input type="hidden" id="editClientId">
                        <div class="field">
                            <label class="lbl">Empresa <span style="font-weight:400;color:var(--subtext);">(opcional)</span></label>
                            <input class="inp" id="editClientCompany" type="text" placeholder="RazÃ³n social o empresa">
                        </div>
                        <div class="field">
                            <label class="lbl">Nombre del contacto</label>
                            <input class="inp" id="editClientNameField" type="text" placeholder="Nombre completo">
                        </div>

                        <div class="field">
                            <label class="lbl">TelÃ©fono / WhatsApp</label>
                            <input class="inp" id="editClientPhone" type="text" inputmode="tel" placeholder="+52 33...">
                        </div>
                        <div class="field">
                            <label class="lbl">Email</label>
                            <input class="inp" id="editClientEmail" type="text" inputmode="email" placeholder="correo@...">
                        </div>
                        <button onclick="saveEditClient()" class="btn-primary" style="margin-top:8px;">
                            <i class="fa-solid fa-check"></i> Guardar cambios
                        </button>
                        <button onclick="closeEditClient()" class="btn-secondary">Cancelar</button>
                    </div>
                `;
                document.body.appendChild(panel);
            }
            panel.style.display = 'flex';
            loadContacts('');
        }

        function closeContactsPanel() {
            const p = document.getElementById('contactsPanel');
            if (p) p.style.display = 'none';
        }

        let _contactSearchTimer = null;
        function searchContacts(q) {
            clearTimeout(_contactSearchTimer);
            _contactSearchTimer = setTimeout(() => loadContacts(q), 300);
        }

        async function loadContacts(q = '') {
            const list = document.getElementById('contactsList');
            const countEl = document.getElementById('contactsCount');
            if (!list) return;
            list.innerHTML = '<p style="text-align:center;color:var(--subtext);padding:40px 0;">Cargandoâ€¦</p>';
            try {
                const url = q ? `/api/clients?q=${encodeURIComponent(q)}` : '/api/clients';
                const res = await apiFetch(url);
                const { data } = await res.json();
                if (countEl) countEl.textContent = `${data.length} contacto${data.length !== 1 ? 's' : ''}`;
                if (!data || data.length === 0) {
                    list.innerHTML = '<p style="text-align:center;color:var(--subtext);padding:40px 0;"><i class="fa-solid fa-user-slash" style="font-size:32px;display:block;margin-bottom:12px;opacity:.3;"></i>Sin contactos aÃºn</p>';
                    return;
                }
                list.innerHTML = data.map(c => {
                    const lastDate = c.last_quoted_at
                        ? new Date(c.last_quoted_at).toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' })
                        : 'â€”';
                    const totalSpent = c.total_spent
                        ? `$${Number(c.total_spent).toLocaleString('es-MX', { minimumFractionDigits: 2 })}`
                        : 'â€”';
                    const quotes = c.quote_count || 0;
                    const initials = c.name.split(' ').slice(0, 2).map(w => w[0]).join('').toUpperCase();
                    const avatarColor = stringToColor(c.name);
                    const safe = (s) => encodeURIComponent(s || '');
                    return `
                    <div style="background:var(--surface);border:1.5px solid var(--border);border-radius:14px;
                                padding:14px 16px;margin-bottom:10px;display:flex;gap:12px;align-items:center;">
                        <div style="width:44px;height:44px;border-radius:50%;background:${avatarColor};
                                    display:flex;align-items:center;justify-content:center;
                                    font-size:15px;font-weight:800;color:white;flex-shrink:0;">
                            ${initials}
                        </div>
                        <div style="flex:1;min-width:0;">
                            ${c.company ? `<div style="font-size:11px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:.5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${c.company}</div>` : ''}
                            <div style="font-size:15px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${c.name}</div>
                            ${c.phone ? `<div style="font-size:12px;color:var(--subtext);">${c.phone}</div>` : ''}
                            ${c.email ? `<div style="font-size:12px;color:var(--subtext);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${c.email}</div>` : ''}
                            <div style="display:flex;gap:10px;margin-top:4px;align-items:center;">
                                <span style="font-size:11px;color:var(--subtext);">${quotes} cotizaciÃ³n${quotes !== 1 ? 'es' : ''}</span>
                                <span style="font-size:11px;color:var(--subtext);">Ãšltimo: ${lastDate}</span>
                            </div>
                        </div>
                        <button onclick="openCtxSheet(${c.id},'${safe(c.name)}','${safe(c.company)}','${safe(c.phone)}','${safe(c.email)}')"
                            style="background:var(--bg);border:1.5px solid var(--border);border-radius:50%;
                                   width:36px;height:36px;display:flex;align-items:center;justify-content:center;
                                   font-size:18px;color:var(--subtext);cursor:pointer;flex-shrink:0;letter-spacing:1px;">
                            â‹¯
                        </button>
                    </div>`;
                }).join('');

            } catch (e) {
                list.innerHTML = `<p style="text-align:center;color:var(--red);padding:40px 0;">Error: ${e.message}</p>`;
            }
        }

        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            const colors = ['#0071e3', '#34c759', '#ff9500', '#ff3b30', '#af52de', '#5ac8fa', '#ff6b6b', '#4ecdc4'];
            return colors[Math.abs(hash) % colors.length];
        }

        // â”€â”€ ACTION SHEET POR CONTACTO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function openCtxSheet(id, nameEnc, companyEnc, phoneEnc, emailEnc) {
            const name = decodeURIComponent(nameEnc);
            const company = decodeURIComponent(companyEnc);
            const phone = decodeURIComponent(phoneEnc);
            const email = decodeURIComponent(emailEnc);

            const nameEl = document.getElementById('ctxClientName');
            nameEl.innerHTML = company
                ? `<div style="font-size:12px;font-weight:700;color:var(--accent);text-transform:uppercase;">${company}</div>${name}`
                : name;

            const btnStyle = `width:100%;padding:14px;border-radius:14px;border:1.5px solid var(--border);
                background:var(--surface);font-size:15px;font-family:'Inter',sans-serif;
                font-weight:600;text-align:left;cursor:pointer;display:flex;align-items:center;gap:12px;`;

            document.getElementById('ctxActions').innerHTML = `
                ${phone ? `
                <a href="tel:${phone.replace(/\s/g, '')}"
                    style="${btnStyle} text-decoration:none;color:var(--text);" onclick="closeCtxSheet()">
                    <i class="fa-solid fa-phone" style="color:var(--green);width:20px;text-align:center;"></i> Llamar a ${name}
                </a>
                <a href="https://wa.me/52${phone.replace(/\D/g, '')}" target="_blank"
                    style="${btnStyle} text-decoration:none;color:var(--text);" onclick="closeCtxSheet()">
                    <i class="fa-brands fa-whatsapp" style="color:#25d366;width:20px;text-align:center;"></i> WhatsApp
                </a>` : ''}
                <button style="${btnStyle} color:var(--text);"
                    onclick="closeCtxSheet();showClientQuotes('${nameEnc}')">
                    <i class="fa-solid fa-clock-rotate-left" style="color:var(--accent);width:20px;text-align:center;"></i> Cotizaciones Previas
                </button>
                <button style="${btnStyle} color:var(--text);"
                    onclick="closeCtxSheet();newQuoteForClient(decodeURIComponent('${nameEnc}'),decodeURIComponent('${companyEnc}'),decodeURIComponent('${phoneEnc}'),decodeURIComponent('${emailEnc}'))">
                    <i class="fa-solid fa-file-circle-plus" style="color:var(--green);width:20px;text-align:center;"></i> Nueva CotizaciÃ³n
                </button>
                <button style="${btnStyle} color:var(--text);"
                    onclick="closeCtxSheet();openEditClient(${id},'${nameEnc}','${companyEnc}','${phoneEnc}','${emailEnc}')">
                    <i class="fa-solid fa-pen" style="color:var(--orange);width:20px;text-align:center;"></i> Editar Contacto
                </button>
                <button style="${btnStyle} color:var(--red);"
                    onclick="closeCtxSheet();confirmDeleteClient(${id},decodeURIComponent('${nameEnc}'))">
                    <i class="fa-solid fa-trash" style="width:20px;text-align:center;"></i> Eliminar Contacto
                </button>
            `;

            document.getElementById('ctxOverlay').style.display = 'block';
            document.getElementById('ctxSheet').style.display = 'block';
        }

        function closeCtxSheet() {
            document.getElementById('ctxOverlay').style.display = 'none';
            document.getElementById('ctxSheet').style.display = 'none';
        }

        // â”€â”€ COTIZACIONES PREVIAS DE UN CLIENTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function showClientQuotes(nameEnc) {
            const name = decodeURIComponent(nameEnc);

            // Crear o reutilizar el panel
            let panel = document.getElementById('clientQuotesPanel');
            if (!panel) {
                panel = document.createElement('div');
                panel.id = 'clientQuotesPanel';
                panel.style.cssText = 'position:fixed;inset:0;z-index:700;background:var(--bg);display:flex;flex-direction:column;';
                document.body.appendChild(panel);
            }
            panel.innerHTML = `
                <div style="position:sticky;top:0;background:var(--surface);border-bottom:1px solid var(--border);padding:16px 20px;display:flex;align-items:center;gap:12px;z-index:10;">
                    <button onclick="document.getElementById('clientQuotesPanel').style.display='none';" style="background:none;border:none;font-size:20px;color:var(--accent);cursor:pointer;">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                    <div style="flex:1;min-width:0;">
                        <div style="font-size:17px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${name}</div>
                        <div style="font-size:12px;color:var(--subtext);">Historial de cotizaciones</div>
                    </div>
                </div>
                <div id="clientQuotesList" style="flex:1;overflow-y:auto;padding:12px 16px;">
                    <p style="text-align:center;color:var(--subtext);padding:40px 0;">Cargandoâ€¦</p>
                </div>
            `;
            panel.style.display = 'flex';

            // Cargar activas + archivadas (no papelera)
            try {
                const nameParam = encodeURIComponent(name);
                const [resActive, resArch] = await Promise.all([
                    apiFetch(`/api/quotes?status=active&clientName=${nameParam}`),
                    apiFetch(`/api/quotes?status=archived&clientName=${nameParam}`)
                ]);
                const { data: active } = await resActive.json();
                const { data: archived } = await resArch.json();
                const all = [...(active || []), ...(archived || [])]
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                const list = document.getElementById('clientQuotesList');
                if (!list) return;
                if (all.length === 0) {
                    list.innerHTML = '<p style="text-align:center;color:var(--subtext);padding:40px 0;"><i class="fa-solid fa-inbox" style="font-size:32px;display:block;margin-bottom:12px;opacity:.3;"></i>Sin cotizaciones</p>';
                    return;
                }
                list.innerHTML = all.map(q => {
                    const date = new Date(q.created_at).toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' });
                    const total = q.total ? `$${Number(q.total).toLocaleString('es-MX', { minimumFractionDigits: 2 })} ` : 'â€”';
                    const vendor = q.user_id === '01' ? 'RocÃ­o Romero' : q.user_id === '02' ? 'RocÃ­o VÃ¡zquez' : `Usuario ${q.user_id} `;
                    const statusBadge = q.status === 'archived'
                        ? `<span style="font-size:10px;font-weight:700;color:var(--orange);background:rgba(255,149,0,.1);padding:2px 7px;border-radius:8px;" > Archivada</span> `
                        : `<span style="font-size:10px;font-weight:700;color:var(--green);background:rgba(52,199,89,.1);padding:2px 7px;border-radius:8px;" > Activa</span> `;
                    return `
                    <div style="background:var(--surface);border:1.5px solid var(--border);border-radius:14px;padding:14px 16px;margin-bottom:10px;">
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
                            <span style="font-size:12px;font-weight:800;font-family:monospace;color:var(--accent);">${q.quote_id}</span>
                            ${statusBadge}
                        </div>
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <span style="font-size:12px;color:var(--subtext);">${date} Â· ${vendor}</span>
                            <span style="font-size:16px;font-weight:800;color:var(--green);">${total}</span>
                        </div>
                        ${q.notes ? `<div style="font-size:11px;color:var(--subtext);margin-top:4px;font-style:italic;">ðŸ“Œ ${q.notes}</div>` : ''}
                    </div>`;
                }).join('');
            } catch (e) {
                const list = document.getElementById('clientQuotesList');
                if (list) list.innerHTML = `<p style="text-align:center;color:var(--red);padding:40px 0;" > Error: ${e.message}</p > `;
            }
        }

        // â”€â”€ EDITAR CONTACTO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function openEditClient(id, nameEnc, companyEnc, phoneEnc, emailEnc) {
            document.getElementById('editClientId').value = id;
            document.getElementById('editClientNameField').value = decodeURIComponent(nameEnc);
            document.getElementById('editClientCompany').value = decodeURIComponent(companyEnc || '');
            document.getElementById('editClientPhone').value = decodeURIComponent(phoneEnc);
            document.getElementById('editClientEmail').value = decodeURIComponent(emailEnc);
            document.getElementById('editClientOverlay').style.display = 'block';
            document.getElementById('editClientSheet').style.display = 'block';
        }

        function closeEditClient() {
            document.getElementById('editClientOverlay').style.display = 'none';
            document.getElementById('editClientSheet').style.display = 'none';
        }

        async function saveEditClient() {
            const id = document.getElementById('editClientId').value;
            const name = document.getElementById('editClientNameField').value.trim();
            const company = document.getElementById('editClientCompany').value.trim();
            const phone = document.getElementById('editClientPhone').value.trim();
            const email = document.getElementById('editClientEmail').value.trim();
            if (!name) { showToast('âŒ El nombre es obligatorio'); return; }
            try {
                const res = await apiFetch(`/api/clients/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, company, phone, email })
                });
                if (!res.ok) throw new Error('Error del servidor');
                showToast('âœ… Contacto actualizado');
                closeEditClient();
                loadContacts(document.getElementById('contactSearch')?.value || '');
            } catch (e) {
                showToast('âŒ Error: ' + e.message);
            }
        }

        // â”€â”€ ELIMINAR CON CONFIRMACIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function confirmDeleteClient(id, name) {
            if (confirm(`Â¿Eliminar a "${name}" de los contactos ?

                Esta acciÃ³n no elimina sus cotizaciones anteriores.`)) {
                deleteClient(id, name);
            }
        }

        async function deleteClient(id, name) {
            try {
                const res = await apiFetch(`/api/clients/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Error del servidor');
                showToast(`ðŸ—‘ï¸ ${name} eliminado`);
                loadContacts(document.getElementById('contactSearch')?.value || '');
            } catch (e) {
                showToast('âŒ Error: ' + e.message);
            }
        }

        function newQuoteForClient(name, company, phone, email) {
            closeContactsPanel();
            goToStep(1);
            localStorage.setItem('_prefillClient', JSON.stringify({ name, company, phone, email }));
            showToast(`âœ… Contacto cargado: ${company || name}`);
        }

        function showHistoryPanel() {
            // Crear overlay de historial si no existe
            let panel = document.getElementById('historyPanel');
            if (!panel) {
                panel = document.createElement('div');
                panel.id = 'historyPanel';
                panel.style.cssText = `position: fixed; inset: 0; z-index: 600; background: var(--bg); display: flex; flex-direction: column; `;
                panel.innerHTML = `
                <div style="position:sticky;top:0;background:var(--surface);border-bottom:1px solid var(--border);padding:16px 20px;display:flex;align-items:center;gap:12px;z-index:10;">
                    <button onclick="closeHistoryPanel()" style="background:none;border:none;font-size:20px;color:var(--accent);cursor:pointer;">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                    <h2 style="font-size:17px;font-weight:800;flex:1;">Historial de Cotizaciones</h2>
                </div>
                    <!--Tabs vendedor-- >
                    <div style="display:flex;gap:0;border-bottom:1px solid var(--border);background:var(--surface);">
                        <button class="hist-tab active" data-uid="" onclick="setHistTab(this,'')" 
                            style="flex:1;padding:12px 8px;border:none;background:none;font-weight:700;font-size:13px;cursor:pointer;border-bottom:2px solid var(--accent);color:var(--accent);">Todos</button>
                        <button class="hist-tab" data-uid="01" onclick="setHistTab(this,'01')"
                            style="flex:1;padding:12px 8px;border:none;background:none;font-weight:600;font-size:13px;cursor:pointer;color:var(--subtext);">RocÃ­o Romero</button>
                        <button class="hist-tab" data-uid="02" onclick="setHistTab(this,'02')"
                            style="flex:1;padding:12px 8px;border:none;background:none;font-weight:600;font-size:13px;cursor:pointer;color:var(--subtext);">R. VÃ¡zquez</button>
                    </div>
                    <!--Filtro status-- >
                    <div style="display:flex;gap:8px;padding:12px 16px;background:var(--surface);border-bottom:1px solid var(--border);">
                        <button class="hist-status-btn active" onclick="setHistStatus(this,'active')" 
                            style="flex:1;padding:7px;border-radius:20px;border:1.5px solid var(--accent);background:rgba(0,113,227,.08);color:var(--accent);font-size:12px;font-weight:700;cursor:pointer;">Activas</button>
                        <button class="hist-status-btn" onclick="setHistStatus(this,'archived')"
                            style="flex:1;padding:7px;border-radius:20px;border:1.5px solid var(--border);background:none;color:var(--subtext);font-size:12px;font-weight:700;cursor:pointer;">Archivadas</button>
                        <button class="hist-status-btn" onclick="setHistStatus(this,'trash')"
                            style="flex:1;padding:7px;border-radius:20px;border:1.5px solid var(--border);background:none;color:var(--subtext);font-size:12px;font-weight:700;cursor:pointer;">Papelera</button>
                    </div>
                    <!--Lista -->
                <div id="historyList" style="flex:1;overflow-y:auto;padding:12px 16px;"></div>
            `;
                document.body.appendChild(panel);
            }
            panel.style.display = 'flex';
            loadHistory();
        }

        function closeHistoryPanel() {
            const p = document.getElementById('historyPanel');
            if (p) p.style.display = 'none';
        }

        function setHistTab(btn, uid) {
            document.querySelectorAll('.hist-tab').forEach(b => {
                b.style.borderBottom = 'none'; b.style.color = 'var(--subtext)'; b.style.fontWeight = '600';
                b.classList.remove('active');
            });
            btn.style.borderBottom = '2px solid var(--accent)'; btn.style.color = 'var(--accent)'; btn.style.fontWeight = '700';
            btn.classList.add('active');
            _histFilter.userId = uid;
            loadHistory();
        }

        function setHistStatus(btn, status) {
            document.querySelectorAll('.hist-status-btn').forEach(b => {
                b.style.borderColor = 'var(--border)'; b.style.background = 'none'; b.style.color = 'var(--subtext)';
                b.classList.remove('active');
            });
            btn.style.borderColor = 'var(--accent)'; btn.style.background = 'rgba(0,113,227,.08)'; btn.style.color = 'var(--accent)';
            btn.classList.add('active');
            _histFilter.status = status;
            loadHistory();
        }

        async function loadHistory() {
            const list = document.getElementById('historyList');
            if (!list) return;
            list.innerHTML = '<p style="text-align:center;color:var(--subtext);padding:40px 0;">Cargando...</p>';
            try {
                let url = `/api/quotes ? status = ${_histFilter.status} `;
                if (_histFilter.userId) url += `& userId=${_histFilter.userId} `;
                const res = await apiFetch(url);
                const { data } = await res.json();
                if (!data || data.length === 0) {
                    list.innerHTML = '<p style="text-align:center;color:var(--subtext);padding:40px 0;"><i class="fa-solid fa-inbox" style="font-size:32px;display:block;margin-bottom:12px;opacity:.3;"></i>Sin cotizaciones</p>';
                    return;
                }
                list.innerHTML = data.map(q => {
                    const date = new Date(q.created_at).toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' });
                    const total = q.total ? `$${Number(q.total).toLocaleString('es-MX', { minimumFractionDigits: 2 })} ` : 'â€”';
                    const vendor = q.user_id === '01' ? 'RocÃ­o Romero' : q.user_id === '02' ? 'RocÃ­o VÃ¡zquez' : `Usuario ${q.user_id} `;
                    const vendorColor = q.user_id === '01' ? '#0071e3' : '#9b59b6';
                    const actions = _histFilter.status === 'active'
                        ? `<button onclick="updateQuoteStatus(${q.id},'archived')" title="Archivar" style="background:none;border:none;color:var(--subtext);cursor:pointer;font-size:15px;padding:6px;">
                            <i class="fa-solid fa-box-archive"></i></button>
                           <button onclick="updateQuoteStatus(${q.id},'trash')" title="Papelera" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:15px;padding:6px;">
                            <i class="fa-solid fa-trash"></i></button>`
                        : _histFilter.status === 'archived'
                            ? `<button onclick="updateQuoteStatus(${q.id},'active')" title="Restaurar" style="background:none;border:none;color:var(--green);cursor:pointer;font-size:15px;padding:6px;">
                                <i class="fa-solid fa-rotate-left"></i></button>
                               <button onclick="updateQuoteStatus(${q.id},'trash')" title="Papelera" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:15px;padding:6px;">
                                <i class="fa-solid fa-trash"></i></button>`
                            : `<button onclick="updateQuoteStatus(${q.id},'active')" title="Restaurar" style="background:none;border:none;color:var(--green);cursor:pointer;font-size:15px;padding:6px;">
                                <i class="fa-solid fa-rotate-left"></i></button>`;
                    return `
                    <div style="background:var(--surface);border:1.5px solid var(--border);border-radius:14px;padding:14px 16px;margin-bottom:10px;display:flex;flex-direction:column;gap:6px;">
                        <div style="display:flex;align-items:center;justify-content:space-between;">
                            <span style="font-size:12px;font-weight:800;font-family:monospace;color:var(--accent);">${q.quote_id}</span>
                            <div style="display:flex;gap:4px;">${actions}</div>
                        </div>
                        <div style="font-size:15px;font-weight:700;">${q.client_name}</div>
                        <div style="display:flex;align-items:center;justify-content:space-between;">
                            <span style="font-size:12px;color:var(--subtext);">${date}</span>
                            <span style="font-size:14px;font-weight:800;color:var(--green);">${total}</span>
                        </div>
                        <div style="font-size:11px;font-weight:700;color:${vendorColor};">${vendor}</div>
                    </div>`;
                }).join('');
            } catch (e) {
                list.innerHTML = `<p style="text-align:center;color:var(--red);padding:40px 0;">Error: ${e.message}</p>`;
            }
        }

        async function updateQuoteStatus(id, status) {
            try {
                await apiFetch(`/api/quotes/${id}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                const msgs = { archived: 'ðŸ“¦ CotizaciÃ³n archivada', trash: 'ï¿½ï¸ Enviada a papelera', active: 'âœ… CotizaciÃ³n restaurada' };
                showToast(msgs[status] || 'Actualizado');
                loadHistory();
            } catch (e) {
                showToast('âŒ Error: ' + e.message);
            }
        }

        function toggleDarkMode() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('admin-theme', isDark ? 'dark' : 'light');
            showToast(isDark ? 'ðŸŒ™ Modo Oscuro Activado' : 'â˜€ï¸ Modo Claro Activado');
        }
    </script>
</body>

</html>