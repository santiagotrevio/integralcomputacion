<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Cotizador | Integral</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg: #f5f5f7;
            --surface: #ffffff;
            --border: #e5e5ea;
            --text: #1c1c1e;
            --subtext: #8e8e93;
            --accent: #0071e3;
            --green: #34c759;
            --red: #ff3b30;
            --orange: #ff9500;
            --radius: 16px;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100dvh;
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: calc(90px + var(--safe-bottom));
        }

        /* â”€â”€ TOP BAR â”€â”€ */
        .topbar {
            position: sticky;
            top: 0;
            z-index: 200;
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 14px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .topbar-back {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--accent);
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .topbar h1 {
            font-size: 17px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--subtext);
            font-size: 18px;
            padding: 4px;
        }

        /* â”€â”€ STEPS â”€â”€ */
        .steps {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px 0;
        }

        .step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border);
            transition: all 0.3s;
        }

        .step-dot.active {
            background: var(--accent);
            width: 24px;
            border-radius: 4px;
        }

        .step-dot.done {
            background: var(--green);
        }

        /* â”€â”€ SECTIONS â”€â”€ */
        .section {
            display: none;
            padding: 20px;
        }

        .section.active {
            display: block;
        }

        /* â”€â”€ INPUTS â”€â”€ */
        .lbl {
            font-size: 11px;
            font-weight: 700;
            color: var(--subtext);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            display: block;
        }

        .inp {
            width: 100%;
            padding: 12px 14px;
            border: 1.5px solid var(--border);
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            color: var(--text);
            background: var(--surface);
            outline: none;
            transition: border-color 0.2s;
        }

        .inp:focus {
            border-color: var(--accent);
        }

        .inp::placeholder {
            color: var(--subtext);
        }

        .field {
            margin-bottom: 14px;
        }

        .row2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* â”€â”€ BUTTONS â”€â”€ */
        .btn-primary {
            width: 100%;
            padding: 16px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: opacity 0.2s, transform 0.1s;
        }

        .btn-primary:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .btn-primary:disabled {
            opacity: 0.45;
            cursor: default;
        }

        .btn-secondary {
            width: 100%;
            padding: 14px;
            background: var(--surface);
            color: var(--text);
            border: 1.5px solid var(--border);
            border-radius: var(--radius);
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* â”€â”€ PASTE STEP â”€â”€ */
        .paste-area {
            width: 100%;
            min-height: 200px;
            padding: 16px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius);
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            line-height: 1.6;
            color: var(--text);
            background: var(--surface);
            resize: none;
            outline: none;
            transition: border-color 0.2s;
        }

        .paste-area:focus {
            border-color: var(--accent);
        }

        .paste-area::placeholder {
            color: var(--subtext);
        }

        .hint-card {
            background: rgba(0, 113, 227, 0.06);
            border: 1px solid rgba(0, 113, 227, 0.15);
            border-radius: 12px;
            padding: 12px 14px;
            margin-top: 14px;
            font-size: 13px;
            color: #0071e3;
            line-height: 1.5;
        }

        /* â”€â”€ PRODUCT LIST â”€â”€ */
        .section-title {
            font-size: 20px;
            font-weight: 800;
            letter-spacing: -0.5px;
            margin-bottom: 6px;
        }

        .section-sub {
            font-size: 14px;
            color: var(--subtext);
            margin-bottom: 20px;
        }

        .product-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .product-item {
            background: var(--surface);
            border: 1.5px solid var(--border);
            border-radius: var(--radius);
            padding: 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .product-item.matched {
            border-color: rgba(52, 199, 89, 0.3);
        }

        .product-header {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .product-status {
            flex-shrink: 0;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            background: rgba(52, 199, 89, 0.12);
            color: var(--green);
        }

        .product-meta {
            flex: 1;
            min-width: 0;
        }

        .product-code {
            font-size: 11px;
            font-weight: 700;
            font-family: monospace;
            color: var(--subtext);
            letter-spacing: 0.5px;
        }

        .product-name {
            font-size: 14px;
            font-weight: 600;
        }

        .product-brand {
            font-size: 12px;
            color: var(--subtext);
        }

        .product-remove {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--subtext);
            padding: 4px;
            font-size: 16px;
            flex-shrink: 0;
        }

        .product-remove:hover {
            color: var(--red);
        }

        .product-qty-price {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .field-wrap {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .field-label {
            font-size: 11px;
            font-weight: 700;
            color: var(--subtext);
            text-transform: uppercase;
        }

        .field-input {
            padding: 10px 12px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            font-weight: 600;
            color: var(--text);
            width: 100%;
            outline: none;
            transition: border-color 0.2s;
        }

        .field-input:focus {
            border-color: var(--accent);
        }

        .field-input.price {
            color: var(--green);
        }

        .not-found-section {
            margin-top: 20px;
            padding: 14px 16px;
            background: rgba(255, 149, 0, 0.06);
            border: 1px solid rgba(255, 149, 0, 0.2);
            border-radius: var(--radius);
        }

        .not-found-label {
            font-size: 12px;
            font-weight: 700;
            color: var(--orange);
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .code-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .code-chip {
            font-size: 11px;
            font-family: monospace;
            font-weight: 700;
            padding: 4px 9px;
            border-radius: 8px;
            background: rgba(255, 149, 0, 0.1);
            color: var(--orange);
        }

        /* â”€â”€ STEP 3: QUICK QUOTE â”€â”€ */
        .quote-card {
            background: var(--surface);
            border: 1.5px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .quote-header {
            padding: 16px 18px;
            background: linear-gradient(135deg, #0071e3, #0051a8);
            color: white;
        }

        .quote-header .q-title {
            font-size: 17px;
            font-weight: 800;
            margin-bottom: 2px;
        }

        .quote-header .q-date {
            font-size: 12px;
            opacity: 0.75;
        }

        .quote-row {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 8px;
            align-items: center;
            padding: 12px 18px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        .quote-row:last-child {
            border-bottom: none;
        }

        .quote-row-name {
            font-weight: 600;
        }

        .quote-row-code {
            font-size: 11px;
            font-family: monospace;
            color: var(--subtext);
        }

        .quote-row-qty {
            font-size: 13px;
            font-weight: 600;
            color: var(--subtext);
            text-align: right;
        }

        .quote-row-price {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent);
            text-align: right;
            white-space: nowrap;
        }

        .quote-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 18px;
            background: var(--bg);
            font-weight: 800;
        }

        .quote-total-label {
            font-size: 13px;
            color: var(--subtext);
        }

        .quote-total-amount {
            font-size: 22px;
            letter-spacing: -0.5px;
        }

        /* â”€â”€ ACTION BAR â”€â”€ */
        .action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            padding: 12px 20px calc(12px + var(--safe-bottom));
            display: flex;
            gap: 8px;
        }

        .btn-wa {
            flex: 1;
            padding: 14px;
            background: #25d366;
            color: white;
            border: none;
            border-radius: 14px;
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 7px;
        }

        .btn-pdf {
            flex: 1;
            padding: 14px;
            background: #0071e3;
            color: white;
            border: none;
            border-radius: 14px;
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 7px;
        }

        .btn-icon {
            padding: 14px 16px;
            background: var(--bg);
            color: var(--text);
            border: 1.5px solid var(--border);
            border-radius: 14px;
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* â”€â”€ FORMAL SHEET (bottom modal) â”€â”€ */
        .sheet-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 300;
            align-items: flex-end;
            justify-content: center;
        }

        .sheet-overlay.open {
            display: flex;
        }

        .sheet {
            background: white;
            width: 100%;
            max-width: 600px;
            border-radius: 24px 24px 0 0;
            padding: 0 0 calc(20px + var(--safe-bottom));
            max-height: 90dvh;
            overflow-y: auto;
        }

        .sheet-handle-area {
            padding: 14px 20px 0;
            position: sticky;
            top: 0;
            background: white;
            border-bottom: 1px solid var(--border);
            padding-bottom: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
        }

        .sheet-handle {
            width: 36px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin: 0 auto 14px;
        }

        .sheet-title {
            font-size: 17px;
            font-weight: 800;
        }

        .sheet-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--subtext);
        }

        .sheet-body {
            padding: 20px;
        }

        .section-divider {
            font-size: 11px;
            font-weight: 700;
            color: var(--subtext);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin: 20px 0 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        /* Checkboxes (payment methods) */
        .check-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .check-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            font-size: 13px;
            font-weight: 600;
        }

        .check-item input[type="checkbox"] {
            accent-color: var(--accent);
            width: 16px;
            height: 16px;
        }

        .check-item:has(input:checked) {
            border-color: var(--accent);
            background: rgba(0, 113, 227, 0.05);
        }

        /* â”€â”€ TOAST â”€â”€ */
        .toast {
            position: fixed;
            bottom: 110px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px 20px;
            border-radius: 24px;
            font-size: 13px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            white-space: nowrap;
            z-index: 9999;
        }

        .toast.show {
            opacity: 1;
        }

        /* â”€â”€ EMPTY STATE â”€â”€ */
        .empty-state {
            text-align: center;
            padding: 48px 20px;
            color: var(--subtext);
        }

        .empty-state i {
            font-size: 40px;
            opacity: 0.25;
            margin-bottom: 12px;
            display: block;
        }

        .empty-state p {
            font-size: 14px;
        }

        /* â”€â”€ LOGIN OVERLAY â”€â”€ */
        #loginOverlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(20px);
            z-index: 9999;
            justify-content: center;
            align-items: flex-end;
        }

        .login-sheet {
            background: white;
            width: 100%;
            max-width: 600px;
            border-radius: 24px 24px 0 0;
            padding: 32px 24px calc(32px + var(--safe-bottom));
            text-align: center;
        }

        .login-sheet .handle {
            width: 36px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin: 0 auto 28px;
        }

        .login-sheet img {
            height: 56px;
            margin-bottom: 20px;
        }

        .login-sheet h2 {
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .login-sheet p {
            font-size: 14px;
            color: var(--subtext);
            margin-bottom: 24px;
        }

        .login-sheet input[type="password"] {
            width: 100%;
            padding: 14px;
            border: 1.5px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            text-align: center;
            margin-bottom: 12px;
            outline: none;
            font-family: 'Inter', sans-serif;
        }

        .login-sheet input:focus {
            border-color: var(--accent);
        }

        #loginError {
            color: var(--red);
            font-size: 13px;
            margin-bottom: 8px;
            display: none;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PRINT STYLES â€” CotizaciÃ³n Formal
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #printView {
            display: none;
        }

        @media print {
            body>*:not(#printView) {
                display: none !important;
            }

            #printView {
                display: block !important;
                font-family: 'Inter', -apple-system, Arial, sans-serif;
                color: #1c1c1e;
                font-size: 11pt;
                max-width: 100%;
                width: 100%;
                padding: 0;
            }

            /* Explicit Multi-Page A4 Structure */
            .pv-page {
                width: 100%;
                height: 100vh;
                padding: 18mm 14mm 20mm 14mm;
                box-sizing: border-box;
                display: flex;
                flex-direction: column;
                page-break-after: always;
                overflow: hidden;
            }

            .pv-page:last-child {
                page-break-after: avoid;
            }

            .pv-flex-spacer {
                flex-grow: 1;
            }

            /* Global Footer (now anchored perfectly via flexbox) */
            .pv-global-footer {
                margin-top: auto;
                height: 12mm;
                display: grid;
                grid-template-columns: 1fr auto 1fr;
                width: 100%;
                align-items: center;
                border-top: 1pt solid #00AEEF;
                border-image: linear-gradient(to right, #00AEEF, #EC008C, #FFF200) 1;
                font-size: 8pt;
                color: #555;
                flex-shrink: 0;
                padding-top: 8pt;
            }

            .pv-global-footer strong {
                color: #1c1c1e;
            }

            /* Header */
            .pv-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-end;
                padding-bottom: 12pt;
                border-bottom: 2pt solid #00AEEF;
                border-image: linear-gradient(to right, #00AEEF, #EC008C, #FFF200) 1;
                margin-bottom: 16pt;
            }

            .pv-logo {
                height: 60pt;
                object-fit: contain;
            }

            .pv-biz {
                text-align: right;
                font-size: 9pt;
                color: #555;
                line-height: 1.5;
            }

            .pv-biz strong {
                font-size: 13pt;
                color: #1c1c1e;
                display: block;
                margin-bottom: 3pt;
            }

            /* Quote meta */
            .pv-meta {
                display: flex;
                justify-content: space-between;
                gap: 12pt;
                margin-bottom: 14pt;
            }

            .pv-meta-box {
                flex: 1;
                border: 0.5pt solid #EC008C;
                border-left: 3pt solid #00AEEF;
                border-radius: 4pt;
                padding: 10pt 12pt;
                background: #fafafc;
            }

            .pv-meta-box h4 {
                font-size: 7pt;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5pt;
                color: #004b93;
                margin-bottom: 6pt;
            }

            .pv-meta-box p {
                font-size: 9pt;
                line-height: 1.6;
                color: #333;
            }

            .pv-meta-box strong {
                color: #1c1c1e;
            }

            /* Table */
            .pv-table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 14pt;
                page-break-inside: auto;
            }

            .pv-table thead {
                display: table-header-group;
            }

            .pv-table thead tr {
                background: #00AEEF;
                color: white;
            }

            .pv-table thead th {
                padding: 7pt 10pt;
                font-size: 8.5pt;
                text-align: left;
            }

            .pv-table thead th:last-child,
            .pv-table thead th:nth-last-child(-n+2) {
                text-align: right;
            }

            .pv-table tbody tr {
                border-bottom: 0.5pt solid #e5e5ea;
                page-break-inside: avoid;
            }

            .pv-table tbody tr:nth-child(even) {
                background: #f8f8fa;
            }

            .pv-table tbody td {
                padding: 7pt 10pt;
                font-size: 9.5pt;
                vertical-align: middle;
            }

            .pv-table tbody td:last-child,
            .pv-table tbody td:nth-last-child(-n+2) {
                text-align: right;
            }

            .pv-td-code {
                font-family: monospace;
                font-size: 8pt;
                color: #666;
                display: block;
            }

            /* Totals */
            .pv-totals {
                display: flex;
                justify-content: flex-end;
                margin-bottom: 14pt;
                page-break-inside: avoid;
            }

            .pv-totals-box {
                width: 220pt;
                background: #fdfdfd;
                border: 1pt solid #e5e5ea;
                border-top: 2pt solid #00AEEF;
                border-radius: 4pt;
                padding: 12pt;
            }

            .pv-totals-row {
                display: flex;
                justify-content: space-between;
                padding: 5pt 0;
                font-size: 9.5pt;
                font-weight: 400;
                border-bottom: 0.5pt solid #f0f0f0;
            }

            .pv-totals-row.total {
                font-size: 14pt;
                font-weight: 800;
                border: none;
                padding-top: 10pt;
                color: #1c1c1e;
            }

            .pv-totals-row.total span:last-child {
                color: #1c1c1e;
            }

            /* Footer */
            .pv-footer {
                border-top: 1pt solid #e5e5ea;
                padding-top: 12pt;
                display: flex;
                gap: 16pt;
                margin-bottom: 8pt;
            }

            .pv-footer-col {
                flex: 1;
            }

            .pv-footer-col h5 {
                font-size: 7.5pt;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.4pt;
                color: #004b93;
                margin-bottom: 5pt;
            }

            .pv-footer-col p {
                font-size: 8.5pt;
                color: #555;
                line-height: 1.6;
            }

            .pv-legal-notes {
                font-size: 7.5pt;
                color: #777;
                text-align: justify;
                border-top: 0.5pt dashed #ccc;
                padding-top: 6pt;
                line-height: 1.4;
            }

            @page {
                size: Letter;
                margin: 0 !important;
                /* Margin 0 evita que el navegador imprima cabeceras y pie de URLs */
            }

            #printView {
                padding: 0;
                box-sizing: border-box;
            }
        }
    </style>
</head>

<body>

    <!-- TOP BAR -->
    <header class="topbar">
        <button class="topbar-back" onclick="goBack()"><i class="fa-solid fa-chevron-left"></i> Admin</button>
        <h1>Cotizador</h1>
        <button class="icon-btn" id="btnReset" onclick="resetAll()" title="Nueva cotizaciÃ³n" style="display:none;">
            <i class="fa-solid fa-arrow-rotate-left"></i>
        </button>
    </header>

    <!-- STEPS -->
    <div class="steps">
        <div class="step-dot active" id="dot0"></div>
        <div class="step-dot" id="dot1"></div>
        <div class="step-dot" id="dot2"></div>
    </div>

    <!-- â•â• STEP 1: PASTE â•â• -->
    <div class="section active" id="step1">
        <br>
        <span class="lbl">Pega el texto aquÃ­</span>
        <textarea class="paste-area" id="pasteInput"
            placeholder="Pega aquÃ­ una conversaciÃ³n de WhatsApp, email, lista de cÃ³digos o cualquier texto que contenga cÃ³digos de productosâ€¦"></textarea>
        <div class="hint-card">
            <i class="fa-solid fa-wand-magic-sparkles"></i>
            El sistema detecta automÃ¡ticamente los cÃ³digos de productos y los busca en el catÃ¡logo.
        </div>
        <button class="btn-primary" id="btnAnalyze" onclick="analyzeText()">
            <i class="fa-solid fa-magnifying-glass"></i> Analizar texto
        </button>
    </div>

    <!-- â•â• STEP 2: REVIEW â•â• -->
    <div class="section" id="step2">
        <br>
        <div class="section-title">Productos detectados</div>
        <div class="section-sub" id="step2Sub">Revisa y ajusta cantidades y precios.</div>
        <div class="product-list" id="productList"></div>

        <div id="notFoundSection" class="not-found-section" style="display:none;">
            <div class="not-found-label"><i class="fa-solid fa-triangle-exclamation"></i> CÃ³digos no encontrados</div>
            <div class="code-chips" id="notFoundChips"></div>
        </div>

        <button class="btn-primary" id="btnGenerate" onclick="generateQuote()">
            <i class="fa-solid fa-file-invoice-dollar"></i> Generar cotizaciÃ³n
        </button>
        <button class="btn-secondary" onclick="goToStep(1)">
            <i class="fa-solid fa-chevron-left"></i> Volver a editar texto
        </button>
    </div>

    <!-- â•â• STEP 3: QUOTE â•â• -->
    <div class="section" id="step3">
        <br>
        <div class="section-title">Lista para compartir</div>
        <div class="section-sub">CotizaciÃ³n rÃ¡pida para WhatsApp Â· o genera un PDF formal.</div>

        <div class="quote-card">
            <div class="quote-header">
                <div class="q-title">CotizaciÃ³n â€” Integral ComputaciÃ³n</div>
                <div class="q-date" id="quoteDate"></div>
            </div>
            <div id="quoteBody"></div>
            <div class="quote-total">
                <span class="quote-total-label">TOTAL ESTIMADO</span>
                <span class="quote-total-amount" id="quoteTotal">â€”</span>
            </div>
        </div>

        <button class="btn-secondary" onclick="goToStep(2)" style="margin-top:16px;">
            <i class="fa-solid fa-pencil"></i> Editar precios
        </button>
    </div>

    <!-- â•â• ACTION BAR â•â• -->
    <div class="action-bar" id="actionBar" style="display:none;">
        <button class="btn-wa" onclick="shareWhatsApp()">
            <i class="fa-brands fa-whatsapp"></i> WhatsApp
        </button>
        <button class="btn-pdf" onclick="openFormalSheet()">
            <i class="fa-solid fa-file-pdf"></i> PDF Formal
        </button>
        <button class="btn-icon" onclick="copyQuote()" title="Copiar">
            <i class="fa-solid fa-copy"></i>
        </button>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FORMAL PDF SHEET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="sheet-overlay" id="formalOverlay" onclick="if(event.target===this) closeFormalSheet()">
        <div class="sheet" id="formalSheet">
            <div class="sheet-handle-area">
                <div>
                    <div class="sheet-handle"></div>
                    <div class="sheet-title">ğŸ“‹ CotizaciÃ³n Formal (PDF)</div>
                </div>
                <div>
                    <button class="sheet-close" onclick="openSettingsSheet()" style="margin-right:8px;"
                        title="Configurar Empresa"><i class="fa-solid fa-gear"></i></button>
                    <button class="sheet-close" onclick="closeFormalSheet()"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>
            <div class="sheet-body">

                <!-- Cliente -->
                <div class="section-divider">Datos del Cliente</div>
                <div class="field">
                    <label class="lbl" for="fClientName">Nombre / Empresa</label>
                    <input class="inp" id="fClientName" type="text" placeholder="Nombre del cliente o empresa"
                        list="clientsList" onchange="onClientSelect(this.value)">
                    <datalist id="clientsList"></datalist>
                </div>
                <div class="row2">
                    <div class="field">
                        <label class="lbl" for="fClientPhone">TelÃ©fono / WhatsApp</label>
                        <input class="inp" id="fClientPhone" type="tel" placeholder="+52 33...">
                    </div>
                    <div class="field">
                        <label class="lbl" for="fClientEmail">Email</label>
                        <input class="inp" id="fClientEmail" type="email" placeholder="correo@...">
                    </div>
                </div>
                <div class="field">
                    <label class="lbl" for="fVendor">Vendedor / Agente</label>
                    <select class="inp" id="fVendor" onchange="updateQuoteId()">
                        <option value="01">RocÃ­o Romero (USUARIO 01)</option>
                        <option value="02">RocÃ­o VÃ¡zquez (USUARIO 02)</option>
                    </select>
                </div>

                <div class="row2">
                    <div class="field">
                        <label class="lbl" for="fQuoteDate">Fecha de CotizaciÃ³n</label>
                        <input class="inp" id="fQuoteDate" type="date" onchange="updateQuoteId()">
                    </div>
                    <div class="field">
                        <label class="lbl" for="fValidity">Vigencia (dÃ­as)</label>
                        <input class="inp" id="fValidity" type="number" value="15" min="1">
                    </div>
                </div>
                <div class="field">
                    <label class="lbl" for="fQuoteNum">NÃºmero de CotizaciÃ³n</label>
                    <input class="inp" id="fQuoteNum" type="text" readonly
                        style="background:#f5f5f7; color:#8e8e93; font-weight:700;">
                </div>
                <div class="field">
                    <label class="lbl" for="fNotes">Notas adicionales</label>
                    <input class="inp" id="fNotes" type="text" placeholder="Ej. Precio incluye instalaciÃ³n bÃ¡sica">
                </div>

                <!-- IVA -->
                <div class="section-divider">Impuestos</div>
                <div class="row2">
                    <div class="field">
                        <label class="lbl" for="fIvaRate">IVA (%)</label>
                        <input class="inp" id="fIvaRate" type="number" value="16" min="0" max="100">
                    </div>
                    <div class="field">
                        <label class="lbl" for="fDiscount">Descuento (%)</label>
                        <input class="inp" id="fDiscount" type="number" value="0" min="0" max="100">
                    </div>
                </div>

                <!-- Formas de pago -->
                <div class="section-divider">Formas de Pago Aceptadas</div>
                <div class="check-grid">
                    <label class="check-item"><input type="checkbox" id="payEfectivo" checked> Efectivo</label>
                    <label class="check-item"><input type="checkbox" id="payTransferencia" checked>
                        Transferencia</label>
                    <label class="check-item"><input type="checkbox" id="payBBVA"> BBVA CoDi</label>
                    <label class="check-item"><input type="checkbox" id="payOXXO"> OXXO Pay</label>
                    <label class="check-item"><input type="checkbox" id="payTarjeta"> Tarjeta (3% cargo)</label>
                    <label class="check-item"><input type="checkbox" id="payMercadoPago"> MercadoPago</label>
                </div>

                <button class="btn-primary" onclick="printFormal()" style="margin-top:24px;">
                    <i class="fa-solid fa-print"></i> Generar y Guardar PDF
                </button>
                <button class="btn-secondary" onclick="closeFormalSheet()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SETTINGS SHEET (Company Data)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="sheet-overlay" id="settingsOverlay" onclick="if(event.target===this) closeSettingsSheet()">
        <div class="sheet" id="settingsSheet">
            <div class="sheet-handle-area">
                <div>
                    <div class="sheet-handle"></div>
                    <div class="sheet-title">âš™ï¸ Datos de la Empresa</div>
                </div>
                <button class="sheet-close" onclick="closeSettingsSheet()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="sheet-body">
                <div class="section-divider">Contacto Principal</div>
                <div class="row2">
                    <div class="field">
                        <label class="lbl" for="cfgPhone">TelÃ©fono del Negocio</label>
                        <input class="inp" id="cfgPhone" type="text" placeholder="(33) 12680092">
                    </div>
                    <div class="field">
                        <label class="lbl" for="cfgEmail">Email del Negocio</label>
                        <input class="inp" id="cfgEmail" type="email" placeholder="ventas@...">
                    </div>
                </div>

                <div class="section-divider">Redes Sociales</div>
                <div class="field">
                    <label class="lbl" for="cfgWa">WhatsApp (PDF Footer)</label>
                    <input class="inp" id="cfgWa" type="text" placeholder="(33) 12680092">
                </div>

                <div class="section-divider">Pie de PÃ¡gina (Legales)</div>
                <div class="field">
                    <label class="lbl" for="cfgTerms">Condiciones (fijas en toda cotizaciÃ³n)</label>
                    <input class="inp" id="cfgTerms" type="text"
                        placeholder="Precios sujetos a disponibilidad y cambio sin previo aviso.">
                </div>

                <button class="btn-primary" onclick="saveSettings()" style="margin-top:24px;">
                    <i class="fa-solid fa-save"></i> Guardar Cambios
                </button>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PRINT VIEW (only visible to printer)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="printView"></div>

    <!-- TOAST -->
    <div class="toast" id="toast"></div>

    <!-- LOGIN OVERLAY -->
    <div id="loginOverlay">
        <div class="login-sheet">
            <div class="handle"></div>
            <img src="/assets/images/LOGO SIN TEXTO.png" alt="Logo"
                onerror="this.src='/assets/logo.svg'; this.style.height='40px'">
            <h2>Acceso Protegido</h2>
            <p>Introduce la contraseÃ±a del panel de administraciÃ³n para continuar.</p>
            <div id="loginError">ContraseÃ±a incorrecta.</div>
            <input type="password" id="adminPwd" placeholder="ContraseÃ±a" onkeydown="if(event.key==='Enter') doLogin()">
            <button class="btn-primary" onclick="doLogin()" style="margin-top:0;">
                <i class="fa-solid fa-lock-open"></i> Desbloquear
            </button>
        </div>
    </div>

    <script>
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // STATE
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const TOKEN_KEY = 'admin_token';
        let products = [];
        let quoteItems = [];
        let notFound = [];
        let clients = []; // Historial de clientes

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // AUTH & LOAD
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function getToken() { return localStorage.getItem(TOKEN_KEY); }
        async function apiFetch(url, opts = {}) {
            opts.headers = { ...(opts.headers || {}), 'Authorization': `Bearer ${getToken()}` };
            return fetch(url, opts);
        }
        async function checkAuth() {
            if (!getToken()) { showLogin(); return false; }
            try {
                const r = await fetch('/api/brands', { headers: { 'Authorization': `Bearer ${getToken()}` } });
                if (r.status === 401) { showLogin(); return false; }
            } catch (_) { }
            return true;
        }
        function showLogin() {
            document.getElementById('loginOverlay').style.display = 'flex';
            setTimeout(() => document.getElementById('adminPwd').focus(), 300);
        }
        async function doLogin() {
            const pwd = document.getElementById('adminPwd').value;
            const err = document.getElementById('loginError');
            err.style.display = 'none';
            try {
                const r = await fetch('/api/login', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: pwd })
                });
                const d = await r.json();
                if (r.ok && d.token) {
                    localStorage.setItem(TOKEN_KEY, d.token);
                    document.getElementById('loginOverlay').style.display = 'none';
                    loadInitialData();
                } else { err.style.display = 'block'; document.getElementById('adminPwd').value = ''; }
            } catch (e) { err.textContent = 'Error de conexiÃ³n.'; err.style.display = 'block'; }
        }

        async function loadInitialData() {
            loadProducts();
            loadClients();
        }

        async function loadProducts() {
            try {
                const r = await apiFetch('/api/products');
                if (r.status === 401) { showLogin(); return; }
                const d = await r.json();
                products = d.data || [];
            } catch (_) { showToast('âš ï¸ Sin conexiÃ³n al servidor'); }
        }

        async function loadClients() {
            try {
                const r = await apiFetch('/api/clients');
                const d = await r.json();
                clients = d.data || [];
                const list = document.getElementById('clientsList');
                list.innerHTML = clients.map(c => `<option value="${c.name}">`).join('');
            } catch (_) { }
        }

        function onClientSelect(name) {
            const c = clients.find(cl => cl.name === name);
            if (c) {
                document.getElementById('fClientPhone').value = c.phone || '';
                document.getElementById('fClientEmail').value = c.email || '';
            }
        }

        async function updateQuoteId() {
            const userId = document.getElementById('fVendor').value;
            const date = document.getElementById('fQuoteDate').value;
            try {
                const r = await apiFetch(`/api/quotes/next-id/${userId}?date=${date}`);
                const d = await r.json();
                document.getElementById('fQuoteNum').value = d.nextId;
            } catch (_) {
                showToast('Error al generar folio');
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // TEXT PARSING
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const SKIP_WORDS = new Set(['HOLA', 'BUENOS', 'DIAS', 'TARDES', 'NOCHES', 'GRACIAS', 'FAVOR',
            'PRECIO', 'PRECIOS', 'CUANTO', 'CUANTOS', 'NECESITO', 'TENGO', 'QUIERO', 'COTIZAR',
            'HACER', 'DAME', 'POR', 'PARA', 'CON', 'SIN', 'DEL', 'LAS', 'LOS', 'UNA', 'UNO', 'QUE',
            'ESA', 'ESE', 'ESTE', 'ESTA', 'INTEGRAL', 'COSTO', 'COSTOS', 'TODOS', 'TIENE',
            'TIENEN', 'COMO', 'CUANDO', 'DONDE', 'SOBRE', 'ENTRE', 'STOCK', 'MARCA', 'MODELO',
            'SERIE', 'CODIGO', 'NUMERO', 'UNIDAD', 'CANTIDAD', 'TOTAL', 'IVA', 'MXN', 'USD',
            'DADO', 'SOBRE', 'ENTRE', 'TENGO', 'BUENAS']);

        function extractCodes(text) {
            const raw = text.toUpperCase();
            const matches = [];
            const re = /\b([A-Z0-9][A-Z0-9\-\.]{2,}[A-Z0-9])\b/g;
            let m;
            while ((m = re.exec(raw)) !== null) {
                const t = m[1];
                if (!SKIP_WORDS.has(t) && t.length >= 4) matches.push(t);
            }
            return [...new Set(matches)];
        }

        function matchCode(code) {
            let p = products.find(pr => pr.id.toUpperCase() === code);
            if (!p) p = products.find(pr => pr.id.toUpperCase().includes(code) || code.includes(pr.id.toUpperCase()));
            return p || null;
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // NAVIGATION
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function goToStep(n) {
            document.querySelectorAll('.section').forEach((s, i) => s.classList.toggle('active', i === n - 1));
            [0, 1, 2].forEach(i => {
                const d = document.getElementById(`dot${i}`);
                d.classList.remove('active', 'done');
                if (i === n - 1) d.classList.add('active');
                else if (i < n - 1) d.classList.add('done');
            });
            document.getElementById('actionBar').style.display = (n === 3) ? 'flex' : 'none';
            document.getElementById('btnReset').style.display = (n > 1) ? 'block' : 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // STEP 1 â†’ ANALYZE
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function analyzeText() {
            const text = document.getElementById('pasteInput').value.trim();
            if (!text) { showToast('Pega primero un texto'); return; }
            if (!products.length) { showToast('Cargando catÃ¡logoâ€¦'); await loadProducts(); }
            const btn = document.getElementById('btnAnalyze');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Analizandoâ€¦';
            const codes = extractCodes(text);
            quoteItems = []; notFound = [];
            codes.forEach(code => {
                const p = matchCode(code);
                if (p && !quoteItems.find(q => q.id === p.id))
                    quoteItems.push({ id: p.id, name: p.name, brand: p.brand, qty: 1, price: '' });
                else if (!p) notFound.push(code);
            });
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-magnifying-glass"></i> Analizar texto';
            renderReview();
            goToStep(2);
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // STEP 2 â†’ RENDER
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function renderReview() {
            const list = document.getElementById('productList');
            document.getElementById('step2Sub').textContent = quoteItems.length
                ? `${quoteItems.length} producto${quoteItems.length !== 1 ? 's' : ''} encontrado${quoteItems.length !== 1 ? 's' : ''}. Ajusta cantidades y precios.`
                : 'No se encontraron cÃ³digos conocidos en el texto.';
            if (!quoteItems.length) {
                list.innerHTML = `<div class="empty-state"><i class="fa-solid fa-magnifying-glass"></i><p>NingÃºn cÃ³digo identificado.<br>Intenta con otro texto.</p></div>`;
            } else {
                list.innerHTML = '';
                quoteItems.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.className = 'product-item matched';
                    div.innerHTML = `
                <div class="product-header">
                    <div class="product-status"><i class="fa-solid fa-check"></i></div>
                    <div class="product-meta">
                        <div class="product-code">${item.id}</div>
                        <div class="product-name">${item.name || 'â€”'}</div>
                        ${item.brand ? `<div class="product-brand">${item.brand}</div>` : ''}
                    </div>
                    <button class="product-remove" onclick="removeItem(${idx})"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="product-qty-price">
                    <div class="field-wrap">
                        <label class="field-label">Cantidad</label>
                        <input class="field-input" type="number" min="1" value="${item.qty}"
                            oninput="quoteItems[${idx}].qty=parseInt(this.value)||1" inputmode="numeric">
                    </div>
                    <div class="field-wrap">
                        <label class="field-label">Precio Unit.</label>
                        <input class="field-input price" type="number" min="0" step="0.01"
                            placeholder="$ â€”" value="${item.price}"
                            oninput="quoteItems[${idx}].price=this.value" inputmode="decimal">
                    </div>
                </div>`;
                    list.appendChild(div);
                });
            }
            const nfSection = document.getElementById('notFoundSection');
            const nfChips = document.getElementById('notFoundChips');
            nfSection.style.display = notFound.length ? 'block' : 'none';
            nfChips.innerHTML = notFound.map(c => `<span class="code-chip">${c}</span>`).join('');
            document.getElementById('btnGenerate').disabled = !quoteItems.length;
        }
        function removeItem(idx) { quoteItems.splice(idx, 1); renderReview(); }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // STEP 3 â†’ QUICK QUOTE
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const fmt = n => Number(n).toLocaleString('es-MX', { style: 'currency', currency: 'MXN', minimumFractionDigits: 0 });

        function generateQuote() {
            const date = new Date().toLocaleDateString('es-MX', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('quoteDate').textContent = date.charAt(0).toUpperCase() + date.slice(1);
            const body = document.getElementById('quoteBody');
            body.innerHTML = '';
            let total = 0;
            quoteItems.forEach(item => {
                const qty = item.qty || 1, p = parseFloat(item.price) || 0, sub = qty * p;
                total += sub;
                const row = document.createElement('div');
                row.className = 'quote-row';
                row.innerHTML = `
            <div>
                <div class="quote-row-name">${item.name || item.id}</div>
                <div class="quote-row-code">${item.id}</div>
            </div>
            <div class="quote-row-qty">Ã— ${qty}</div>
            <div class="quote-row-price">${p > 0 ? fmt(sub) : 'â€”'}</div>`;
                body.appendChild(row);
            });
            document.getElementById('quoteTotal').textContent = total > 0 ? fmt(total) : 'â€”';
            goToStep(3);
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // FORMAL PDF SHEET
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function openFormalSheet() {
            // Predeterminar fecha de hoy
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fQuoteDate').value = today;

            await updateQuoteId();
            document.getElementById('formalOverlay').classList.add('open');
        }
        function closeFormalSheet() {
            document.getElementById('formalOverlay').classList.remove('open');
        }

        // --- SETTINGS SHEET ---
        function openSettingsSheet() {
            closeFormalSheet();
            document.getElementById('settingsOverlay').classList.add('open');

            // Reemplazar antiguo default si quedÃ³ en cachÃ©
            let bizEmail = localStorage.getItem('bizEmail');
            if (bizEmail === 'info@integralcomputacion.com') bizEmail = 'ventas@integralcomputacion.com';

            // Cargar desde localStorage o poner defaults
            document.getElementById('cfgPhone').value = localStorage.getItem('bizPhone') || '(33) 12680092';
            document.getElementById('cfgEmail').value = bizEmail || 'ventas@integralcomputacion.com';
            document.getElementById('cfgWa').value = localStorage.getItem('bizWa') || '(33) 12680092';
            document.getElementById('cfgTerms').value = localStorage.getItem('bizTerms') || 'Esta cotizaciÃ³n es vÃ¡lida por 15 dÃ­as naturales. Los precios se respetan dentro de este plazo al confirmar el pedido.';
        }
        function closeSettingsSheet() {
            document.getElementById('settingsOverlay').classList.remove('open');
            openFormalSheet(); // Vuelve al PDF
        }
        function saveSettings() {
            localStorage.setItem('bizPhone', document.getElementById('cfgPhone').value);
            localStorage.setItem('bizEmail', document.getElementById('cfgEmail').value);
            localStorage.setItem('bizWa', document.getElementById('cfgWa').value);
            localStorage.setItem('bizTerms', document.getElementById('cfgTerms').value);
            showToast('âœ“ Datos de empresa guardados');
            closeSettingsSheet();
        }

        function getCheckedPayments() {
            const map = {
                payEfectivo: 'Efectivo', payTransferencia: 'Transferencia', payBBVA: 'BBVA CoDi',
                payOXXO: 'OXXO Pay', payTarjeta: 'Tarjeta (cargo del 3%)', payMercadoPago: 'MercadoPago'
            };
            return Object.entries(map)
                .filter(([id]) => document.getElementById(id).checked)
                .map(([, label]) => label);
        }

        async function printFormal() {
            // Reemplazar antiguo default si quedÃ³ en cachÃ©
            let currentEmail = localStorage.getItem('bizEmail');
            if (currentEmail === 'info@integralcomputacion.com') {
                currentEmail = 'ventas@integralcomputacion.com';
                localStorage.setItem('bizEmail', currentEmail);
            }

            // Cargar configuraciÃ³n de empresa
            const bizPhone = localStorage.getItem('bizPhone') || '(33) 12680092';
            const bizEmail = currentEmail || 'ventas@integralcomputacion.com';
            const bizWa = localStorage.getItem('bizWa') || '(33) 12680092';
            const bizTerms = localStorage.getItem('bizTerms') || 'Esta cotizaciÃ³n es vÃ¡lida por 15 dÃ­as naturales. Los precios se respetan dentro de este plazo al confirmar el pedido.';

            // Valores inmutables
            const bizWeb = 'www.integralcomputacion.com';
            const bizIg = '@integralcomputacion';
            const bizFb = '/integralcomputacion';

            // Gather form values
            const clientName = document.getElementById('fClientName').value || 'Cliente';
            const clientPhone = document.getElementById('fClientPhone').value || '';
            const clientEmail = document.getElementById('fClientEmail').value || '';

            const vendorSelect = document.getElementById('fVendor');
            const userId = vendorSelect.value;
            const vendorName = vendorSelect.options[vendorSelect.selectedIndex].text.split(' (')[0];

            const quoteNum = document.getElementById('fQuoteNum').value || `IC${userId}-${new Date().toISOString().split('T')[0].split('-').reverse().join('').slice(0, 4)}${new Date().getFullYear().toString().slice(-2)}-01`;
            const validity = document.getElementById('fValidity').value || '15';
            const notes = document.getElementById('fNotes').value || '';
            const ivaRate = parseFloat(document.getElementById('fIvaRate').value) || 16;
            const discount = parseFloat(document.getElementById('fDiscount').value) || 0;
            const payments = getCheckedPayments();

            // Usar la fecha seleccionada en el input
            const selectedDate = new Date(document.getElementById('fQuoteDate').value + 'T00:00:00');
            const dateStr = selectedDate.toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' });

            const expiry = new Date(selectedDate.getTime() + parseInt(validity) * 86400000)
                .toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' });

            // Calculate totals
            let subtotal = quoteItems.reduce((s, i) => s + (parseFloat(i.price) || 0) * (i.qty || 1), 0);
            const disc = subtotal * discount / 100;
            const base = subtotal - disc;
            const iva = base * ivaRate / 100;
            const total = base + iva;

            // Guardar en DB antes de imprimir
            try {
                await apiFetch('/api/quotes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        quoteId: quoteNum, clientName, clientEmail, clientPhone, userId, total, items: quoteItems
                    })
                });
                loadClients(); // Recargar historial de clientes
            } catch (e) { console.error('Error saving quote', e); }

            const payRow = payments.length ? payments.map(p => `â€¢ ${p}`).join('<br>') : 'Consultar con el vendedor';

            // Explicit Pagination Logic
            const chunkedPages = [];
            const itemsCopy = [...quoteItems];
            const itemsLimitWithTotals = 5;
            const itemsLimitWithoutTotals = 6;

            while (itemsCopy.length > 0) {
                let takeCount = itemsLimitWithoutTotals;
                if (itemsCopy.length <= itemsLimitWithTotals) {
                    takeCount = itemsCopy.length;
                } else if (itemsCopy.length === itemsLimitWithoutTotals) {
                    takeCount = itemsLimitWithoutTotals - 1;
                }
                chunkedPages.push(itemsCopy.splice(0, takeCount));
            }
            if (chunkedPages.length === 0) chunkedPages.push([]);

            let pagesHtml = '';
            const totalPages = chunkedPages.length;
            let currentGlobalItemIndex = 0;

            chunkedPages.forEach((chunk, pageIndex) => {
                const isFirstPage = pageIndex === 0;
                const isLastPage = pageIndex === totalPages - 1;

                const chunkRows = chunk.map((item) => {
                    currentGlobalItemIndex++;
                    return `
        <tr>
            <td>${currentGlobalItemIndex}</td>
            <td>
                ${item.name || item.id}
                <span class="pv-td-code">${item.id}</span>
            </td>
            <td style="text-align:right">${item.qty || 1}</td>
            <td style="text-align:right">${parseFloat(item.price) > 0 ? fmt(item.price) : 'â€”'}</td>
            <td style="text-align:right">${parseFloat(item.price) > 0 ? fmt((item.qty || 1) * parseFloat(item.price)) : 'â€”'}</td>
        </tr>`;
                }).join('');

                const pagePagination = `PÃ¡gina ${pageIndex + 1} de ${totalPages}`;

                pagesHtml += `
        <div class="pv-page">
            ${isFirstPage ? `
            <div class="pv-header">
                <img class="pv-logo" src="/assets/images/LOGO SIN TEXTO.png" onerror="this.src='/assets/logo.svg'">
                <div class="pv-biz">
                    <strong>Integral ComputaciÃ³n</strong><br>
                    Suministros y Equipos de CÃ³mputo<br>
                    Tel: ${bizPhone}<br>
                    ${bizEmail}<br>
                    ${bizWeb}
                </div>
            </div>

            <div class="pv-meta">
                <div class="pv-meta-box">
                    <h4>CotizaciÃ³n para</h4>
                    <p>
                        <strong>${clientName}</strong><br>
                        ${clientPhone ? `Tel: ${clientPhone}<br>` : ''}
                        ${clientEmail ? `${clientEmail}<br>` : ''}
                    </p>
                </div>
                <div class="pv-meta-box">
                    <h4>Condiciones Comerciales</h4>
                    <p>
                        <strong>Folio: ${quoteNum}</strong><br>
                        Fecha: <span style="white-space: nowrap;">${dateStr}</span><br>
                        Vigente hasta: <span style="white-space: nowrap;">${expiry}</span><br>
                        Agente de Ventas: ${vendorName}
                    </p>
                </div>
            </div>

            ${notes ? `<div style="font-size:8.5pt; color:#2c2c2e; padding:6pt 0; font-weight:600;">ğŸ“Œ Nota al cliente: ${notes}</div>` : ''}
            ` : `<div style="height: 15mm;"></div>`}

            <div class="pv-table-container" ${(!isLastPage || (isFirstPage && isLastPage)) ? 'style="flex-grow: 1; display: flex; flex-direction: column; justify-content: center;"' : ''}>
                <table class="pv-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>DescripciÃ³n</th>
                            <th style="text-align:right">Cant.</th>
                            <th style="text-align:right">P. Unit.</th>
                            <th style="text-align:right">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>${chunkRows}</tbody>
                </table>
            </div>

            ${isLastPage ? `
            <div class="pv-totals">
                <div class="pv-totals-box">
                    <div class="pv-totals-row"><span>Subtotal</span><span>${fmt(subtotal)}</span></div>
                    ${discount > 0 ? `<div class="pv-totals-row"><span>Descuento (${discount}%)</span><span>-${fmt(disc)}</span></div>` : ''}
                    <div class="pv-totals-row"><span>IVA (${ivaRate}%)</span><span>${fmt(iva)}</span></div>
                    <div class="pv-totals-row total"><span>TOTAL</span><span>${fmt(total)}</span></div>
                </div>
            </div>

            <div class="pv-flex-spacer" style="flex-grow:1;"></div>

            <div style="page-break-inside: avoid; margin-top: auto; padding-top: 15pt;">
                <div class="pv-legal-notes" style="border-top: none; padding-top: 0; margin-bottom: 12pt; text-align: justify;">
                    <strong>CONDICIONES:</strong> Vigencia: ${validity} dÃ­as naturales. ${bizTerms}
                </div>

                <div class="pv-footer" style="border-top: 1pt solid #e5e5ea; padding-top: 12pt;">
                    <div class="pv-footer-col">
                        <h5>Formas de Pago</h5>
                        <p>${payRow}</p>
                    </div>
                    <div class="pv-footer-col">
                        <h5>AtenciÃ³n al Cliente</h5>
                        <p>
                            ğŸ“± Directo / WhatsApp: ${bizWa}<br>
                            ${bizEmail}
                        </p>
                    </div>
                </div>
            </div>
            ` : ``}

            <div class="pv-global-footer">
                <div style="text-align:left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">CotizaciÃ³n No. <strong>${quoteNum}</strong></div>
                <div style="text-align:center; white-space: nowrap; padding: 0 10pt;"><strong>${pagePagination}</strong></div>
                <div style="text-align:right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"><strong>${bizEmail}</strong> &nbsp;|&nbsp; ${bizWeb}</div>
            </div>
        </div>
        `;
            });

            // Inject print view
            document.getElementById('printView').innerHTML = pagesHtml;

            closeFormalSheet();

            // Cambiar tÃ­tulo de la pÃ¡gina temporalmente para prenombrar el PDF ("Cotizacion_ICXX_..._Cliente")
            const originalTitle = document.title;
            const pdfName = `Cotizacion_${quoteNum}_${clientName.replace(/[^a-zA-Z0-9]/g, '_')}`;
            document.title = pdfName;

            setTimeout(() => {
                window.print();
                // Restaurar el tÃ­tulo despuÃ©s de imprimir
                document.title = originalTitle;
            }, 200);
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // WHATSAPP / COPY
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function buildTextQuote() {
            const date = new Date().toLocaleDateString('es-MX');
            let lines = ['ğŸ§¾ *CotizaciÃ³n â€” Integral ComputaciÃ³n*', `ğŸ“… ${date}`, ''];
            quoteItems.forEach(item => {
                const qty = item.qty || 1, p = parseFloat(item.price) || 0, sub = qty * p;
                lines.push(`â–¸ *${item.id}*`);
                if (item.name) lines.push(`  ${item.name}`);
                lines.push(`  Cant: ${qty}   Precio: ${p > 0 ? fmt(p) + ' c/u' : 'Por cotizar'}`);
                if (p > 0 && qty > 1) lines.push(`  Subtotal: ${fmt(sub)}`);
                lines.push('');
            });
            const total = quoteItems.reduce((s, i) => s + (parseFloat(i.price) || 0) * (i.qty || 1), 0);
            if (total > 0) lines.push(`ğŸ’° *Total estimado: ${fmt(total)}*`);
            lines.push('', '_Precios sujetos a disponibilidad._');
            return lines.join('\n');
        }
        function shareWhatsApp() { window.open(`https://wa.me/?text=${encodeURIComponent(buildTextQuote())}`, '_blank'); }
        async function copyQuote() {
            try { await navigator.clipboard.writeText(buildTextQuote()); showToast('âœ“ Copiado'); }
            catch (_) { showToast('âœ“ Copiado'); }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // UTILS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }
        function resetAll() {
            document.getElementById('pasteInput').value = '';
            quoteItems = []; notFound = []; goToStep(1);
        }
        function goBack() { window.location.href = '/public/admin/home.html'; }

        // â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // MigraciÃ³n automÃ¡tica: corregir email antiguo en localStorage
        (function migrateDefaults() {
            const savedEmail = localStorage.getItem('bizEmail');
            if (!savedEmail || savedEmail === 'info@integralcomputacion.com') {
                localStorage.setItem('bizEmail', 'ventas@integralcomputacion.com');
            }
        })();

        (async () => { if (await checkAuth()) loadInitialData(); })();
    </script>
</body>

</html>